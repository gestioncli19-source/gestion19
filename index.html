<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#013220;font-weight:700}
    nav{margin-left:auto}
    .menu{display:flex;gap:8px}
    .menu button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .menu button.active{background:var(--accent);color:#052018;border:none}
    main{display:grid;grid-template-columns:1fr;gap:18px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .stat{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .stat h3{margin:0;font-size:12px;color:var(--muted)}
    .stat p{margin:8px 0 0;font-size:20px;font-weight:600}
    .grid-clients{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .card h4{margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .btns{display:flex;gap:6px;margin-top:10px}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn.edit{background:#1f2937;color:#e6eef6}
    .btn.renew{background:#064e3b;color:var(--accent)}
    .btn.copy{background:#0b1220;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .btn.delete{background:#3b0b0b;color:#ffcfcf}
    .card-form{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    form{display:grid;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input[type=text],input[type=date],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.6));z-index:50}
    .modal.show{display:flex}
    .modal-inner{width:96%;max-width:720px;background:var(--card);padding:16px;border-radius:12px}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:700px){.row{grid-template-columns:1fr}.menu{display:flex;gap:6px}}
  </style>
</head>

<body>
<div class="container">

<header>
  <div class="brand">
    <div class="logo">GC</div>
    <div><div style="font-weight:700">Gestor Clientes</div></div>
  </div>
  <nav>
    <div class="menu">
      <button id="nav-dashboard" class="active">Dashboard</button>
      <button id="nav-clientes">Clientes</button>
      <button id="nav-add">Añadir cliente</button>
    </div>
  </nav>
</header>

<main>

<!-- DASHBOARD -->
<section id="section-dashboard">
  <div class="flex justify-between items-center">
    <h2 class="text-3xl font-bold mb-4">⏳ Próximas caducidades (3 días)</h2>
    <div class="flex items-center gap-3">
      <div class="text-sm text-slate-400">Notificaciones:</div>
      <button id="notify-check" class="px-3 py-1 bg-slate-800 rounded">Comprobar</button>
    </div>
  </div>
    <!-- BLOQUES DE ESTADÍSTICAS -->
  <div class="grid grid-cols-1 gap-4 mb-8 mt-4">
    <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
      <h3 class="text-sm text-slate-400">Total clientes</h3>
      <p id="stat-total" class="text-2xl font-bold mt-1">—</p>
    </div>

    <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
      <h3 class="text-sm text-slate-400">Caducan en 3 días</h3>
      <p id="stat-today" class="text-2xl font-bold mt-1">—</p>
    </div>

    <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
      <h3 class="text-sm text-slate-400">Clientes caducados</h3>
      <p id="stat-next" class="text-2xl font-bold mt-1">—</p>
    </div>
  </div>

</section>

<!-- CLIENTES -->
<section id="section-clientes" style="display:none">
  <div class="card-form">
    <h3>Clientes</h3>
    <p class="meta">Lista en tarjetas...</p>
    <div id="clients-grid" class="grid-clients" style="margin-top:10px"></div>
  </div>
</section>

<!-- AÑADIR CLIENTE -->
<section id="section-add" style="display:none">
  <div class="card-form">
    <h3>Añadir cliente</h3>
    <form id="form-add">

      <label>Nombre</label>
      <input type="text" id="f-nombre" required />

      <div class="row">
        <div>
          <label>Fecha de creación</label>
          <input type="date" id="f-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="f-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="f-usuario" />

      <label>Contraseña</label>
      <input type="text" id="f-contrasena" />

      <label>Aplicación</label>
      <!-- CAMBIO A SELECT -->
      <select id="f-aplicacion">
        <option value="Spinning TV">Spinning TV</option>
        <option value="Spinning IBO">Spinning IBO</option>
        <option value="Spinning Mate">Spinning Mate</option>
        <option value="Hot Player">Hot Player</option>
      </select>

      <label>Recomendaciones</label>
      <textarea id="f-recomendaciones"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button type="submit" class="btn edit">Guardar</button>
        <button type="button" id="f-reset" class="btn copy">Reset</button>
      </div>

    </form>
  </div>
</section>
</main>

<footer>
  Nota: este código asume Firestore (Cloud Firestore). Reemplaza la configuración de Firebase en el script con tus claves.
</footer>

</div>

<!-- MODAL EDITAR -->
<div id="modal" class="modal">
  <div class="modal-inner">
    <h3 id="modal-title">Editar cliente</h3>
    <form id="form-edit">

      <label>Nombre</label>
      <input type="text" id="e-nombre" required />

      <div class="row">
        <div>
          <label>Fecha de creación</label>
          <input type="date" id="e-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="e-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="e-usuario" />

      <label>Contraseña</label>
      <input type="text" id="e-contrasena" />

      <label>Aplicación</label>
      <!-- Aquí NO hiciste cambios y queda tal cual -->
      <input type="text" id="e-aplicacion" />

      <label>Recomendaciones</label>
      <textarea id="e-recomendaciones"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <button type="button" id="modal-cancel" class="btn copy">Cancelar</button>
        <button type="submit" class="btn edit">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- FIREBASE + APP LOGIC -->
<script type="module">

// --- CONFIG FIREBASE ---
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import {
  getFirestore, collection, addDoc, doc, getDocs, onSnapshot,
  updateDoc, deleteDoc, query, orderBy
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCA2fZvN8WVKWwEDL0z694C2o5190OMhq8",
  authDomain: "gestioncandy-b9356.firebaseapp.com",
  projectId: "gestioncandy-b9356",
  storageBucket: "gestioncandy-b9356.firebasestorage.app",
  messagingSenderId: "869982852654",
  appId: "1:869982852654:web:ac450321a746e62365f1bf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTOS UI
const navDashboard = document.getElementById('nav-dashboard');
const navClientes = document.getElementById('nav-clientes');
const navAdd = document.getElementById('nav-add');

const secDashboard = document.getElementById('section-dashboard');
const secClientes = document.getElementById('section-clientes');
const secAdd = document.getElementById('section-add');

const clientsGrid = document.getElementById('clients-grid');
const statTotal = document.getElementById('stat-total');
const statToday = document.getElementById('stat-today');
const statNext = document.getElementById('stat-next');

// FORM ADD
const formAdd = document.getElementById('form-add');
const fReset = document.getElementById('f-reset');

// MODAL
const modal = document.getElementById('modal');
const modalCancelBtn = document.getElementById('modal-cancel');
const formEdit = document.getElementById('form-edit');

// NAV MOBILE
function setActive(btn){
  document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

navDashboard.addEventListener('click', ()=>{
  setActive(navDashboard);
  secDashboard.style.display='block';
  secClientes.style.display='none';
  secAdd.style.display='none';
});

navClientes.addEventListener('click', ()=>{
  setActive(navClientes);
  secDashboard.style.display='none';
  secClientes.style.display='block';
  secAdd.style.display='none';
});

navAdd.addEventListener('click', ()=>{
  setActive(navAdd);
  secDashboard.style.display='none';
  secClientes.style.display='none';
  secAdd.style.display='block';
});

// FUNCIONES AUXILIARES
function formatDate(d){
  if(!d) return '-';
  const dt = new Date(d);
  if(isNaN(dt)) return d;
  return dt.toLocaleDateString();
}

function isoForInput(d){
  if(!d) return '';
  const t = new Date(d);
  if(isNaN(t)) return '';
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth()+1).padStart(2,'0');
  const dd = String(t.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
// CARGA DE CLIENTES EN TIEMPO REAL
const col = collection(db, "clientes");
const q = query(col, orderBy("creacion", "desc"));

let cachedList = [];

// STREAM FIRESTORE
onSnapshot(q, snap => {
  cachedList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderClients(cachedList);
  renderDashboard(cachedList);
  updateStats(cachedList);
});

// ESTADÍSTICAS
function updateStats(list){
  statTotal.textContent = list.length;

  const today = new Date();
  today.setHours(0,0,0,0);

  const todayCount = list.filter(i => {
    if(!i.caducidad) return false;
    const d = new Date(i.caducidad);
    d.setHours(0,0,0,0);
    return d.getTime() === today.getTime();
  }).length;
  statToday.textContent = todayCount;

  const sorted = [...list].filter(i=>i.caducidad).sort((a,b)=> new Date(a.caducidad) - new Date(b.caducidad));
  statNext.textContent = sorted.length ? formatDate(sorted[0].caducidad) : "-";
}

// DASHBOARD — SOLO CLIENTES QUE CADUCAN EN 3 DÍAS
function renderDashboard(list){

  // === ACTUALIZAR ESTADÍSTICAS ===

  // Total clientes
  document.getElementById("stat-total").textContent = list.length;

  // Caducan en 3 días
  const nowStats = new Date();
  nowStats.setHours(0,0,0,0);

  const limitStats = new Date();
  limitStats.setDate(limitStats.getDate() + 3);
  limitStats.setHours(23,59,59,999);

  const soonStats = list.filter(i => {
    if (!i.caducidad) return false;
    const d = new Date(i.caducidad);
    return d >= nowStats && d <= limitStats;
  });

  document.getElementById("stat-today").textContent = soonStats.length;

  // Clientes caducados
  const expiredStats = list.filter(i => {
    if (!i.caducidad) return false;
    const d = new Date(i.caducidad);
    return d < nowStats;
  });

  document.getElementById("stat-next").textContent = expiredStats.length;



  // === RENDER DEL DASHBOARD (TARJETAS) ===

  const now = new Date();
  now.setHours(0,0,0,0);

  const limit = new Date();
  limit.setDate(limit.getDate()+3);
  limit.setHours(23,59,59,999);

  const soon = list.filter(i=>{
    if(!i.caducidad) return false;
    const d = new Date(i.caducidad);
    return d >= now && d <= limit;
  });

  dashboardList.innerHTML = '';

  // si no hay nada
  if(soon.length === 0){
    dashboardList.innerHTML =
      '<div class="text-slate-400">No hay caducidades próximas.</div>';
    return;
  }

  // pintar tarjetas del dashboard
  soon.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'bg-slate-900 p-4 rounded-xl border border-slate-800';
    el.innerHTML = `
      <div class="flex justify-between items-start">
        <div>
          <h3 class="font-bold">${escapeHtml(it.nombre)}</h3>
          <div class="text-sm text-slate-400">Caduca: ${fmt(it.caducidad)}</div>
        </div>
        <div class="flex flex-col gap-2">
          <button data-id="${it.id}" class="px-3 py-1 bg-emerald-600 text-black rounded renew-btn">Renovar</button>
          <button data-id="${it.id}" class="px-3 py-1 bg-slate-700 rounded copy-btn">Copiar</button>
        </div>
      </div>
    `;

    el.querySelector('.renew-btn')?.addEventListener('click', ()=>renewItem(it));
    el.querySelector('.copy-btn')?.addEventListener('click', ()=>copyPasswordById(it.id));

    dashboardList.appendChild(el);
  });

  // notificaciones locales
  if(soon.length > 0) scheduleNotifications(soon);
}

// RENDER DE CLIENTES EN TARJETAS
function renderClients(list){
  clientsGrid.innerHTML = "";

  list.forEach(item => {
    const card = document.createElement('div');
    card.className = "card";
    card.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="meta">App: ${item.aplicacion || "-"}</div>
      <div class="meta">Creación: ${formatDate(item.creacion)}</div>
      <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>

      <div class="btns">
        <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
        <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
        <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
        <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
      </div>
    `;
    clientsGrid.appendChild(card);
  });
}

// COPIAR CONTRASEÑA
window.copyPassword = function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item || !item.contrasena) return alert("No hay contraseña");
  navigator.clipboard.writeText(item.contrasena);
  alert("Contraseña copiada");
}

// RENOVAR — SUMA 1 AÑO A CADUCIDAD
window.renewItem = async function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  let date = new Date(item.caducidad || new Date());
  date.setFullYear(date.getFullYear() + 1);

  await updateDoc(doc(db, "clientes", id), {
    caducidad: date.toISOString()
  });

  alert("Renovado correctamente");
}

// ELIMINAR
window.deleteItem = async function(id){
  if(!confirm("¿Eliminar cliente?")) return;
  await deleteDoc(doc(db, "clientes", id));
}

// ABRIR MODAL DE EDICIÓN
window.openEdit = function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  document.getElementById('e-nombre').value = item.nombre;
  document.getElementById('e-creacion').value = isoForInput(item.creacion);
  document.getElementById('e-caducidad').value = isoForInput(item.caducidad);
  document.getElementById('e-usuario').value = item.usuario || "";
  document.getElementById('e-contrasena').value = item.contrasena || "";
  document.getElementById('e-aplicacion').value = item.aplicacion || "";
  document.getElementById('e-recomendaciones').value = item.recomendaciones || "";

  modal.setAttribute('data-id', id);
  modal.classList.add('show');
};

// CERRAR MODAL
modalCancelBtn.addEventListener('click', ()=>{
  modal.classList.remove('show');
});

// GUARDAR CAMBIOS EN MODAL
formEdit.addEventListener('submit', async e=>{
  e.preventDefault();
  const id = modal.getAttribute('data-id');
  if(!id) return;

  const data = {
    nombre: document.getElementById('e-nombre').value,
    creacion: document.getElementById('e-creacion').value,
    caducidad: document.getElementById('e-caducidad').value,
    usuario: document.getElementById('e-usuario').value,
    contrasena: document.getElementById('e-contrasena').value,
    aplicacion: document.getElementById('e-aplicacion').value,
    recomendaciones: document.getElementById('e-recomendaciones').value
  };

  await updateDoc(doc(db, "clientes", id), data);

  modal.classList.remove('show');
  alert("Cambios guardados");
});

// AÑADIR CLIENTE NUEVO
formAdd.addEventListener('submit', async e=>{
  e.preventDefault();

  const data = {
    nombre: document.getElementById('f-nombre').value,
    creacion: document.getElementById('f-creacion').value,
    caducidad: document.getElementById('f-caducidad').value,
    usuario: document.getElementById('f-usuario').value,
    contrasena: document.getElementById('f-contrasena').value,
    aplicacion: document.getElementById('f-aplicacion').value,
    recomendaciones: document.getElementById('f-recomendaciones').value
  };

  await addDoc(col, data);
  alert("Cliente añadido");

  formAdd.reset();
});

// RESET FORM
fReset.addEventListener('click', ()=> formAdd.reset());

</script>
</body>
</html>


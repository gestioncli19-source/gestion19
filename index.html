<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gesti√≥n Candy üçÉ</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
:root{
  --bg:#0f1216; --panel:#111318; --muted:#9aa4ad;
  --accent:#00b4ff; --accent2:#0077aa; --success:#23c552; --danger:#ff6b6b;
  --touch:48px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Montserrat,system-ui,Arial;background:var(--bg);color:#e9f0f7;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}

/* APP LAYOUT */
.app { display:flex; min-height:100vh; overflow-x:hidden; }

/* SIDEBAR */
.sidebar {
  width:260px; background:linear-gradient(180deg,var(--panel),#0b0d11);
  padding:20px 18px; box-shadow:4px 0 30px rgba(0,0,0,0.6);
  position:fixed; left:0; top:0; bottom:0; transform:translateX(-320px);
  transition:transform .38s cubic-bezier(.2,.9,.2,1); z-index:240;
}
.sidebar.open { transform:translateX(0); }
.brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800}
.nav{display:flex;flex-direction:column;gap:6px}
.nav a{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;text-decoration:none;color:#cfe6ff;font-weight:700}
.nav a.active,.nav a:hover{background:rgba(255,255,255,0.03);color:#fff}

/* MENU BUTTON (DERECHA) */
.menu-btn {
  position:fixed; right:14px; top:14px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none; color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; z-index:260;
  box-shadow:0 10px 30px rgba(0,0,0,0.35);
}

/* MAIN */
main { flex:1; margin-left:20px; padding:20px 20px 80px 20px; transition:margin .3s; }
header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 6px; }
.header-left { display:flex; align-items:center; gap:12px; }
.header-title { font-weight:800; font-size:20px; display:flex; align-items:center; gap:8px; }
.icon-btn { background:transparent; border:1px solid rgba(255,255,255,0.04); padding:10px; border-radius:10px; color:inherit; cursor:pointer }

/* DASHBOARD */
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:14px; margin-top:14px; }
.box { background:linear-gradient(145deg,#121417,#181a1f); padding:20px; border-radius:16px; box-shadow:0 12px 32px rgba(0,0,0,0.65); text-align:center; transition:transform .18s; }
.box:hover{ transform:translateY(-6px); }
.num { font-size:28px; font-weight:800; color:var(--accent); }
.label { font-size:14px; color:var(--muted); margin-top:6px; }

/* CARDS */
.card-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px; margin-top:18px; }
.card { background:linear-gradient(180deg,#0f1418,#15181c); border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.6); transition:transform .18s; }
.card:hover{ transform:translateY(-6px); }

/* info rows */
.info-row { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
.info-row .row { display:flex; justify-content:space-between; gap:8px; align-items:center; font-size:14px; }

/* actions */
.actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.btn { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; font-size:13px; display:inline-flex; gap:8px; align-items:center; }
.btn.touch { min-height:var(--touch); } /* touch targets */
.edit { background:linear-gradient(90deg,#3b82f6,#2563eb); color:#fff; }
.renew { background:linear-gradient(90deg,#ffb86b,#ff8a00); color:#fff; }
.copy { background:linear-gradient(90deg,#9b6bff,#7c3aed); color:#fff; }
.del { background:linear-gradient(90deg,#ff7b7b,#ff3b3b); color:#fff; }

/* FORM PANEL */
.panel { background:linear-gradient(180deg,#0f1316,#13161a); padding:14px; border-radius:12px; margin-top:14px; }
.row { display:flex; gap:10px; flex-wrap:wrap; }
.field { flex:1; display:flex; flex-direction:column; min-width:140px; }
label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
input, textarea, select { padding:10px; border-radius:10px; border:none; background:#161819; color:#fff; outline:none; }
textarea{ min-height:80px; resize:vertical; }
.form-footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

/* pagination */
.pagination { display:flex; gap:8px; justify-content:center; margin-top:16px; }
.page-btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.05); background:transparent; color:inherit; cursor:pointer; }
.page-btn.active { background:var(--accent); color:#fff; }

/* login modal */
#loginScreen { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,rgba(0,0,0,0.5),rgba(0,0,0,0.6)); z-index:500; }
.login-card { background:#0f1418; padding:20px; border-radius:12px; min-width:320px; box-shadow:0 20px 60px rgba(0,0,0,0.7); }
.login-card h2{ margin:0 0 8px 0; }
.login-card input{ width:100%; padding:12px; border-radius:10px; border:none; margin-top:10px; background:#15181b; color:#fff; }

/* toast */
#toast { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; padding:10px 14px; border-radius:10px; background:#222; color:#fff; display:none; z-index:600; }

/* MOBILE ADJUST */
@media (max-width:900px){
  .sidebar{width:220px}
  .menu-btn{right:10px}
  main{padding:14px}
  .btn{padding:10px; font-size:13px}
}

/* VERY SMALL */
@media (max-width:420px){
  .card { padding:12px; }
  .actions{gap:6px}
  .btn { font-size:12px; padding:9px 10px; }
}
</style>
</head>
<body>

<!-- Menu button -->
<button class="menu-btn" id="menuBtn" title="Men√∫"><i class="fa-solid fa-bars"></i></button>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar" aria-hidden="true">
  <div class="brand">
    <div class="logo">GC</div>
    <div>
      <div style="font-weight:800; font-size:16px">Gesti√≥n Candy üçÉ</div>
    </div>
  </div>

  <nav class="nav" role="navigation">
    <a href="#" data-view="dashboard" class="active"><i class="fa-solid fa-chart-simple"></i> Dashboard</a>
    <a href="#" data-view="clientes"><i class="fa-solid fa-users"></i> Clientes</a>
    <a href="#" data-view="nuevo"><i class="fa-solid fa-plus"></i> A√±adir cliente</a>
    <a href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n</a>
  </nav>
</aside>

<!-- Main -->
<main>
  <header>
    <div class="header-left">
      <div class="header-title">Gesti√≥n Candy üçÉ</div>
    </div>
    <div class="header-right">
      <button id="refreshBtn" class="icon-btn" title="Refrescar"><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
  </header>

  <!-- DASHBOARD VIEW -->
  <section id="view-dashboard" class="view">
    <div class="grid">
      <div class="box"><div class="num" id="totalCount">0</div><div class="label">Total clientes</div></div>
      <div class="box"><div class="num" id="vigentesCount">0</div><div class="label">Vigentes</div></div>
      <div class="box"><div class="num" id="alertCount">0</div><div class="label">En alerta (7 d√≠as)</div></div>
      <div class="box"><div class="num" id="expCount">0</div><div class="label">Caducados</div></div>
    </div>
  </section>

  <!-- CLIENTS VIEW -->
  <section id="view-clientes" class="view" style="display:none">
    <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
      <input id="search" placeholder="Buscar por nombre o usuario" style="flex:1;padding:12px;border-radius:10px;border:none;background:#15181b;color:#fff" aria-label="Buscar clientes" />
      <button id="filterBtn" class="btn" style="background:#222;color:#fff">Filtro</button>
      <button id="exportBtn" class="btn" style="background:#222;color:#fff">Exportar CSV</button>
    </div>

    <div id="clientsList" class="card-list" aria-live="polite"></div>
    <div id="pagination" class="pagination" role="navigation" aria-label="Paginaci√≥n"></div>
  </section>

  <!-- NEW / EDIT VIEW -->
  <section id="view-nuevo" class="view" style="display:none">
    <div class="panel" role="form" aria-labelledby="form-title">
      <div id="form-title" style="font-weight:800;margin-bottom:8px">A√±adir / Editar cliente</div>

      <div class="row">
        <div class="field">
          <label>Nombre</label>
          <input id="n_nombre" placeholder="Nombre completo" />
        </div>
        <div class="field">
          <label>Aplicaci√≥n</label>
          <select id="n_aplicacion">
            <option value="">-- Selecciona aplicaci√≥n --</option>
            <option>Spinning TV</option>
            <option>Spinning IBO</option>
            <option>Spinning MATE</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>Precio</label>
          <input id="n_precio" placeholder="12,50" inputmode="decimal" />
        </div>
        <div class="field">
          <label>Caducidad (fecha)</label>
          <input id="n_caducidad" type="date" />
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <div class="field">
          <label>Usuario</label>
          <input id="n_usuario" placeholder="usuario" />
        </div>
        <div class="field">
          <label>Contrase√±a</label>
          <input id="n_contrasena" placeholder="contrase√±a" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Recomendaciones</label>
        <textarea id="n_recomendaciones" placeholder="Notas..."></textarea>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center">
        <div style="flex:1">
          <label>Fecha de creaci√≥n</label>
          <input id="n_fechaCreacion" type="date" />
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Se autogenera si dejas vac√≠o.</div>
        </div>
        <div style="width:160px; align-self:flex-end">
          <button id="saveBtn" class="btn edit touch" style="width:100%">Guardar</button>
        </div>
      </div>

      <div class="form-footer">
        <button class="btn" id="clearBtn">Limpiar</button>
      </div>
    </div>
  </section>

</main>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <h2 id="login-title">Inicia sesi√≥n</h2>
    <input id="email" placeholder="Correo electr√≥nico" type="email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin" class="btn edit" style="width:100%; margin-top:12px">Entrar</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast" role="status" aria-live="polite"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCA2fZvN8WVKWwEDL0z694C2o5190OMhq8",
    authDomain: "gestioncandy-b9356.firebaseapp.com",
    projectId: "gestioncandy-b9356",
    storageBucket: "gestioncandy-b9356.firebasestorage.app",
    messagingSenderId: "869982852654",
    appId: "1:869982852654:web:ac450321a746e62365f1bf"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menuBtn');
  const links = document.querySelectorAll('.nav a');
  const views = document.querySelectorAll('.view');
  const loginScreen = document.getElementById('loginScreen');
  const btnLogin = document.getElementById('btnLogin');
  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const toast = document.getElementById('toast');

  let clients = [], currentPage = 1, perPage = 6, editingId = null, sortAsc = true;

  function showToast(msg,t=2200){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',t); }

  menuBtn.addEventListener('click', ()=> sidebar.classList.toggle('open'));
  links.forEach(a=>a.addEventListener('click',(e)=>{
    e.preventDefault();
    links.forEach(x=>x.classList.remove('active')); a.classList.add('active');
    const view = document.getElementById('view-'+a.dataset.view);
    views.forEach(v=>v.style.display='none'); view.style.display='block';
    if(window.innerWidth<900) sidebar.classList.remove('open');
  }));

  btnLogin.addEventListener('click',async()=>{
    const email = emailInput.value.trim(), pass = passInput
    = passInput.value.trim();
    if(!email || !pass){ showToast("Completa correo y contrase√±a"); return; }
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      loginScreen.style.display='none';
      showToast("Bienvenido");
      loadClients();
    }catch(e){ showToast("Error: "+e.message); }
  });

  document.getElementById('logoutBtn').addEventListener('click',async()=>{
    await signOut(auth);
    loginScreen.style.display='flex';
  });

  onAuthStateChanged(auth,user=>{
    if(user) loginScreen.style.display='none';
    else loginScreen.style.display='flex';
  });

  async function loadClients(){
    const q = query(collection(db,"clientes"),orderBy("caducidad","asc"));
    const snapshot = await getDocs(q);
    clients = [];
    snapshot.forEach(doc=>clients.push({id:doc.id,...doc.data()}));
    renderDashboard();
    renderClients();
  }

  function renderDashboard(){
    document.getElementById('totalCount').textContent = clients.length;
    const hoy = new Date();
    document.getElementById('vigentesCount').textContent = clients.filter(c=>new Date(c.caducidad)>=hoy).length;
    document.getElementById('alertCount').textContent = clients.filter(c=>{
      const d = new Date(c.caducidad);
      const diff=Math.ceil((d-hoy)/(1000*60*60*24));
      return diff>0 && diff<=7;
    }).length;
    document.getElementById('expCount').textContent = clients.filter(c=>new Date(c.caducidad)<hoy).length;
  }

  function renderClients(){
    const list = document.getElementById('clientsList');
    list.innerHTML='';
    let sorted = [...clients];
    sorted.sort((a,b)=>sortAsc?new Date(a.caducidad)-new Date(b.caducidad):new Date(b.caducidad)-new Date(a.caducidad));
    sorted.forEach(c=>{
      const card = document.createElement('div'); card.className='card';
      const cad = new Date(c.caducidad);
      card.innerHTML=`
        <div style="font-weight:700;font-size:16px;margin-bottom:6px">${c.nombre}</div>
        <div class="info-row">
          <div class="row"><span>Usuario:</span><span>${c.usuario}</span></div>
          <div class="row"><span>Contrase√±a:</span><span>${c.contrasena}</span></div>
          <div class="row"><span>Aplicaci√≥n:</span><span>${c.aplicacion}</span></div>
          <div class="row"><span>Caducidad:</span><span>${c.caducidad}</span></div>
        </div>
        <div class="actions">
          <button class="btn edit touch" onclick="editClient('${c.id}')"><i class="fa-solid fa-pen"></i> Editar</button>
          <button class="btn copy touch" onclick="copyClient('${c.id}')"><i class="fa-solid fa-copy"></i> Copiar</button>
          <button class="btn del touch" onclick="deleteClient('${c.id}')"><i class="fa-solid fa-trash"></i> Eliminar</button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  window.editClient = async function(id){
    const c = clients.find(x=>x.id===id);
    if(!c) return;
    editingId = id;
    links.forEach(a=>a.classList.remove('active'));
    document.querySelector('[data-view=nuevo]').classList.add('active');
    views.forEach(v=>v.style.display='none');
    document.getElementById('view-nuevo').style.display='block';

    document.getElementById('n_nombre').value = c.nombre;
    document.getElementById('n_precio').value = c.precio;
    document.getElementById('n_caducidad').value = c.caducidad;
    document.getElementById('n_usuario').value = c.usuario;
    document.getElementById('n_contrasena').value = c.contrasena;
    document.getElementById('n_aplicacion').value = c.aplicacion;
    document.getElementById('n_recomendaciones').value = c.recomendaciones;
    document.getElementById('n_fechaCreacion').value = c.fechaCreacion || '';
  }

  window.copyClient = function(id){
    const c = clients.find(x=>x.id===id);
    const text = `Usuario: ${c.usuario}\nContrase√±a: ${c.contrasena}\nAplicaci√≥n: ${c.aplicacion}\nCaducidad: ${c.caducidad}`;
    navigator.clipboard.writeText(text).then(()=>showToast('Copiado al portapapeles'));
  }

  window.deleteClient = async function(id){
    if(!confirm("¬øEliminar cliente?")) return;
    await deleteDoc(doc(db,"clientes",id));
    showToast("Cliente eliminado");
    loadClients();
  }

  document.getElementById('saveBtn').addEventListener('click',async()=>{
    const nombre = document.getElementById('n_nombre').value.trim();
    const precio = document.getElementById('n_precio').value.trim();
    const cad = document.getElementById('n_caducidad').value;
    const usuario = document.getElementById('n_usuario').value.trim();
    const contrasena = document.getElementById('n_contrasena').value.trim();
    const aplicacion = document.getElementById('n_aplicacion').value;
    const recomendaciones = document.getElementById('n_recomendaciones').value;
    let fechaCreacion = document.getElementById('n_fechaCreacion').value;
    if(!fechaCreacion) fechaCreacion = new Date().toISOString().split('T')[0];
    if(!nombre || !usuario){ showToast("Nombre y usuario son obligatorios"); return; }

    const data = {nombre, precio: precio?precio+" ‚Ç¨":'', caducidad: cad || new Date().toISOString().split('T')[0], usuario, contrasena, aplicacion, recomendaciones, fechaCreacion};

    if(editingId){
      await updateDoc(doc(db,"clientes",editingId), data);
      editingId=null;
      showToast("Cliente actualizado");
    } else {
      await addDoc(collection(db,"clientes"), data);
      showToast("Cliente agregado");
    }
    clearForm();
    loadClients();
  });

  document.getElementById('clearBtn').addEventListener('click',clearForm);
  function clearForm(){
    ['n_nombre','n_precio','n_caducidad','n_usuario','n_contrasena','n_aplicacion','n_recomendaciones','n_fechaCreacion'].forEach(id=>document.getElementById(id).value='');
    editingId=null;
  }

  document.getElementById('filterBtn').addEventListener('click',()=>{
    sortAsc = !sortAsc;
    renderClients();
  });

  emailInput.value=""; passInput.value="";
</script>

</body>
</html>

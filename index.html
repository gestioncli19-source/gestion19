<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--red:#ef4444;--green:#10b981;--yellow:#f59e0b;--whatsapp:#25d366;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass);margin-bottom:20px}
    header h1{font-size:1.8rem;font-weight:700;color:var(--accent);margin:0}
    
    /* Nav/Menu Styles */
    .nav{display:flex;gap:10px; flex-wrap: wrap;}
    .btn{padding:10px 15px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s, box-shadow .2s;white-space:nowrap;font-size:14px}
    .btn.nav-link{background-color:transparent;color:var(--muted);position:relative;border:1px solid rgba(255,255,255,0.06);}
    .btn.nav-link:hover{color:#fff;background-color:var(--glass)}
    .btn.nav-link.active{color:var(--accent);font-weight:700; background-color: rgba(110, 231, 183, 0.1);}

    /* Dashboard Stats Styling */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:30px}
    .stat{background-color:var(--card);padding:15px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.2);border:1px solid var(--glass);transition:transform .2s; border-left: 4px solid var(--accent);}
    .stat:hover{transform:translateY(-2px)}
    .stat h3{margin:0 0 5px 0;font-size:1rem;color:var(--muted);text-transform:uppercase}
    .stat p{margin:0;font-size:2rem;font-weight:700;line-height:1}
    .stat.expiring{border-left-color:var(--red)}
    .stat.active{border-left-color:var(--green)}

    /* 1. Dashboard Visualization (Clientes por caducar en fila) */
    .expiring-clients-box {
        background-color: var(--card);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        margin-top: 20px;
        border-left: 5px solid var(--yellow);
    }
    .expiring-clients-box h3 {
        color: var(--yellow);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 20px;
    }
    #expiring-clients-container {
        display: flex; /* Display in a row */
        overflow-x: auto; /* Enable horizontal scrolling */
        gap: 15px;
        padding: 5px 0;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .expiring-client-card {
        min-width: 280px;
        padding: 15px;
        background-color: #2a1e12; /* Unique dark background */
        color: #fff; 
        border: 1px solid var(--yellow);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
    }
    .expiring-client-card h5 {
        margin: 0 0 5px 0;
        font-weight: 700;
        font-size: 16px;
        color: var(--yellow);
    }
    .expiring-client-card .detail {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 3px;
    }
    
    /* 4. Client Card Colors */
    .clients-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:40px}
    .card{padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.3);display:flex;flex-direction:column}
    
    .card-color-1 { background-color: #1a2a40; border-left: 5px solid #6366f1; } /* Indigo */
    .card-color-2 { background-color: #1a3028; border-left: 5px solid #10b981; } /* Teal/Green */
    .card-color-3 { background-color: #2a1e12; border-left: 5px solid #f97316; } /* Orange */
    .card-color-4 { background-color: #241a2c; border-left: 5px solid #e879f9; } /* Violet */
    .card-color-5 { background-color: #172535; border-left: 5px solid #3b82f6; } /* Blue */

    .card h4{margin-top:0;font-size:18px;color:#fff}
    .card .meta{font-size:13px;color:var(--muted);margin-bottom:5px}
    .card .btns{margin-top:15px;display:flex;flex-wrap:wrap;gap:8px}
    .card .btns .btn{padding:8px 12px;font-size:12px;font-weight:500;background-color:var(--glass);color:var(--accent)}
    .card .btns .btn:hover{background-color:rgba(255,255,255,0.08)}
    .card .btns .delete{color:var(--red); background-color: #3b0b0b;}

    /* Modal Styling */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:100}
    
    /* 3. Edit Modal Responsiveness */
    .modal-content{
        background-color: var(--bg);
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 700px; 
        max-height: 90vh; /* CRITICAL: Ensures responsiveness */
        overflow-y: auto; /* CRITICAL: Ensures scrolling on small screens */
        box-shadow:0 10px 25px rgba(0,0,0,0.5);
        position: relative;
    }

    .modal-content .close-btn{color:var(--muted);float:right;font-size:28px;font-weight:700;line-height:1;transition:color .2s}
    .modal-content .close-btn:hover{color:#fff;text-decoration:none;cursor:pointer}
    .modal-form{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px}
    .form-group{display:flex;flex-direction:column}
    .form-group label{margin-bottom:5px;font-size:14px;color:var(--muted)}
    .modal-content input, .modal-content textarea{padding:10px;border-radius:6px;border:1px solid var(--glass);background-color:#1e293b;color:#e6eef6;font-size:14px;width:100%;}
    .modal-content button[type="submit"]{grid-column:1 / -1;background-color:var(--accent);color:var(--bg);font-weight:700;margin-top:15px}
    .modal-content button[type="submit"]:hover{background-color:#50e0a5}
    .modal-content .full-width { grid-column: 1 / -1; }

    /* Tutorial Section Styling */
    .tutorial-content {
        display: grid;
        gap: 25px;
        padding-top: 10px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    .tutorial-step {
        background-color: var(--card);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--accent);
    }
    .tutorial-step h4 {
        color: var(--accent);
        margin-top: 0;
        margin-bottom: 10px;
    }
    .tutorial-step ul {
        list-style: disc;
        padding-left: 20px;
        margin: 10px 0 0 0;
        font-size: 0.9rem;
        color: var(--muted);
    }


    @media (max-width: 768px) {
        .nav{overflow-x:auto;padding-bottom:5px;justify-content:flex-start;}
        .container{padding:10px}
        .stats-grid{grid-template-columns:1fr}
        .modal-content { max-width: 95%; padding: 20px; }
        .modal-form{grid-template-columns:1fr}
        header { flex-direction: column; align-items: flex-start; }
        header .nav { margin-top: 10px; }
    }
  </style>

  <script type="module">
    // Importaciones de Firebase
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, addDoc, doc, getDoc, updateDoc, deleteDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    // =========================================================================
    // 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE (CORREGIDO Y ESTABILIZADO)
    // =========================================================================

    // Nota: Aunque estas variables existen en el entorno Canvas, definimos una configuración de respaldo
    // para entornos externos, usando tu configuración proporcionada previamente.
    const APP_ID_FALLBACK = 'gestioncli19-app-id'; 
    const FIREBASE_CONFIG_FALLBACK = {
        apiKey: "AIzaSyCA2fZvN8WVKWwEDL0z694C2o5190OMhq8",
        authDomain: "gestioncandy-b9356.firebaseapp.com",
        projectId: "gestioncandy-b9356",
        storageBucket: "gestioncandy-b9356.firebasestorage.app",
        messagingSenderId: "869982852654",
        appId: "1:869982852654:web:ac450321a746e62365f1bf"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID_FALLBACK;
    const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}' 
        ? JSON.parse(__firebase_config) 
        : FIREBASE_CONFIG_FALLBACK;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    let db, auth;
    let currentUserId = null;
    let allClients = [];
    let currentFilter = 'all'; 

    async function initializeFirebase() {
        console.log("Iniciando Firebase con ID de App:", appId);

        if (!firebaseConfig.apiKey) {
            console.error("Firebase configuration is missing or invalid. Using fallback credentials.");
            showNotification("Error de Configuración", "Falta la API Key de Firebase.", 'error');
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Autenticación
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // 2. Listener de Estado de Autenticación
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    startListeners();
                    showSection('dashboard-section'); // Muestra la sección inicial
                } else {
                    currentUserId = null;
                    document.getElementById('loading').innerText = 'Esperando autenticación...';
                }
            });

        } catch (error) {
            console.error("Error durante la inicialización de Firebase:", error);
            showNotification("Error Crítico", "No se pudo iniciar la app.", 'error');
        }
    }

    // Función de utilidad para obtener la ruta de la colección
    function getUserCollectionPath() {
        return `artifacts/${appId}/users/${currentUserId}/clientes`;
    }

    // =========================================================================
    // 2. UTILITY & NAVIGATION
    // =========================================================================

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatDateForInput(timestamp) {
      if (!timestamp) return '';
      let date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function showNotification(title, message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `<strong>${title}</strong><br/>${message}`;

      container.appendChild(notification);
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);

      setTimeout(() => {
        notification.classList.remove('show');
        notification.addEventListener('transitionend', () => notification.remove());
      }, 5000);
    }

    window.showSection = function(sectionId) {
        document.querySelectorAll('section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionId).style.display = 'block';

        document.querySelectorAll('.btn.nav-link').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.btn.nav-link[onclick="showSection('${sectionId}')"]`).classList.add('active');

        // Render clients if switching to client section
        if (sectionId === 'clients-section') {
            document.getElementById('search-input').value = '';
            renderClients(allClients, 'all');
        }
    }

    window.closeModal = function(event) {
        if (event && event.target.classList.contains('modal')) {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('edit-modal').style.display = 'none';
        }
        if (!event) { // For direct call
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('edit-modal').style.display = 'none';
        }
    }

    // =========================================================================
    // 3. LISTENERS & DATA RENDERING
    // =========================================================================

    function startListeners() {
        if (!currentUserId) return;
        const clientsColRef = collection(db, getUserCollectionPath());
        const q = query(clientsColRef); 

        onSnapshot(q, (snapshot) => {
            const clientsList = [];
            snapshot.forEach(doc => {
                clientsList.push({ id: doc.id, ...doc.data() });
            });

            clientsList.sort((a, b) => {
                const dateA = new Date(a.caducidad.toDate ? a.caducidad.toDate() : a.caducidad);
                const dateB = new Date(b.caducidad.toDate ? b.caducidad.toDate() : b.caducidad);
                return dateA - dateB;
            });

            allClients = clientsList;
            updateStats(allClients);
            renderDashboard(allClients); // Renderiza dashboard
            renderClients(allClients, currentFilter); // Renderiza clientes (si es la sección visible)
        }, (error) => {
            console.error("Error al escuchar clientes:", error);
            showNotification("Error de Datos", "No se pudo cargar la lista de clientes.", 'error');
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allClients.filter(client =>
                client.nombre.toLowerCase().includes(searchTerm) ||
                (client.usuario && client.usuario.toLowerCase().includes(searchTerm)) ||
                (client.aplicacion && client.aplicacion.toLowerCase().includes(searchTerm))
            );
            renderClients(filtered, currentFilter);
        });
    }

    function updateStats(clients) {
        const today = new Date();
        const threeDaysFromNow = new Date();
        threeDaysFromNow.setDate(today.getDate() + 3);

        const total = clients.length;
        let active = 0;
        let expiring = 0;
        let free = 0;

        clients.forEach(client => {
            const caducidad = client.caducidad.toDate ? client.caducidad.toDate() : new Date(client.caducidad);
            if (caducidad > today) {
                active++;
            }
            if (caducidad >= today && caducidad <= threeDaysFromNow) {
                expiring++;
            }
            if (client.tipo_renovacion === 'gratis') {
                free++;
            }
        });

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-expiring').textContent = expiring;
        document.getElementById('stat-free').textContent = free;
    }

    // 1. Dashboard Visualization
    function renderDashboard(clients) {
        const today = new Date();
        const threeDaysFromNow = new Date();
        threeDaysFromNow.setDate(today.getDate() + 3);
        
        const expiringNow = clients.filter(client => {
            const caducidad = client.caducidad.toDate ? client.caducidad.toDate() : new Date(client.caducidad);
            return caducidad >= today && caducidad <= threeDaysFromNow;
        });

        const container = document.getElementById('expiring-clients-container');
        container.innerHTML = ''; 

        if (expiringNow.length === 0) {
            container.innerHTML = '<p style="margin: 0; padding: 15px; color: var(--muted);">No hay clientes a punto de caducar (próximos 3 días).</p>';
            container.style.display = 'block';
            container.style.overflowX = 'hidden';
            container.style.padding = '0';
        } else {
            container.style.display = 'flex';
            container.style.overflowX = 'auto';
            container.style.padding = '5px 0';

            expiringNow.forEach(client => {
                const card = document.createElement('div');
                card.className = 'expiring-client-card';
                card.innerHTML = `
                    <h5>${client.nombre}</h5>
                    <div class="detail">Usuario: ${client.usuario || '-'}</div>
                    <div class="detail">App: ${client.aplicacion || '-'}</div>
                    <div class="detail">Caduca: ${formatDate(client.caducidad)}</div>
                    <div class="detail">Teléfono: ${client.telefono || '-'}</div>
                    <div class="btns" style="margin-top: 10px;">
                        <button class="btn" style="background-color: var(--yellow); color: var(--bg); font-weight: 700;" onclick="openEdit('${client.id}')">Editar</button>
                        <button class="btn copy" onclick="copyPassword('${client.id}')">Copiar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    }
    
    // 4. Client Card Colors: Array para rotación de colores
    const cardColors = ['card-color-1', 'card-color-2', 'card-color-3', 'card-color-4', 'card-color-5'];

    function renderClients(clients, filter = 'all') {
        const clientsGrid = document.getElementById('clients-grid');
        clientsGrid.innerHTML = '';

        const today = new Date();
        const oneWeekFromNow = new Date();
        oneWeekFromNow.setDate(today.getDate() + 7);

        let filteredClients = clients;

        if (filter === 'expiring') {
            filteredClients = clients.filter(client => {
                const caducidad = client.caducidad.toDate ? client.caducidad.toDate() : new Date(client.caducidad);
                return caducidad >= today && caducidad <= oneWeekFromNow;
            });
        } else if (filter === 'free') {
            filteredClients = clients.filter(client => client.tipo_renovacion === 'gratis');
        }

        if (filteredClients.length === 0) {
            clientsGrid.innerHTML = `<p style="text-align:center; color: var(--muted); width: 100%;">No se encontraron clientes para el filtro actual.</p>`;
            return;
        }

        filteredClients.forEach((item, index) => {
            const caducidadDate = item.caducidad.toDate ? item.caducidad.toDate() : new Date(item.caducidad);
            let statusClass = 'active';
            let statusText = 'Activo';

            if (item.tipo_renovacion === 'gratis') {
                statusClass = 'free';
                statusText = 'Mes Gratis';
            } else if (caducidadDate <= today) {
                statusClass = 'expiring';
                statusText = 'Caducado';
            } else if (caducidadDate <= oneWeekFromNow) {
                statusClass = 'expiring';
                statusText = 'Caduca Pronto';
            }

            const colorClass = cardColors[index % cardColors.length]; // Aplica color rotativo

            let recommendationsHTML = '';
            if (item.recomendados && item.recomendados.length > 0) {
                recommendationsHTML = `<div class="meta" style="color: var(--accent);">Recomendados: ${item.recomendados.join(', ')}</div>`;
            }

            const whatsappMessage = encodeURIComponent(`Hola ${item.nombre}, te escribo por la renovación de tu ${item.aplicacion}. Tu servicio caduca el ${formatDate(item.caducidad)}. Por favor, confirma si deseas renovar.`);
            const whatsappBtn = item.telefono ? `<a class="btn whatsapp" href="https://wa.me/${item.telefono.replace(/\D/g, '')}?text=${whatsappMessage}" target="_blank">WhatsApp</a>` : '';

            const card = document.createElement('div');
            card.className = `card ${statusClass} ${colorClass}`; // Añade la clase de color
            card.innerHTML = `
                <h4>${item.nombre} <span style="font-size: 0.8rem; color: var(--muted);">(${statusText})</span></h4>
                <div class="meta">Teléfono: ${item.telefono || "-"}</div>
                <div class="meta">App: ${item.aplicacion || "-"}</div>
                <div class="meta">Usuario: ${item.usuario || "-"}</div>
                <div class="meta">Creación: ${formatDate(item.creacion)}</div>
                <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
                ${recommendationsHTML}

                <div class="btns">
                    <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
                    <button class="btn renew" onclick="renewItem('${item.id}', 'Renovación Manual')">Renovar</button>
                    <button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>
                    <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
                    ${whatsappBtn}
                    <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
                </div>
            `;
            clientsGrid.appendChild(card);
        });
    }

    // =========================================================================
    // 4. FUNCIONES CRUD Y ACCIONES (CON AJUSTES)
    // =========================================================================

    // 2. Copy Functionality
    window.copyPassword = async function(id) {
        const clientData = allClients.find(c => c.id === id);
        if (!clientData) {
            showNotification("Error", "Cliente no encontrado para copiar.", 'error');
            return;
        }

        // Campos solicitados: Usuario, Contraseña, Aplicacion, Fecha de caducidad
        const copyText = `
        Usuario: ${clientData.usuario || 'N/A'}
        Contraseña: ${clientData.contrasena || 'N/A'}
        Aplicación: ${clientData.aplicacion || 'N/A'}
        Fecha de caducidad: ${formatDate(clientData.caducidad)}
        `.trim().replace(/\n\s+/g, '\n');

        try {
            const textArea = document.createElement("textarea");
            textArea.value = copyText;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy'); // Uso de execCommand('copy') como fallback para iframes
            document.body.removeChild(textArea);

            showNotification("Copiado", "Usuario, Contraseña, Aplicación y Caducidad copiados.", 'success');
        } catch (err) {
            console.error('Error al copiar:', err);
            showNotification("Error al Copiar", "No se pudo copiar el texto automáticamente.", 'error');
        }
    };

    window.handleAddSubmit = async function(event) {
        event.preventDefault();
        const form = event.target;

        const data = {
            nombre: form.elements['f-nombre'].value,
            // 6. Teléfono por defecto: se usa el valor del input, que ya es "+34"
            telefono: form.elements['f-telefono'].value || null, 
            aplicacion: form.elements['f-aplicacion'].value,
            usuario: form.elements['f-usuario'].value,
            contrasena: form.elements['f-contrasena'].value,
            caducidad: new Date(form.elements['f-caducidad'].value),
            notas: form.elements['f-notas'].value || null,
            creacion: serverTimestamp(),
            recomendados: [], // Inicialmente vacío
            tipo_renovacion: 'manual',
            historial: [],
            usuario_creacion: auth.currentUser.email || 'Usuario Anónimo'
        };

        try {
            const docRef = await addDoc(collection(db, getUserCollectionPath()), data);
            
            const creationRecord = {
                fecha_renovacion: serverTimestamp(),
                caducidad_anterior: null,
                nueva_caducidad: data.caducidad,
                tipo_accion: 'Creación Inicial',
                usuario: auth.currentUser.email || 'Usuario Anónimo'
            };

            await updateDoc(docRef, {
                historial: arrayUnion(creationRecord)
            });

            showNotification("Éxito", "Cliente añadido correctamente.", 'success');
            form.reset();
            // 6. Resetear Teléfono a +34 después del reset
            document.getElementById('f-telefono').value = '+34'; 
            closeModal();
        } catch (error) {
            console.error("Error al añadir el cliente:", error);
            showNotification("Error", "No se pudo añadir el cliente.", 'error');
        }
    }

    // Función para abrir el modal de edición (IDS CORREGIDOS)
    window.openEdit = async function(id) {
        const clientDocRef = doc(db, getUserCollectionPath(), id);
        try {
            const docSnap = await getDoc(clientDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Carga de campos en el modal de edición (IDs CORREGIDOS)
                document.getElementById('edit-f-client-id').value = id;
                document.getElementById('client-name-display').textContent = data.nombre;
                document.getElementById('edit-f-nombre').value = data.nombre || '';
                // 6. Teléfono por defecto: se usa el valor del input, que ya es "+34" si está vacío
                document.getElementById('edit-f-telefono').value = data.telefono || '+34';
                document.getElementById('edit-f-aplicacion').value = data.aplicacion || '';
                document.getElementById('edit-f-usuario').value = data.usuario || '';
                document.getElementById('edit-f-contrasena').value = data.contrasena || '';
                document.getElementById('edit-f-caducidad').value = formatDateForInput(data.caducidad);
                document.getElementById('edit-f-notas').value = data.notas || '';

                // Renderizar historial de renovaciones
                const historyList = data.historial || [];
                renderRenewalHistory(historyList, document.getElementById('renewal-history'));
                
                document.getElementById('edit-modal').style.display = 'flex';
            } else {
                showNotification("Error", "Cliente no encontrado.", 'error');
            }
        } catch (error) {
            console.error("Error al cargar cliente para edición:", error);
            showNotification("Error", "No se pudo cargar la información del cliente.", 'error');
        }
    }

    // Función para manejar el envío del formulario de edición (IDS CORREGIDOS)
    window.handleEditSubmit = async function(event) {
        event.preventDefault();
        
        // Obtener valores de los campos CORREGIDOS
        const id = document.getElementById('edit-f-client-id').value;
        const caducidadActual = allClients.find(c => c.id === id)?.caducidad.toDate();
        const nuevaCaducidad = new Date(document.getElementById('edit-f-caducidad').value);
        
        const updatedData = {
            nombre: document.getElementById('edit-f-nombre').value,
            telefono: document.getElementById('edit-f-telefono').value || null,
            aplicacion: document.getElementById('edit-f-aplicacion').value,
            usuario: document.getElementById('edit-f-usuario').value,
            contrasena: document.getElementById('edit-f-contrasena').value,
            caducidad: nuevaCaducidad,
            notas: document.getElementById('edit-f-notas').value || null,
        };

        try {
            const clientDocRef = doc(db, getUserCollectionPath(), id);
            await updateDoc(clientDocRef, updatedData);
            showNotification("Actualizado", "Cliente modificado con éxito.", 'success');
            closeModal();
            
            // Si la fecha de caducidad se modificó manualmente, añadir al historial
            if (caducidadActual && nuevaCaducidad.getTime() !== caducidadActual.getTime()) {
                const historyRecord = {
                    fecha_renovacion: serverTimestamp(),
                    caducidad_anterior: caducidadActual,
                    nueva_caducidad: nuevaCaducidad,
                    tipo_accion: 'Edición Manual de Fecha',
                    usuario: auth.currentUser.email || 'Usuario Anónimo'
                };
                await updateDoc(clientDocRef, { historial: arrayUnion(historyRecord) });
            }

        } catch (error) {
            console.error("Error al actualizar el cliente:", error);
            showNotification("Error", "No se pudo guardar los cambios del cliente.", 'error');
        }
    }

    // 5. Mes Gratis Condicional
    window.addFreeMonth = async function(id) {
        const clientDocRef = doc(db, getUserCollectionPath(), id);
        const docSnap = await getDoc(clientDocRef);
        if (!docSnap.exists()) return;

        const data = docSnap.data();
        const numRecomendaciones = (data.recomendados && Array.isArray(data.recomendados)) ? data.recomendados.length : 0;
        
        // Condición: solo si tiene 3 campos en el apartado de recomendaciones
        if (numRecomendaciones < 3) {
            showNotification("Acción Bloqueada", `Se requieren al menos 3 recomendaciones (${numRecomendaciones} actuales) para el Mes Gratis.`, 'warning');
            return;
        }

        const confirmed = confirm(`¿Desea aplicar el MES GRATIS a ${data.nombre}? Requiere ${numRecomendaciones}/3 recomendaciones.`);
        if (!confirmed) return;


        const oldCaducidad = data.caducidad.toDate ? data.caducidad.toDate() : new Date(data.caducidad);
        const newCaducidad = new Date(oldCaducidad);
        newCaducidad.setMonth(newCaducidad.getMonth() + 1); // Añadir 1 mes

        const renewalRecord = {
            fecha_renovacion: serverTimestamp(),
            caducidad_anterior: oldCaducidad,
            nueva_caducidad: newCaducidad,
            tipo_accion: 'Mes Gratis (30 días)',
            usuario: auth.currentUser.email || 'Usuario Anónimo'
        };

        try {
            await updateDoc(clientDocRef, {
                caducidad: newCaducidad,
                tipo_renovacion: 'gratis',
                historial: arrayUnion(renewalRecord)
            });
            showNotification("Mes Gratis Aplicado", `${data.nombre} extendido por 1 mes. Nueva caducidad: ${formatDate(newCaducidad)}.`, 'success');
        } catch (error) {
            console.error("Error al aplicar mes gratis:", error);
            showNotification("Error", "No se pudo aplicar el Mes Gratis.", 'error');
        }
    }

    // Función para renovar (un mes más)
    window.renewItem = async function(id, tipoAccion) {
        const clientDocRef = doc(db, getUserCollectionPath(), id);
        const docSnap = await getDoc(clientDocRef);
        if (!docSnap.exists()) return;

        const data = docSnap.data();
        const confirmed = confirm(`¿Desea renovar a ${data.nombre} por 1 mes?`);
        if (!confirmed) return;

        try {
            const oldCaducidad = data.caducidad.toDate ? data.caducidad.toDate() : new Date(data.caducidad);
            const newCaducidad = new Date(oldCaducidad);
            newCaducidad.setMonth(newCaducidad.getMonth() + 1);

            const renewalRecord = {
                fecha_renovacion: serverTimestamp(),
                caducidad_anterior: oldCaducidad,
                nueva_caducidad: newCaducidad,
                tipo_accion: tipoAccion,
                usuario: auth.currentUser.email || 'Usuario Anónimo'
            };

            await updateDoc(clientDocRef, {
                caducidad: newCaducidad,
                tipo_renovacion: 'manual',
                historial: arrayUnion(renewalRecord)
            });

            showNotification("Renovado", `${data.nombre} renovado por un mes más.`, 'success');
        } catch (error) {
            console.error("Error al renovar el cliente:", error);
            showNotification("Error", "No se pudo renovar el cliente.", 'error');
        }
    }


    window.deleteItem = async function(id) {
        const confirmed = confirm("¿Estás seguro de que quieres eliminar este cliente? Esta acción es irreversible.");
        if (!confirmed) return;

        try {
            await deleteDoc(doc(db, getUserCollectionPath(), id));
            showNotification("Eliminado", "Cliente eliminado con éxito.", 'success');
        } catch (error) {
            console.error("Error al eliminar el cliente:", error);
            showNotification("Error", "No se pudo eliminar el cliente.", 'error');
        }
    }

    // FUNCIÓN PARA RENDERIZAR EL HISTORIAL (ACTUALIZADA CON TIPO DE ACCIÓN)
    function renderRenewalHistory(historyList, targetDiv) {
        targetDiv.innerHTML = '';
        if (historyList.length === 0) {
            targetDiv.innerHTML = '<p style="text-align:center; color: var(--muted);">No se encontraron registros de renovación.</p>';
            return;
        }

        let html = '<div style="display:grid; gap:10px;">';
        historyList.forEach(rec => {
            const actionType = rec.tipo_accion || 'Renovación Manual';
            const color = actionType.includes('Gratis') ? 'var(--yellow)' : actionType.includes('Creación') ? 'var(--green)' : 'var(--accent)';

            html += `
                <div class="history-stat" style="border-left: 4px solid ${color};">
                    <h5>${actionType}</h5>
                    <div style="font-size: 0.8rem;">
                         Fecha de Reg: ${formatDate(rec.fecha_renovacion)}<br/>
                         Cad. Anterior: ${rec.caducidad_anterior ? formatDate(rec.caducidad_anterior) : 'N/A'}<br/>
                         Nueva Cad.: ${formatDate(rec.nueva_caducidad)}
                    </div>
                </div>
            `;
        });
        html += '</div>';
        targetDiv.innerHTML = html;
    }


    // =========================================================================
    // 5. INICIO DE LA APLICACIÓN
    // =========================================================================

    // Llamar a la función de inicialización al cargar la página
    window.onload = initializeFirebase; 
  </script>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loading" style="position: fixed; inset: 0; background-color: var(--bg); display: flex; justify-content: center; align-items: center; color: var(--accent); z-index: 1000;">
    Cargando aplicación y autenticando...
  </div>

  <div id="main-content" style="display:none;">
    <div class="container">
      <header>
        <h1>Gestor de Clientes</h1>
        <div class="nav">
          <button class="btn nav-link active" onclick="showSection('dashboard-section')">Dashboard</button>
          <button class="btn nav-link" onclick="showSection('clients-section')">Clientes</button>
          <button class="btn nav-link" onclick="document.getElementById('add-modal').style.display='flex'">+ Nuevo</button>
          <button class="btn nav-link" onclick="showSection('tutorial-section')">Tutorial</button>
          <button class="btn nav-link" onclick="logout()">Salir</button>
        </div>
      </header>
      
      <!-- DASHBOARD SECTION -->
      <section id="dashboard-section" style="display:none;">
        <h2>Dashboard</h2>
        <div class="stats-grid">
          <div class="stat total"><h3>Total Clientes</h3><p id="stat-total">0</p></div>
          <div class="stat active"><h3>Clientes Activos</h3><p id="stat-active">0</p></div>
          <div class="stat expiring"><h3>A Punto de Caducar</h3><p id="stat-expiring">0</p></div>
          <div class="stat free"><h3>Mes Gratis</h3><p id="stat-free">0</p></div>
        </div>
        
        <!-- 1. Unique Visualization for Expiring Clients -->
        <div class="expiring-clients-box">
            <h3>Clientes a punto de Caducar (3 Días)</h3>
            <div id="expiring-clients-container">
                <!-- Clients expiring in 3 days will be rendered here in a row -->
            </div>
        </div>
      </section>

      <!-- CLIENTS SECTION -->
      <section id="clients-section" style="display:none;">
        <h2>Gestión de Clientes</h2>
        <div class="controls">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar por nombre, usuario, o app..." />
            <div style="display: flex; gap: 10px;">
                <button class="btn secondary" onclick="filterClients('all')">Todos</button>
                <button class="btn secondary" onclick="filterClients('expiring')">Caducando</button>
                <button class="btn secondary" onclick="filterClients('free')">Gratis</button>
            </div>
        </div>
        <div class="clients-grid" id="clients-grid">
          <p style="text-align:center; color: var(--muted); width: 100%;">Cargando clientes...</p>
        </div>
      </section>
      
      <!-- 7. TUTORIAL SECTION -->
      <section id="tutorial-section" style="display:none;">
        <h2>Guía de Uso del Gestor de Clientes</h2>
        <p class="description" style="color: var(--accent); font-size: 1.1em;">Bienvenido al tutorial. Aquí aprenderás a usar todas las funciones de esta aplicación.</p>

        <div class="tutorial-content">
            <div class="tutorial-step">
                <h4>Dashboard y Estadísticas</h4>
                <p>Muestra el resumen de la aplicación, destacando los <strong>clientes que caducan en los próximos 3 días</strong> en una fila especial para atención rápida.</p>
                <ul>
                    <li>**Botón Copiar:** Copia 4 campos clave: Usuario, Contraseña, Aplicación, y Fecha de Caducidad.</li>
                </ul>
            </div>
            <div class="tutorial-step">
                <h4>Gestión y Colores</h4>
                <p>La sección "Clientes" lista todos los registros. Las tarjetas rotan entre <strong>5 colores distintos</strong> para una mejor visualización de los datos. El modal de edición es totalmente <strong>responsive</strong>.</p>
            </div>
            <div class="tutorial-step">
                <h4>Funciones Clave</h4>
                <p>Las acciones rápidas son:</p>
                <ul>
                    <li>**Renovar:** Añade 1 mes al servicio.</li>
                    <li>**Mes Gratis:** Añade 1 mes. ⚠️ **Solo si el cliente tiene 3 o más recomendaciones.**</li>
                    <li>**Teléfono:** Por defecto es **+34** en el formulario de registro.</li>
                </ul>
            </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Modal de Añadir -->
  <div id="add-modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal(event)">&times;</span>
      <h3>Añadir Nuevo Cliente</h3>
      <form id="add-client-form" onsubmit="handleAddSubmit(event)">
        <div class="modal-form">
            <div class="form-group">
                <label for="f-nombre">Nombre:</label>
                <input type="text" id="f-nombre" name="f-nombre" required>
            </div>

            <div class="form-group">
                <label for="f-usuario">Usuario/Email:</label>
                <input type="text" id="f-usuario" name="f-usuario" required>
            </div>

            <div class="form-group">
                <label for="f-contrasena">Contraseña:</label>
                <input type="text" id="f-contrasena" name="f-contrasena" required>
            </div>
            
            <div class="form-group">
                <label for="f-aplicacion">Aplicación:</label>
                <input type="text" id="f-aplicacion" name="f-aplicacion" required>
            </div>

            <div class="form-group">
                <label for="f-telefono">Teléfono (opcional):</label>
                <input type="tel" id="f-telefono" name="f-telefono" value="+34">
            </div>

            <div class="form-group">
                <label for="f-caducidad">Fecha de Caducidad:</label>
                <input type="date" id="f-caducidad" name="f-caducidad" required>
            </div>

            <div class="form-group full-width">
                <label for="f-notas">Notas (opcional):</label>
                <textarea id="f-notas" name="f-notas"></textarea>
            </div>
        </div>
        <button type="submit" class="btn primary full-width">Guardar Cliente</button>
      </form>
    </div>
  </div>

  <!-- Modal de Edición (IDS CORREGIDOS) -->
  <div id="edit-modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal(event)">&times;</span>
      <h3>Editar Cliente <span id="client-name-display"></span></h3>
      <form id="edit-client-form" onsubmit="handleEditSubmit(event)">
        <!-- Hidden ID - ID CORREGIDO -->
        <input type="hidden" id="edit-f-client-id" name="id">

        <div class="modal-form">
            <div class="form-group">
                <label for="edit-f-nombre">Nombre:</label>
                <input type="text" id="edit-f-nombre" name="edit-f-nombre" required>
            </div>

            <div class="form-group">
                <label for="edit-f-usuario">Usuario/Email:</label>
                <input type="text" id="edit-f-usuario" name="edit-f-usuario" required>
            </div>

            <div class="form-group">
                <label for="edit-f-contrasena">Contraseña:</label>
                <input type="text" id="edit-f-contrasena" name="edit-f-contrasena" required>
            </div>
            
            <div class="form-group">
                <label for="edit-f-aplicacion">Aplicación:</label>
                <input type="text" id="edit-f-aplicacion" name="edit-f-aplicacion" required>
            </div>

            <div class="form-group">
                <label for="edit-f-telefono">Teléfono (opcional):</label>
                <input type="tel" id="edit-f-telefono" name="edit-f-telefono">
            </div>

            <div class="form-group">
                <label for="edit-f-caducidad">Fecha de Caducidad:</label>
                <input type="date" id="edit-f-caducidad" name="edit-f-caducidad" required>
            </div>

            <div class="form-group full-width">
                <label for="edit-f-notas">Notas (opcional):</label>
                <textarea id="edit-f-notas" name="edit-f-notas"></textarea>
            </div>
        </div>
        
        <button type="submit" class="btn primary full-width">Guardar Cambios</button>
      </form>

      <h4 style="margin-top: 30px; border-top: 1px solid var(--glass); padding-top: 15px; color: var(--accent);">Historial de Renovaciones</h4>
      <div id="renewal-history">
        <!-- Historial rendered here -->
      </div>
      
    </div>
  </div>

  <div class="notification-container" id="notification-container"></div>
</body>
</html>

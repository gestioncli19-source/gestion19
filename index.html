<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--red:#ef4444;--green:#10b981;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#013220;font-weight:700}
    nav{margin-left:auto}
    .menu{display:flex;gap:8px}
    .menu button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .menu button.active{background:var(--accent);color:#052018;border:none}
    main{display:grid;grid-template-columns:1fr;gap:18px}
    .cards-col{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:18px;}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .stat{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    /* NUEVO: ESTILO PARA ESTADÍSTICAS CLICABLES */
    .stat-clickable {
        cursor: pointer;
        transition: background 0.2s;
    }
    .stat-clickable:hover {
        background: rgba(255,255,255,0.05);
    }
    .stat h3{margin:0;font-size:12px;color:var(--muted)}
    .stat p{margin:8px 0 0;font-size:20px;font-weight:600}
    .grid-clients{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .card h4{margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .btns{display:flex;gap:6px;margin-top:10px}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn.edit{background:#1f2937;color:#e6eef6}
    .btn.renew{background:#064e3b;color:var(--accent)}
    .btn.copy{background:#0b1220;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .btn.delete{background:#3b0b0b;color:#ffcfcf}
    .card-form{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    form{display:grid;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input[type=text],input[type=date],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.6));z-index:50}
    .modal.show{display:flex}
    .modal-inner{width:96%;max-width:720px;background:var(--card);padding:16px;border-radius:12px}
    /* ESTILOS DE NOTIFICACIÓN */
    #notifications-container { position: fixed; top: 18px; right: 18px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--card); color: #e6eef6; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); min-width: 250px; max-width: 350px; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(-20px); }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-left: 4px solid var(--green); }
    .toast.error { border-left: 4px solid var(--red); }
    .toast strong { display: block; margin-bottom: 4px; font-size: 14px; }
    .toast p { margin: 0; font-size: 13px; color: var(--muted); }
    /* Dashboard: checkbox */
    .exp-card .flex-end { display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    /* NUEVOS ESTILOS: Campo de Recomendaciones Dinámico */
    .dynamic-input-container {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.04);
        background: transparent;
    }
    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
        min-height: 18px; /* Para evitar colapso si está vacío */
    }
    .recommendation-tag {
        background: var(--accent);
        color: #052018;
        padding: 4px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
    }
    .recommendation-tag button {
        background: none;
        border: none;
        color: #052018;
        margin-left: 6px;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
        padding: 0;
    }
    .input-add-row {
        display: flex;
        gap: 8px;
    }
    .input-add-row input[type=text] {
        flex-grow: 1;
        padding: 6px 10px; 
        border: 1px solid rgba(255,255,255,0.1);
    }
    .input-add-row button {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        padding: 0;
        font-size: 18px;
        line-height: 1;
    }

    @media (min-width: 701px) {
        .cards-col {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    @media (max-width:700px){.row{grid-template-columns:1fr}.menu{display:flex;gap:6px}}
  </style>
</head>

<body>
<div class="container">

<header>
  <div class="brand">
    <div class="logo">GC</div>
    <div><div style="font-weight:700">Gestor Clientes</div></div>
  </div>
  <nav>
    <div class="menu">
      <button id="nav-dashboard" class="active">Dashboard</button>
      <button id="nav-clientes">Clientes</button>
      <button id="nav-add">Añadir cliente</button>
    </div>
  </nav>
</header>

<main>

<section id="section-dashboard">
  <div class="cards-col">
    <div class="stat">
      <h3>Total clientes</h3><p id="stat-total">—</p>
    </div>
    <div class="stat stat-clickable" id="stat-3days-link" title="Haz clic para filtrar clientes.">
      <h3>Caducan en 3 días</h3><p id="stat-today-3days">—</p>
    </div>
    <div class="stat stat-clickable" id="stat-expired-link" title="Haz clic para filtrar clientes.">
      <h3>Cliente caducado</h3><p id="stat-expired">—</p>
    </div>
  </div>
  <div id="dashboard-soon-exp" class="cards" style="margin-top: 18px">
    <p class="meta" style="grid-column: 1 / -1; margin-bottom: 0;">Clientes que caducan en los próximos 3 días:</p>
  </div>
</section>

<section id="section-clientes" style="display:none">
  <div class="card-form">
    <h3>Clientes</h3>
    
    <input type="text" id="search-input" placeholder="Buscar por Nombre, Usuario o Aplicación..." style="margin-bottom: 12px;" />

    <div id="clients-grid" class="grid-clients" style="margin-top:10px"></div>
  </div>
</section>

<section id="section-add" style="display:none">
  <div class="card-form">
    <h3>Añadir cliente</h3>
    <form id="form-add">

      <label>Nombre</label>
      <input type="text" id="f-nombre" required />

      <div class="row">
        <div>
          <label>Fecha de creación</label>
          <input type="date" id="f-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="f-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="f-usuario" />

      <label>Contraseña</label>
      <input type="text" id="f-contrasena" />

      <label>Dispositivo utilizado</label>
      <input type="text" id="f-dispositivo" />

      <label>Aplicación</label>
      <select id="f-aplicacion">
        <option value="Spinning TV">Spinning TV</option>
        <option value="Spinning IBO">Spinning IBO</option>
        <option value="Spinning Mate">Spinning Mate</option>
        <option value="Hot Player">Hot Player</option>
      </select>

      <label>Clientes recomendados</label>
      <div id="f-recomendaciones-container" class="dynamic-input-container">
          <div id="f-recommended-clients" class="tag-list"></div>
          <div class="input-add-row">
              <input type="text" id="f-new-recommendation" placeholder="Nombre de cliente recomendado" />
              <button type="button" class="btn copy" id="f-add-recommendation-btn">+</button>
          </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button type="submit" class="btn edit">Guardar</button>
        <button type="button" id="f-reset" class="btn copy">Reset</button>
      </div>

    </form>
  </div>
</section>
</main>

<footer></footer>

</div>

<div id="modal" class="modal">
  <div class="modal-inner">
    <h3 id="modal-title">Editar cliente</h3>
    <form id="form-edit">

      <label>Nombre</label>
      <input type="text" id="e-nombre" required />

      <div class="row">
        <div>
          <label>Fecha de creación</label>
          <input type="date" id="e-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="e-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="e-usuario" />

      <label>Contraseña</label>
      <input type="text" id="e-contrasena" />

      <label>Dispositivo utilizado</label>
      <input type="text" id="e-dispositivo" />

      <label>Aplicación</label>
      <select id="e-aplicacion">
        <option value="Spinning TV">Spinning TV</option>
        <option value="Spinning IBO">Spinning IBO</option>
        <option value="Spinning Mate">Spinning Mate</option>
        <option value="Hot Player">Hot Player</option>
      </select>

      <label>Clientes recomendados</label>
      <div id="e-recomendaciones-container" class="dynamic-input-container">
          <div id="e-recommended-clients" class="tag-list"></div>
          <div class="input-add-row">
              <input type="text" id="e-new-recommendation" placeholder="Nombre de cliente recomendado" />
              <button type="button" class="btn copy" id="e-add-recommendation-btn">+</button>
          </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
        <button type="button" id="modal-cancel" class="btn copy">Cancelar</button>
        <button type="submit" class="btn edit">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<div id="notifications-container"></div>


<script type="module">

// --- CONFIG FIREBASE ---
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import {
  getFirestore, collection, addDoc, doc, onSnapshot,
  updateDoc, deleteDoc, query, orderBy
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCA2fZvN8WVKWwEDL0z694C2o5190OMhq8",
  authDomain: "gestioncandy-b9356.firebaseapp.com",
  projectId: "gestioncandy-b9356",
  storageBucket: "gestioncandy-b9356.firebasestorage.app",
  messagingSenderId: "869982852654",
  appId: "1:869982852654:web:ac450321a746e62365f1bf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTOS UI
const navDashboard = document.getElementById('nav-dashboard');
const navClientes = document.getElementById('nav-clientes');
const navAdd = document.getElementById('nav-add');

const secDashboard = document.getElementById('section-dashboard');
const secClientes = document.getElementById('section-clientes');
const secAdd = document.getElementById('section-add');

const clientsGrid = document.getElementById('clients-grid');
const statTotal = document.getElementById('stat-total');
const statToday3Days = document.getElementById('stat-today-3days');
const statExpired = document.getElementById('stat-expired');
const dashboardSoonExp = document.getElementById('dashboard-soon-exp');
const stat3DaysLink = document.getElementById('stat-3days-link'); // Nuevo
const statExpiredLink = document.getElementById('stat-expired-link'); // Nuevo

// FORM ADD
const formAdd = document.getElementById('form-add');
const fReset = document.getElementById('f-reset');
const fCreacion = document.getElementById('f-creacion');
const fRecommendedClientsDiv = document.getElementById('f-recommended-clients');
const fNewRecommendationInput = document.getElementById('f-new-recommendation');
const fAddRecommendationBtn = document.getElementById('f-add-recommendation-btn');

// FORM EDIT fields
const eRecommendedClientsDiv = document.getElementById('e-recommended-clients');
const eNewRecommendationInput = document.getElementById('e-new-recommendation');
const eAddRecommendationBtn = document.getElementById('e-add-recommendation-btn');
const eDispositivo = document.getElementById('e-dispositivo');

// SEARCH
const searchInput = document.getElementById('search-input');

// MODAL
const modal = document.getElementById('modal');
const modalCancelBtn = document.getElementById('modal-cancel');
const formEdit = document.getElementById('form-edit');

// NOTIFICATIONS
const notificationsContainer = document.getElementById('notifications-container');

// VARIABLE GLOBAL PARA GESTIONAR LAS RECOMENDACIONES EN EDICIÓN
let currentRecommendations = [];


// --- 1. SISTEMA DE NOTIFICACIONES ---
function showNotification(title, message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
  
  notificationsContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);

  setTimeout(() => {
    toast.classList.remove('show');
    toast.addEventListener('transitionend', () => toast.remove());
  }, 4000);
}


// --- FUNCIONES AUXILIARES ---
function formatDate(d){
  if(!d) return '-';
  const dt = new Date(d);
  if(isNaN(dt)) return d;
  return dt.toLocaleDateString();
}

function isoForInput(d){
  if(!d) return '';
  const t = new Date(d);
  if(isNaN(t)) return '';
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth()+1).padStart(2,'0');
  const dd = String(t.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}


// --- FECHA POR DEFECTO ---
function setDefaultCreationDate() {
  fCreacion.value = isoForInput(new Date());
}
setDefaultCreationDate();


// --- LÓGICA DE NAVEGACIÓN ---
function setActive(btn){
  document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if (btn === navClientes) {
      filterClients(searchInput.value);
  }
}

navDashboard.addEventListener('click', ()=>{
  setActive(navDashboard);
  secDashboard.style.display='block';
  secClientes.style.display='none';
  secAdd.style.display='none';
});

navClientes.addEventListener('click', ()=>{
  setActive(navClientes);
  secDashboard.style.display='none';
  secClientes.style.display='block';
  secAdd.style.display='none';
});

navAdd.addEventListener('click', ()=>{
  setActive(navAdd);
  secDashboard.style.display='none';
  secClientes.style.display='none';
  secAdd.style.display='block';
  setDefaultCreationDate();
});


// --- CARGA DE CLIENTES EN TIEMPO REAL ---
const col = collection(db, "clientes");
const q = query(col, orderBy("creacion", "desc"));

let cachedList = []; // Lista de todos los clientes
let cachedClientNames = new Set(); // Conjunto de nombres para validación rápida

// STREAM FIRESTORE
onSnapshot(q, snap => {
  cachedList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  cachedClientNames = new Set(cachedList.map(c => c.nombre.toLowerCase()));

  filterClients(searchInput.value);
  renderDashboard(cachedList);
  updateStats(cachedList);
});


// --- 2. FILTRO DE CLIENTES POR STAT DEL DASHBOARD ---
function filterByStat(filterType) {
    // 1. Cambiar a la vista de Clientes
    setActive(navClientes);
    secDashboard.style.display='none';
    secClientes.style.display='block';
    secAdd.style.display='none';
    
    // 2. Limpiar la barra de búsqueda (para que se vea que el filtro viene del dashboard)
    searchInput.value = '';

    // 3. Lógica de filtrado
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const limit3Days = new Date(now);
    limit3Days.setDate(limit3Days.getDate() + 3);
    limit3Days.setHours(23, 59, 59, 999);
    
    let filteredList = [];

    if (filterType === '3days') {
        filteredList = cachedList.filter(i => {
            if (!i.caducidad) return false;
            const d = new Date(i.caducidad);
            d.setHours(0, 0, 0, 0);
            return d >= now && d <= limit3Days;
        });
        showNotification("Filtro Aplicado", `Mostrando ${filteredList.length} clientes que caducan en 3 días.`, 'success');

    } else if (filterType === 'expired') {
        filteredList = cachedList.filter(i => {
            if (!i.caducidad) return false;
            const d = new Date(i.caducidad);
            d.setHours(0, 0, 0, 0);
            return d < now;
        });
        showNotification("Filtro Aplicado", `Mostrando ${filteredList.length} clientes caducados.`, 'success');
    }

    // 4. Renderizar la lista filtrada
    renderClients(filteredList);
}

// Event Listeners para los stats clicables
stat3DaysLink.addEventListener('click', () => filterByStat('3days'));
statExpiredLink.addEventListener('click', () => filterByStat('expired'));


// --- BÚSQUEDA/FILTRADO GENERAL ---
function filterClients(searchTerm = ""){
    const term = searchTerm.toLowerCase();
    
    if (term === "" && cachedList.length) {
        renderClients(cachedList); // Si no hay término, muestra toda la lista
        return;
    }
    
    const filteredList = cachedList.filter(item => 
        item.nombre.toLowerCase().includes(term) ||
        (item.usuario && item.usuario.toLowerCase().includes(term)) ||
        (item.aplicacion && item.aplicacion.toLowerCase().includes(term))
    );

    renderClients(filteredList);
}

searchInput.addEventListener('input', (e) => filterClients(e.target.value));


// --- ESTADÍSTICAS ---
function updateStats(list){
  statTotal.textContent = list.length;
  // Lógica de 3 días y caducados permanece igual
  const today = new Date();
  today.setHours(0,0,0,0);
  const limit3Days = new Date(today);
  limit3Days.setDate(limit3Days.getDate() + 3);
  limit3Days.setHours(23,59,59,999);
  const soonCount = list.filter(i => {
    if(!i.caducidad) return false;
    const d = new Date(i.caducidad);
    d.setHours(0,0,0,0);
    return d >= today && d <= limit3Days;
  }).length;
  statToday3Days.textContent = soonCount;
  const expiredCount = list.filter(i => {
    if(!i.caducidad) return false;
    const d = new Date(i.caducidad);
    d.setHours(0,0,0,0);
    return d < today;
  }).length;
  statExpired.textContent = expiredCount;
}

// ... (renderDashboard y toggleRenovara no necesitan cambios estructurales en su lógica)
function renderDashboard(list){
  const now = new Date();
  now.setHours(0,0,0,0);
  const limit = new Date(now);
  limit.setDate(limit.getDate() + 3);
  limit.setHours(23,59,59,999);
  const soon = list.filter(i => {
    if(!i.caducidad) return false;
    const d = new Date(i.caducidad);
    return d >= now && d <= limit;
  });

  dashboardSoonExp.innerHTML = `<p class="meta" style="grid-column: 1 / -1; margin-bottom: 0;">Clientes que caducan en los próximos 3 días (${soon.length}):</p>`;

  if (soon.length === 0) {
      dashboardSoonExp.innerHTML += '<p style="grid-column: 1 / -1; color: var(--muted); margin-top: 10px;">No hay clientes próximos a caducar.</p>';
  }

  soon.forEach(item => {
    const isRenewing = item.renovara === true ? 'checked' : '';
    const card = document.createElement('div');
    card.className = "card exp-card";
    card.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
      <div class="flex-end">
        <label for="renew-${item.id}">Renovará</label>
        <input type="checkbox" id="renew-${item.id}" data-id="${item.id}" ${isRenewing} onclick="toggleRenovara(this)" />
      </div>
      <div class="btns">
        <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
        <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
      </div>
    `;
    dashboardSoonExp.appendChild(card);
  });
}

window.toggleRenovara = async function(checkbox) {
    const id = checkbox.getAttribute('data-id');
    const newState = checkbox.checked;
    
    try {
        await updateDoc(doc(db, "clientes", id), {
            renovara: newState
        });
        showNotification(
            "Cliente actualizado", 
            `'Renovará' para ${id} es ahora ${newState ? 'Sí' : 'No'}.`,
            'success'
        );
    } catch (error) {
        showNotification(
            "Error", 
            "No se pudo actualizar el estado de renovación.",
            'error'
        );
        console.error("Error updating renovara:", error);
    }
}


// --- RENDER DE CLIENTES EN TARJETAS ---
function renderClients(list){
  clientsGrid.innerHTML = "";

  list.forEach(item => {
    // Muestra las recomendaciones como un detalle adicional en la tarjeta
    const recommendations = item.recomendaciones && item.recomendaciones.length > 0
        ? `<div class="meta">Recomendado por: ${item.recomendaciones.join(', ')}</div>`
        : '';

    const card = document.createElement('div');
    card.className = "card";
    card.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="meta">App: ${item.aplicacion || "-"}</div>
      <div class="meta">Dispositivo: ${item.dispositivo || "-"}</div>
      <div class="meta">Creación: ${formatDate(item.creacion)}</div>
      <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
      ${recommendations}

      <div class="btns">
        <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
        <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
        <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
        <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
      </div>
    `;
    clientsGrid.appendChild(card);
  });
}


// --- 3. LÓGICA DE RECOMENDACIONES DINÁMICAS ---

// RENDERIZA LAS ETIQUETAS DE RECOMENDACIÓN
function renderRecommendedClients(recommendations, targetDiv) {
    targetDiv.innerHTML = '';
    recommendations.forEach((name, index) => {
        const tag = document.createElement('div');
        tag.className = 'recommendation-tag';
        tag.innerHTML = `
            ${name}
            <button type="button" data-index="${index}" data-target-id="${targetDiv.id}">x</button>
        `;
        tag.querySelector('button').onclick = (e) => removeRecommendedClient(e.target);
        targetDiv.appendChild(tag);
    });
}

// AÑADE UN CLIENTE A LA LISTA
function addRecommendedClient(inputElement, targetDiv, isEdit = false) {
    const name = inputElement.value.trim();
    if (name === "") return;

    // Validación: Debe existir en la lista de clientes actual (case-insensitive)
    if (!cachedClientNames.has(name.toLowerCase())) {
        showNotification("Error de Recomendación", `El cliente "${name}" no existe en la base de datos.`, 'error');
        return;
    }

    if (currentRecommendations.includes(name)) {
        showNotification("Error de Recomendación", `El cliente "${name}" ya ha sido añadido.`, 'error');
        return;
    }
    
    currentRecommendations.push(name);
    renderRecommendedClients(currentRecommendations, targetDiv);
    inputElement.value = '';
}

// ELIMINA UN CLIENTE DE LA LISTA
function removeRecommendedClient(button) {
    const index = parseInt(button.getAttribute('data-index'));
    const targetId = button.getAttribute('data-target-id');
    
    currentRecommendations.splice(index, 1);
    
    // Vuelve a renderizar la lista usando el div correcto (Add o Edit)
    const targetDiv = document.getElementById(targetId);
    renderRecommendedClients(currentRecommendations, targetDiv);
}

// Event Listeners para añadir recomendaciones
fAddRecommendationBtn.addEventListener('click', () => addRecommendedClient(fNewRecommendationInput, fRecommendedClientsDiv));
fNewRecommendationInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addRecommendedClient(fNewRecommendationInput, fRecommendedClientsDiv);
    }
});

eAddRecommendationBtn.addEventListener('click', () => addRecommendedClient(eNewRecommendationInput, eRecommendedClientsDiv, true));
eNewRecommendationInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addRecommendedClient(eNewRecommendationInput, eRecommendedClientsDiv, true);
    }
});


// --- LÓGICA DE ACCIONES (Actualizada para manejar recomendaciones) ---

window.openEdit = function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  // Carga las recomendaciones del cliente en la variable global
  currentRecommendations = item.recomendaciones || [];
  
  document.getElementById('e-nombre').value = item.nombre;
  document.getElementById('e-creacion').value = isoForInput(item.creacion);
  document.getElementById('e-caducidad').value = isoForInput(item.caducidad);
  document.getElementById('e-usuario').value = item.usuario || "";
  document.getElementById('e-contrasena').value = item.contrasena || "";
  document.getElementById('e-dispositivo').value = item.dispositivo || "";
  document.getElementById('e-aplicacion').value = item.aplicacion || ""; 
  document.getElementById('e-recomendaciones').value = item.recomendaciones || "";

  // Renderiza las etiquetas
  renderRecommendedClients(currentRecommendations, eRecommendedClientsDiv);
  eNewRecommendationInput.value = ''; // Limpia el input temporal

  modal.setAttribute('data-id', id);
  modal.classList.add('show');
};

formEdit.addEventListener('submit', async e=>{
  e.preventDefault();
  const id = modal.getAttribute('data-id');
  if(!id) return;

  const data = {
    nombre: document.getElementById('e-nombre').value,
    creacion: document.getElementById('e-creacion').value,
    caducidad: document.getElementById('e-caducidad').value,
    usuario: document.getElementById('e-usuario').value,
    contrasena: document.getElementById('e-contrasena').value,
    dispositivo: document.getElementById('e-dispositivo').value,
    aplicacion: document.getElementById('e-aplicacion').value,
    recomendaciones: currentRecommendations // Usa el array dinámico
  };

  try {
      await updateDoc(doc(db, "clientes", id), data);
      modal.classList.remove('show');
      showNotification("Guardado", `Cambios en cliente ${data.nombre} guardados.`, 'success');
      currentRecommendations = []; // Limpia la variable global después de guardar
  } catch (error) {
      showNotification("Error", "No se pudieron guardar los cambios.", 'error');
      console.error("Error updating item:", error);
  }
});

formAdd.addEventListener('submit', async e=>{
  e.preventDefault();

  const data = {
    nombre: document.getElementById('f-nombre').value,
    creacion: document.getElementById('f-creacion').value,
    caducidad: document.getElementById('f-caducidad').value,
    usuario: document.getElementById('f-usuario').value,
    contrasena: document.getElementById('f-contrasena').value,
    dispositivo: document.getElementById('f-dispositivo').value,
    aplicacion: document.getElementById('f-aplicacion').value,
    recomendaciones: currentRecommendations, // Usa el array dinámico
    renovara: false
  };

  try {
      await addDoc(col, data);
      showNotification("Cliente Creado", `El cliente ${data.nombre} ha sido añadido con éxito.`, 'success');
      
      // Limpia la interfaz y la variable global
      formAdd.reset();
      setDefaultCreationDate();
      currentRecommendations = [];
      renderRecommendedClients(currentRecommendations, fRecommendedClientsDiv);
  } catch (error) {
      showNotification("Error de Creación", "No se pudo añadir el nuevo cliente. (Revisa si el nombre es único)", 'error');
      console.error("Error adding item:", error);
  }
});

// RESET FORM
fReset.addEventListener('click', ()=> {
    formAdd.reset();
    setDefaultCreationDate();
    currentRecommendations = [];
    renderRecommendedClients(currentRecommendations, fRecommendedClientsDiv);
});

// ... (copyPassword, renewItem, deleteItem no necesitan más cambios)
window.copyPassword = function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item || !item.contrasena) {
    showNotification("Error de Copia", "No hay contraseña o datos completos para copiar.", 'error');
    return;
  }
  const textToCopy = `Usuario: ${item.usuario || "-"}\nContraseña: ${item.contrasena || "-"}\nCaducidad: ${formatDate(item.caducidad)}\nAplicación: ${item.aplicacion || "-"}`;
  navigator.clipboard.writeText(textToCopy);
  showNotification("Copiado", "Datos clave copiados al portapapeles.", 'success');
}

window.renewItem = async function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  let date = new Date(item.caducidad || new Date());
  date.setMonth(date.getMonth() + 3); 

  try {
      await updateDoc(doc(db, "clientes", id), {
        caducidad: date.toISOString()
      });
      showNotification("Renovación Exitosa", "Cliente renovado por 3 meses.", 'success');
  } catch (error) {
      showNotification("Error de Renovación", "No se pudo renovar el cliente.", 'error');
      console.error("Error renewing item:", error);
  }
}

window.deleteItem = async function(id){
  if(!confirm("¿Eliminar cliente?")) return;
  
  try {
      await deleteDoc(doc(db, "clientes", id));
      showNotification("Eliminado", "Cliente eliminado correctamente.", 'success');
  } catch (error) {
      showNotification("Error", "No se pudo eliminar el cliente.", 'error');
      console.error("Error deleting item:", error);
  }
}

</script>
</body>
</html>

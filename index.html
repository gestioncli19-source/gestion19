<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--red:#ef4444;--green:#10b981;--yellow:#f59e0b;--whatsapp:#25d366;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    /* Aumento el ancho m√°ximo y el padding para una mejor visualizaci√≥n en PC */
    .container{max-width:1400px;margin:0 auto;padding:24px} 
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#013220;font-weight:700}
    nav{margin-left:auto}
    .menu{display:flex;gap:8px}
    .menu button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer; transition: background 0.2s; white-space: nowrap; }
    .menu button:hover { background: rgba(255,255,255,0.05); }
    .menu button.active{background:var(--accent);color:#052018;border:none}
    /* AJUSTE PARA BOT√ìN ICONO EN NAVEGACI√ìN */
    .menu button[title="Ajustes"] { 
        padding: 8px 10px; 
        font-size: 1.5em; 
        line-height: 1;
    }

    main{display:grid;grid-template-columns:1fr;gap:18px}
    .cards-col{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:18px;}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .stat{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .stat-clickable {
        cursor: pointer;
        transition: background 0.2s;
    }
    .stat-clickable:hover {
        background: rgba(255,255,255,0.05);
    }
    .stat h3{margin:0;font-size:12px;color:var(--muted)}
    .stat p{margin:8px 0 0;font-size:20px;font-weight:600}
    .grid-clients{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);position:relative}
    .card.status-red{border-left: 4px solid var(--red);}
    .card.status-yellow{border-left: 4px solid var(--yellow);}
    .card.status-green{border-left: 4px solid var(--green);}

    .card h4{margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px; white-space: pre-wrap;} 
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag-label { background: rgba(110, 231, 183, 0.1); color: var(--accent); font-size: 11px; padding: 3px 6px; border-radius: 4px; }
    
    .btns{display:flex;gap:6px;margin-top:10px; flex-wrap: wrap;}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600; transition: opacity 0.2s}
    .btn:disabled { opacity: 0.4; cursor: not-allowed; } 
    .btn.edit{background:#1f2937;color:#e6eef6}
    .btn.renew{background:#064e3b;color:var(--accent)}
    .btn.free-month{background:#0b2e3b;color:var(--accent); border: 1px solid rgba(110, 231, 183, 0.3);} 
    .btn.copy{background:#0b1220;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .btn.delete{background:#3b0b0b;color:#ffcfcf}
    .btn.export{background:var(--yellow);color:#212108;}
    .btn.history{background:#0f172a;color:var(--accent); border: 1px solid var(--accent);} 
    .btn.whatsapp-alert{background:var(--whatsapp);color:#0f1724; font-weight: 700; border: none;} 

    .card-form{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    form{display:grid;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input[type=text],input[type=date],textarea,select,input[type=email],input[type=password]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:90px;resize:vertical} 
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.6));z-index:50}
    .modal.show{display:flex}
    
    /* FIX CR√çTICO: HACER EL MODAL SCROLLABLE Y FIJAR BOTONES */
    .modal-inner{
        width:96%;
        max-width:720px;
        background:var(--card);
        padding:16px;
        border-radius:12px;
        max-height: 90vh; /* Limita la altura del modal en m√≥vil */
        display: flex; /* Habilita el flexbox para la estructura interna */
        flex-direction: column; /* Apila los elementos verticalmente */
        overflow: hidden; /* Evita que el modal entero se desborde */
    }

    /* Contenedor que S√ç se desplazar√° */
    #edit-form-scroll-wrapper {
        flex-grow: 1; /* Permite que tome el espacio disponible */
        overflow-y: auto; /* Habilita el scroll vertical */
        padding-right: 8px; /* Espacio para el scrollbar */
        margin-bottom: 10px; /* Separaci√≥n antes del footer */
    }
    
    .modal-inner form {
        padding-bottom: 0; /* Asegura que la forma no tenga padding que complique el scroll */
    }
    
    /* FIN DE FIX CR√çTICO */

    /* ESTILOS DE NOTIFICACI√ìN */
    #notifications-container { position: fixed; top: 18px; right: 18px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--card); color: #e6eef6; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); min-width: 250px; max-width: 350px; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(-20px); }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-left: 4px solid var(--green); }
    .toast.error { border-left: 4px solid var(--red); }
    .toast strong { display: block; margin-bottom: 4px; font-size: 14px; }
    .toast p { margin: 0; font-size: 13px; color: var(--muted); }
    /* Login Screen Styles */
    #section-login {
        display: none;
        position: fixed;
        inset: 0;
        background: linear-gradient(180deg,#071022 0%, #07132a 100%);
        align-items: center;
        justify-content: center;
        z-index: 90;
    }
    #section-login.show { display: flex; }
    .login-box {
        background: var(--card);
        padding: 30px;
        border-radius: 16px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.05);
    }
    .login-box h2 { text-align: center; margin-top: 0; color: var(--accent); }
    #login-error-message { color: var(--red); font-size: 13px; text-align: center; margin-top: 5px; height: 18px; }

    /* Dashboard: checkbox */
    .exp-card .flex-end { display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    /* ESTILOS: Campo de Recomendaciones Din√°mico y Autocompletado */
    .dynamic-input-container {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.04);
        background: transparent;
        position: relative; 
    }
    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
        min-height: 18px;
    }
    .recommendation-tag {
        background: var(--accent);
        color: #052018;
        padding: 4px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
    }
    .recommendation-tag button {
        background: none;
        border: none;
        color: #052018;
        margin-left: 6px;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
        padding: 0;
    }
    .input-add-row {
        display: flex;
        gap: 8px;
        position: relative;
    }
    .input-add-row input[type=text] {
        flex-grow: 1;
        padding: 6px 10px; 
        border: 1px solid rgba(255,255,255,0.1);
    }
    .input-add-row button {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        padding: 0;
        font-size: 18px;
        line-height: 1;
    }
    /* Estilos Autocompletado */
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 40px; 
        background: var(--card);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 60;
        list-style: none;
        padding: 0;
        margin: 4px 0 0;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .autocomplete-list li {
        padding: 8px 10px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .autocomplete-list li:hover, .autocomplete-list li.active {
        background: var(--glass);
    }
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}

    /* MEDIA QUERIES PARA ADAPTACI√ìN */
    @media (min-width: 701px) {
        .cards-col {
            grid-template-columns: repeat(3, 1fr);
        }
        .modal-inner.history { 
             max-width: 450px;
        }
    }

    @media (min-width: 1024px) { 
        body {
            font-size: 1.1em; 
        }
        .container {
            padding: 30px; 
        }
        .stat{padding:18px; border-radius:16px;}
        .stat h3{font-size:14px;} 
        .stat p{font-size:24px;} 
        .card{padding:18px; border-radius:14px;}
        .card h4{font-size: 18px;}
        .meta{font-size:13px;} 
        .grid-clients{grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
        .btn{padding:10px 14px; border-radius:10px; font-size: 15px;} 
        .menu button { padding: 10px 16px; font-size: 15px; } 
        .menu button[title="Ajustes"] { 
            padding: 8px 12px; 
            font-size: 1.7em;
        }
        input[type=text],input[type=date],textarea,select,input[type=email],input[type=password]{padding:12px; font-size: 16px;}
        label{font-size:14px;}
        .input-add-row input[type=text] { padding: 8px 12px; }
    }

    /* MEJORA RESPONSIVE PARA M√ìVIL (MENOS DE 700PX) */
    @media (max-width:700px){
        .container { padding: 12px; } 
        header { flex-direction: column; align-items: flex-start; gap: 8px; } /* Apilar logo y nav */
        nav { margin-left: 0; width: 100%; } /* Ocupar todo el ancho */
        .menu { gap: 4px; display: flex; flex-wrap: wrap; justify-content: space-between; } /* Mejor distribuci√≥n de los botones de navegaci√≥n */
        .menu button { padding: 8px 10px; font-size: 14px; flex-grow: 1; min-width: 23%; } /* Asegurar que los botones son tocables y se distribuyen */
        .menu button[title="Ajustes"] { font-size: 1.2em; padding: 6px 8px; flex-grow: 0; }
        .row{grid-template-columns:1fr}
        .cards-col { grid-template-columns: 1fr; } 
        .grid-clients { grid-template-columns: 1fr; } 
    }
  </style>
</head>

<body>

<section id="section-login" class="show">
  <div class="login-box">
    <h2>Gestor de Clientes</h2>
    <form id="form-login">
      <label for="login-email">Email</label>
      <input type="email" id="login-email" required />

      <label for="login-password" style="margin-top: 10px;">Contrase√±a</label>
      <input type="password" id="login-password" required />

      <div id="login-error-message"></div>

      <button type="submit" class="btn edit" style="width: 100%; margin-top: 15px;">Iniciar Sesi√≥n</button>
    </form>
  </div>
</section>

<div class="container" id="app-container" style="display:none;">

<header>
  <div class="brand">
    <div class="logo">GC</div>
    <div><div style="font-weight:700">Gestor Clientes</div></div>
  </div>
  <nav>
    <div class="menu">
      <button id="nav-dashboard" class="active">Dashboard</button>
      <button id="nav-clientes">Clientes</button>
      <button id="nav-add">A√±adir</button>
      <button id="nav-ajustes" title="Ajustes">‚öôÔ∏è</button>
    </div>
  </nav>
</header>

<main>

<section id="section-dashboard">
  <div class="cards-col">
    <div class="stat">
      <h3>Total clientes</h3><p id="stat-total">‚Äî</p>
    </div>
    <div class="stat stat-clickable" id="stat-3days-link" title="Haz clic para filtrar clientes.">
      <h3>Caducan en 3 d√≠as</h3><p id="stat-today-3days">‚Äî</p>
    </div>
    <div class="stat stat-clickable" id="stat-expired-link" title="Haz clic para filtrar clientes.">
      <h3>Cliente caducado</h3><p id="stat-expired">‚Äî</p>
    </div>
  </div>
  <div id="dashboard-soon-exp" class="cards" style="margin-top: 18px">
    <p class="meta" style="grid-column: 1 / -1; margin-bottom: 0;">Clientes que caducan en los pr√≥ximos 3 d√≠as:</p>
  </div>
</section>

<section id="section-clientes" style="display:none">
  <div class="card-form">
    <div id="clients-header-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h3 id="clients-header-h3">Clientes</h3>
    </div>
    
    <input type="text" id="search-input" placeholder="Buscar por Nombre, Usuario o Aplicaci√≥n..." style="margin-bottom: 12px;" />

    <div id="clients-grid" class="grid-clients" style="margin-top:10px"></div>
  </div>
</section>

<section id="section-add" style="display:none">
  <div class="card-form">
    <h3>A√±adir cliente</h3>
    <form id="form-add">

      <label>Nombre</label>
      <input type="text" id="f-nombre" required />
      
      <label>Tel√©fono (Ej: 34600123456)</label>
      <input type="text" id="f-telefono" placeholder="C√≥digo de pa√≠s + n√∫mero (sin espacios)" />

      <div class="row">
        <div>
          <label>Fecha de creaci√≥n</label>
          <input type="date" id="f-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="f-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="f-usuario" />

      <label>Contrase√±a</label>
      <input type="text" id="f-contrasena" />

      <label>Dispositivo utilizado</label>
      <input type="text" id="f-dispositivo" />

      <label>Aplicaci√≥n</label>
      <select id="f-aplicacion">
        <option value="Spinning TV">Spinning TV</option>
        <option value="Spinning IBO">Spinning IBO</option>
        <option value="Spinning Mate">Spinning Mate</option>
        <option value="Hot Player">Hot Player</option>
      </select>
      
      <label>Observaciones</label>
      <textarea id="f-observaciones" placeholder="Notas importantes sobre el cliente..."></textarea>

      <label>Clientes recomendados (Solo clientes existentes)</label>
      <div id="f-recomendaciones-container" class="dynamic-input-container">
          <div id="f-recommended-clients" class="tag-list"></div>
          <div class="input-add-row">
              <input type="text" id="f-new-recommendation" placeholder="Escribe un nombre de cliente existente" />
              <button type="button" class="btn copy" id="f-add-recommendation-btn">+</button>
              <ul id="f-autocomplete-list" class="autocomplete-list" style="display: none;"></ul>
          </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button type="submit" class="btn edit">Guardar</button>
        <button type="button" id="f-reset" class="btn copy">Reset</button>
      </div>

    </form>
  </div>
</section>

<section id="section-ajustes" style="display:none">
  <div class="card-form">
    <h3>Ajustes de la Aplicaci√≥n</h3>
    
    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--accent);">Gesti√≥n de Datos (CSV)</h4>
    <div style="display:flex; gap: 10px; flex-wrap: wrap;">
        <button id="btn-export-csv-settings" class="btn export">Exportar CSV üì•</button>
        <button id="btn-import-csv" class="btn edit">Importar CSV üì§</button>
        <input type="file" id="file-import-csv" accept=".csv" style="display:none;" />
    </div>

    <h4 style="margin-top: 30px; margin-bottom: 10px; color: var(--red);">Sesi√≥n</h4>
    <button id="nav-logout-settings" class="btn delete">Cerrar Sesi√≥n üîí</button>
  </div>
</section>

</main>

<footer></footer>

</div>

<div id="modal" class="modal">
  <div class="modal-inner">
    <h3 id="modal-title">Editar cliente</h3>
    
    <div id="edit-form-scroll-wrapper">
        <form id="form-edit">

          <label>Nombre</label>
          <input type="text" id="e-nombre" required />
          
          <label>Tel√©fono (Ej: 34600123456)</label>
          <input type="text" id="e-telefono" placeholder="C√≥digo de pa√≠s + n√∫mero (sin espacios)" />

          <div class="row">
            <div>
              <label>Fecha de creaci√≥n</label>
              <input type="date" id="e-creacion" required />
            </div>
            <div>
              <label>Caducidad</label>
              <input type="date" id="e-caducidad" required />
            </div>
          </div>

          <label>Usuario</label>
          <input type="text" id="e-usuario" />

          <label>Contrase√±a</label>
          <input type="text" id="e-contrasena" />

          <label>Dispositivo utilizado</label>
          <input type="text" id="e-dispositivo" />

          <label>Aplicaci√≥n</label>
          <select id="e-aplicacion">
            <option value="Spinning TV">Spinning TV</option>
            <option value="Spinning IBO">Spinning IBO</option>
            <option value="Spinning Mate">Spinning Mate</option>
            <option value="Hot Player">Hot Player</option>
          </select>

          <label>Observaciones</label>
          <textarea id="e-observaciones" placeholder="Notas importantes sobre el cliente..."></textarea>

          <label>Clientes recomendados (Solo clientes existentes)</label>
          <div id="e-recomendaciones-container" class="dynamic-input-container">
              <div id="e-recommended-clients" class="tag-list"></div>
              <div class="input-add-row">
                  <input type="text" id="e-new-recommendation" placeholder="Escribe un nombre de cliente existente" />
                  <button type="button" class="btn copy" id="e-add-recommendation-btn">+</button>
                  <ul id="e-autocomplete-list" class="autocomplete-list" style="display: none;"></ul>
               </div>
          </div>

          </form>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;justify-content:space-between; flex-wrap: wrap;">
      <button type="button" id="btn-history-open" class="btn history">Ver Historial</button>
      <div style="display:flex;gap:8px; flex-wrap: wrap;">
        <button type="button" id="modal-cancel" class="btn copy">Cancelar</button>
        <button type="button" id="modal-save" class="btn edit">Guardar cambios</button>
      </div>
    </div>
  </div>
</div>

<div id="history-modal" class="modal">
  <div class="modal-inner history">
    <h3 id="history-modal-title">Historial de Renovaciones</h3>
    <div id="history-list" style="max-height: 400px; overflow-y: auto;">
        </div>
    <div style="text-align: right; margin-top: 15px;">
        <button type="button" id="history-modal-close" class="btn copy">Cerrar</button>
    </div>
  </div>
</div>

<div id="notifications-container"></div>


<script type="module">

// --- CONFIG FIREBASE ---
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import {
  getFirestore, collection, addDoc, doc, onSnapshot,
  updateDoc, deleteDoc, query, orderBy, getDocs, where // <-- A√ëADIDO 'where'
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

import { 
    getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';


// NOTA: Recuerda que debes reemplazar la configuraci√≥n de Firebase con tus claves reales.
const firebaseConfig = {
  apiKey: "AIzaSyCA2fZvN8WVKWwEDL0z694C2o5190OMhq8",
  authDomain: "gestioncandy-b9356.firebaseapp.com",
  projectId: "gestioncandy-b9356",
  storageBucket: "gestioncandy-b9356.firebaseapp.com",
  messagingSenderId: "869982852654",
  appId: "1:869982852654:web:ac450321a746e62365f1bf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); 

// --- ELEMENTOS UI DE LA APLICACI√ìN ---
const appContainer = document.getElementById('app-container'); 
const sectionLogin = document.getElementById('section-login');
const formLogin = document.getElementById('form-login');
const loginErrorMessage = document.getElementById('login-error-message');

// ELEMENTOS DE NAVEGACI√ìN
const navDashboard = document.getElementById('nav-dashboard');
const navClientes = document.getElementById('nav-clientes');
const navAdd = document.getElementById('nav-add');
const navAjustes = document.getElementById('nav-ajustes');

// ELEMENTOS DE AJUSTES (MOVIDOS)
const navLogout = document.getElementById('nav-logout-settings'); 
const btnExportCSV = document.getElementById('btn-export-csv-settings'); 
const btnImportCSV = document.getElementById('btn-import-csv'); 
const fileImportCSV = document.getElementById('file-import-csv'); 

// SECCIONES PRINCIPALES
const sectionDashboard = document.getElementById('section-dashboard');
const sectionClientes = document.getElementById('section-clientes');
const sectionAdd = document.getElementById('section-add');
const sectionAjustes = document.getElementById('section-ajustes');

// FORM ADD
const formAdd = document.getElementById('form-add');
const fReset = document.getElementById('f-reset');
const fCreacion = document.getElementById('f-creacion');
const fCaducidad = document.getElementById('f-caducidad'); 
const fNewRecommendation = document.getElementById('f-new-recommendation');
const fAddRecommendationBtn = document.getElementById('f-add-recommendation-btn');
const fRecommendedClientsDiv = document.getElementById('f-recommended-clients');
const fAutocompleteList = document.getElementById('f-autocomplete-list');
const fObservaciones = document.getElementById('f-observaciones'); 

// FORM EDIT
const formEdit = document.getElementById('form-edit');
const modal = document.getElementById('modal');
const modalCancel = document.getElementById('modal-cancel');
const modalSaveBtn = document.getElementById('modal-save'); 
const eNewRecommendation = document.getElementById('e-new-recommendation');
const eAddRecommendationBtn = document.getElementById('e-add-recommendation-btn');
const eRecommendedClientsDiv = document.getElementById('e-recommended-clients');
const eAutocompleteList = document.getElementById('e-autocomplete-list');
const eObservaciones = document.getElementById('e-observaciones'); 

// HISTORIAL MODAL
const historyModal = document.getElementById('history-modal');
const historyModalClose = document.getElementById('history-modal-close');
const historyList = document.getElementById('history-list');

// VARIABLES GLOBALES
let cachedList = []; 
let currentRecommendations = []; 
let cachedClientNames = new Set(); 
const col = collection(db, "clientes");
let clientDataListener;
let dataListenerActive = false;

// --- FUNCIONES AUXILIARES ---

function getNewCaducidad(currentDate, months) {
    let date = currentDate ? new Date(currentDate) : new Date();
    let newDate = new Date(date);
    newDate.setMonth(newDate.getMonth() + months);
    if (newDate.getDate() < date.getDate()) {
        newDate.setDate(0); 
    }
    return newDate.toISOString();
}

function formatDate(d){
  if(!d) return '-';
  const dt = new Date(d);
  if(isNaN(dt.getTime())) return d;
  return dt.toLocaleDateString();
}

function isoForInput(d){
  if(!d) return '';
  const t = new Date(d);
  if(isNaN(t.getTime())) return '';
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth()+1).padStart(2,'0');
  const dd = String(t.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function showNotification(title, message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
  
  const notificationsContainer = document.getElementById('notifications-container');
  notificationsContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);

  setTimeout(() => {
    toast.classList.remove('show');
    toast.addEventListener('transitionend', () => toast.remove());
  }, 4000);
}

function setDefaultDates() {
    const today = new Date();
    const caducidad3Months = getNewCaducidad(today, 3);

    fCreacion.value = isoForInput(today);
    fCaducidad.value = isoForInput(caducidad3Months);
}
setDefaultDates(); 

fCreacion.addEventListener('change', () => {
    const newCreationDate = fCreacion.value;
    if (newCreationDate) {
        const newCaducidad = getNewCaducidad(newCreationDate, 3);
        fCaducidad.value = isoForInput(newCaducidad);
    }
});


function setActive(btn){
  document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  sectionDashboard.style.display = 'none';
  sectionClientes.style.display = 'none';
  sectionAdd.style.display = 'none';
  sectionAjustes.style.display = 'none';

  if(btn === navDashboard){
    sectionDashboard.style.display = 'block';
  } else if (btn === navClientes){
    sectionClientes.style.display = 'block';
    // Cuando se navega a Clientes, si no hay un filtro activo, se renderiza la lista completa
    if (!document.getElementById('search-input').value) {
        // Al entrar a la pesta√±a Clientes sin b√∫squeda, resetea el filtro de estado
        renderClients(cachedList, null); 
    } else {
        filterClients(document.getElementById('search-input').value);
    }
  } else if (btn === navAdd){
    sectionAdd.style.display = 'block';
    setDefaultDates(); 
  } else if (btn === navAjustes) {
    sectionAjustes.style.display = 'block';
  }
}

navDashboard.addEventListener('click', ()=>setActive(navDashboard));
navClientes.addEventListener('click', ()=>setActive(navClientes));
navAdd.addEventListener('click', ()=>setActive(navAdd));
navAjustes.addEventListener('click', ()=>setActive(navAjustes));

// --- L√ìGICA DE FILTRADO DEL DASHBOARD ---

document.getElementById('stat-expired-link').addEventListener('click', () => filterClientsByStatus('expired'));
document.getElementById('stat-3days-link').addEventListener('click', () => filterClientsByStatus('soon'));

function filterClientsByStatus(status) {
    const now = new Date();
    now.setHours(0,0,0,0);
    const limit3Days = new Date(now);
    limit3Days.setDate(limit3Days.getDate() + 3);
    limit3Days.setHours(23,59,59,999);

    let filteredList = [];
    if (status === 'expired') {
        filteredList = cachedList.filter(i => {
            if(!i.caducidad) return false;
            const d = new Date(i.caducidad);
            return d < now;
        });
    } else if (status === 'soon') {
        filteredList = cachedList.filter(i => {
            if(!i.caducidad) return false;
            const d = new Date(i.caducidad);
            return d >= now && d <= limit3Days;
        });
    }

    // Limpiar la barra de b√∫squeda y activar la vista de Clientes
    document.getElementById('search-input').value = '';
    setActive(navClientes); 

    // Renderizar con el filtro de estado activo
    renderClients(filteredList, status); 
}


// --- AUTENTICACI√ìN Y GESTI√ìN DE ESTADO ---

formLogin.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginErrorMessage.textContent = ''; 
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
        await signInWithEmailAndPassword(auth, email, password);
        showNotification("√âxito", "Sesi√≥n iniciada correctamente.", 'success');
    } catch (error) {
        let errorMessage = "Error al iniciar sesi√≥n. Verifica el email y la contrase√±a.";
        console.error("Firebase Auth Error:", error.code, error.message);
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
            errorMessage = "Credenciales inv√°lidas. Usuario o contrase√±a incorrectos.";
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = "Formato de correo electr√≥nico inv√°lido.";
        }
        loginErrorMessage.textContent = errorMessage; 
    }
});

// Listener para el bot√≥n de Cerrar Sesi√≥n en Ajustes
navLogout.addEventListener('click', async () => {
    try {
        await signOut(auth);
        showNotification("Sesi√≥n cerrada", "Has cerrado la sesi√≥n.", 'success');
        if (clientDataListener) clientDataListener(); 
        dataListenerActive = false;
    } catch (error) {
        showNotification("Error", "No se pudo cerrar la sesi√≥n.", 'error');
        console.error("Logout Error:", error);
    }
});

onAuthStateChanged(auth, (user) => {
    if (user) {
        sectionLogin.classList.remove('show');
        appContainer.style.display = 'block';
        if (!dataListenerActive) {
            startDataListener(); 
            dataListenerActive = true;
        }
    } else {
        sectionLogin.classList.add('show');
        appContainer.style.display = 'none';
        setActive(navDashboard);
    }
});

// --- CARGA DE CLIENTES EN TIEMPO REAL (Listener) ---

function startDataListener() {
    const user = auth.currentUser;
    if (!user) {
        console.warn("No hay usuario autenticado. No se cargan los datos.");
        // Si no hay usuario, limpiar listas para asegurar que la vista est√© vac√≠a.
        cachedList = []; 
        cachedClientNames.clear();
        updateStats(cachedList);
        renderDashboard(cachedList);
        filterClients('');
        return; 
    }

    // FILTRO CLAVE: Solo carga documentos donde el campo 'userId' sea igual al UID del usuario
    const q = query(
        col, 
        where("userId", "==", user.uid), // <-- FILTRO MULTIUSUARIO
        orderBy("caducidad", "asc")
    );

    clientDataListener = onSnapshot(q, (snapshot) => {
        cachedList = [];
        cachedClientNames.clear(); 
        snapshot.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            cachedList.push(data);
            if(data.nombre) cachedClientNames.add(data.nombre);
        });

        updateStats(cachedList);
        renderDashboard(cachedList);
        filterClients(document.getElementById('search-input').value);
        // Inicializar la l√≥gica de recomendaciones despu√©s de cargar los nombres
        setupRecommendationInput(fNewRecommendation, fAddRecommendationBtn, fRecommendedClientsDiv, fAutocompleteList);
        setupRecommendationInput(eNewRecommendation, eAddRecommendationBtn, eRecommendedClientsDiv, eAutocompleteList);

    }, (error) => {
        console.error("Error al obtener datos:", error);
        showNotification("Error de Datos", "No se pudieron cargar los datos de Firestore.", 'error');
    });
}

// --- L√ìGICA CSV: EXPORTACI√ìN E IMPORTACI√ìN ---

// L√≥gica para analizar una l√≠nea CSV. Asume separador ';'.
function parseCSVLine(line, separator = ';') {
    // Implementaci√≥n mejorada para manejar comillas correctamente, aunque simple para el contexto.
    const parts = line.split(separator).map(part => part.trim().replace(/^"|"$/g, ''));
    // Deber√≠a ser suficiente para el formato simple que manejamos
    return parts;
}


async function importFromCSV(file) {
    const reader = new FileReader();
    const user = auth.currentUser;
    
    if (!user) {
        showNotification("Error", "Debes estar logueado para importar clientes.", 'error');
        return;
    }

    reader.onload = async (event) => {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim() !== '');

        if (lines.length <= 1) { 
            showNotification("Error de Importaci√≥n", "El archivo CSV est√° vac√≠o o solo contiene la cabecera.", 'error');
            return;
        }

        const today = isoForInput(new Date());
        let importedCount = 0;
        let errorCount = 0;
        
        // El bucle empieza en la l√≠nea 1 (√≠ndice 1) para saltar la cabecera
        for (let i = 1; i < lines.length; i++) {
            const row = parseCSVLine(lines[i]);
            
            // Validar que haya al menos 4 columnas (Nombre, Usuario, Contrase√±a, Caducidad)
            if (row.length < 4 || !row[0] || !row[3]) { 
                console.warn(`L√≠nea ${i + 1} saltada por datos incompletos o formato incorrecto:`, lines[i]);
                errorCount++;
                continue; 
            }

            const clientData = {
                // Campos proporcionados por el usuario
                nombre: row[0] || 'Cliente Sin Nombre',
                usuario: row[1] || '',
                contrasena: row[2] || '',
                caducidad: row[3], // Se espera formato YYYY-MM-DD

                // Campos que reciben valores por defecto (o vac√≠os si no est√°n en el CSV)
                telefono: '',
                creacion: today, 
                dispositivo: '',
                aplicacion: 'Spinning TV', // Valor por defecto
                observaciones: '', // NUEVO: Valor por defecto
                recomendaciones: [],
                renovara: false,
                userId: user.uid // <-- CAMBIO CR√çTICO: Asignar el UID del usuario
            };
            
            // Validaci√≥n b√°sica del formato de la fecha de caducidad (YYYY-MM-DD)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(clientData.caducidad)) {
                 console.warn(`L√≠nea ${i + 1} saltada: Formato de fecha de caducidad incorrecto (${clientData.caducidad}). Debe ser YYYY-MM-DD.`);
                 errorCount++;
                 continue;
            }

            try {
                const docRef = await addDoc(col, clientData);
                
                // Registro de la creaci√≥n en el historial
                await addDoc(collection(db, "clientes", docRef.id, "renovaciones"), {
                    fecha_renovacion: new Date().toISOString(),
                    caducidad_anterior: 'Importaci√≥n CSV',
                    nueva_caducidad: clientData.caducidad,
                    tipo_accion: 'Importaci√≥n CSV', 
                    usuario: user.email // Usar el email del usuario
                });
                
                importedCount++;
            } catch (e) {
                console.error(`Error al a√±adir cliente desde l√≠nea ${i + 1}:`, e);
                errorCount++;
            }
        }
        
        if (importedCount > 0) {
            showNotification("Importaci√≥n Exitosa", `Se han importado ${importedCount} clientes.`, 'success');
        }
        if (errorCount > 0) {
            showNotification("Errores de Importaci√≥n", `No se pudieron importar ${errorCount} filas (revise la consola para detalles).`, 'yellow');
        }
        if (importedCount === 0 && errorCount === 0) {
             showNotification("Informaci√≥n", "No se encontraron datos v√°lidos para importar en el archivo.", 'yellow');
        }
    };

    reader.onerror = () => {
        showNotification("Error de Lectura", "No se pudo leer el archivo CSV.", 'error');
    };

    reader.readAsText(file);
}

// Listener para el bot√≥n de Importar en Ajustes (AHORA FUNCIONAL)
btnImportCSV.addEventListener('click', () => {
    // Al hacer clic en el bot√≥n visible, disparamos el clic en el campo de archivo oculto
    fileImportCSV.click(); 
});

// Listener para el cambio de archivo (maneja la importaci√≥n)
fileImportCSV.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        importFromCSV(file);
    }
    // Resetear el valor del input para que el mismo archivo pueda ser seleccionado de nuevo
    e.target.value = null; 
});


function exportToCSV() {
    if (cachedList.length === 0) {
        showNotification("Error", "No hay datos para exportar.", 'error');
        return;
    }
    // NUEVOS HEADERS CON 'OBSERVACIONES'
    const headers = ["nombre", "usuario", "contrasena", "caducidad", "creacion", "aplicacion", "telefono", "dispositivo", "observaciones", "recomendaciones", "renovara"];
    const separator = ";"; 
    let csvContent = headers.join(separator) + "\n";
    cachedList.forEach(item => {
        // Funci√≥n para limpiar el texto y manejar las comillas dentro de los datos
        const cleanForCSV = (text) => {
            if (!text) return '""';
            // Envuelve en comillas y duplica las comillas internas
            return `"${String(text).replace(/"/g, '""')}"`; 
        };

        const row = [
            cleanForCSV(item.nombre),
            cleanForCSV(item.usuario),
            cleanForCSV(item.contrasena),
            cleanForCSV(isoForInput(item.caducidad)),
            cleanForCSV(isoForInput(item.creacion)),
            cleanForCSV(item.aplicacion),
            cleanForCSV(item.telefono),
            cleanForCSV(item.dispositivo),
            cleanForCSV(item.observaciones), // NUEVO CAMPO
            // Formatear el array de recomendaciones como una cadena separada por '|'
            cleanForCSV(Array.isArray(item.recomendaciones) ? item.recomendaciones.join('|') : ''), 
            cleanForCSV(item.renovara ? 'S√≠' : 'No')
        ].join(separator);
        csvContent += row + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "clientes_export_" + new Date().toISOString().slice(0, 10) + ".csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification("Exportaci√≥n Exitosa", "Datos de clientes exportados a CSV.", 'success');
}

// ASIGNAR LISTENER DE EXPORTACI√ìN
btnExportCSV.addEventListener('click', exportToCSV);


// --- L√ìGICA DE RECOMENDACIONES CON VALIDACI√ìN Y AUTOCOMPLETADO (MEJORADO) ---

function getRecommendationTag(name, containerDiv, input) {
    const tag = document.createElement('span');
    tag.className = 'recommendation-tag';
    tag.innerHTML = `${name}<button type="button" data-name="${name}">x</button>`;
    
    tag.querySelector('button').addEventListener('click', () => {
        currentRecommendations = currentRecommendations.filter(r => r !== name);
        containerDiv.removeChild(tag);
        input.focus();
    });
    return tag;
}

function renderRecommendedClients(recommendations, containerDiv, input) {
    containerDiv.innerHTML = '';
    recommendations.forEach(rec => {
        containerDiv.appendChild(getRecommendationTag(rec, containerDiv, input));
    });
}

function addRecommendation(name, input, containerDiv, listDiv) {
    name = name.trim();
    if (!name) return;

    // VALIDACI√ìN CR√çTICA: El nombre DEBE existir en la lista de clientes (del usuario actual)
    if (!cachedClientNames.has(name)) {
        showNotification("Error de Recomendaci√≥n", `El cliente "${name}" no existe en tu base de datos.`, 'error');
        listDiv.style.display = 'none'; // Ocultar lista
        return;
    }
    
    if (name && !currentRecommendations.includes(name)) {
        currentRecommendations.push(name);
        containerDiv.appendChild(getRecommendationTag(name, containerDiv, input));
        input.value = '';
        listDiv.style.display = 'none'; // Ocultar lista
        showNotification("Recomendaci√≥n A√±adida", `Cliente ${name} a√±adido a las recomendaciones.`, 'success');
    }
    input.value = '';
}

function setupRecommendationInput(input, addBtn, containerDiv, listDiv) {
    let activeItem = -1;

    // Asignar la funci√≥n al bot√≥n de a√±adir
    addBtn.onclick = () => addRecommendation(input.value, input, containerDiv, listDiv);

    // L√≥gica de Autocompletado
    input.addEventListener('input', () => {
        const query = input.value.trim().toLowerCase();
        listDiv.innerHTML = '';
        listDiv.style.display = 'none';
        activeItem = -1;

        if (query.length < 2) return;

        // Filtrar nombres que contengan la consulta y que NO est√©n ya seleccionados
        const suggestions = Array.from(cachedClientNames)
            .filter(name => name.toLowerCase().includes(query) && !currentRecommendations.includes(name))
            .sort((a, b) => a.localeCompare(b));

        if (suggestions.length > 0) {
            suggestions.slice(0, 5).forEach((name, index) => {
                const li = document.createElement('li');
                li.textContent = name;
                li.dataset.name = name;
                
                li.addEventListener('click', () => {
                    input.value = name;
                    addRecommendation(name, input, containerDiv, listDiv);
                });
                listDiv.appendChild(li);
            });
            listDiv.style.display = 'block';
        }
    });

    // Manejar teclado para Autocompletado
    input.addEventListener('keydown', (e) => {
        const items = Array.from(listDiv.querySelectorAll('li'));

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeItem = (activeItem + 1) % items.length;
            items.forEach((item, index) => {
                item.classList.toggle('active', index === activeItem);
                if (index === activeItem) input.value = item.dataset.name;
            });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeItem = (activeItem - 1 + items.length) % items.length;
            items.forEach((item, index) => {
                item.classList.toggle('active', index === activeItem);
                if (index === activeItem) input.value = item.dataset.name;
            });
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeItem !== -1) {
                // Si hay un elemento activo, √∫salo
                addRecommendation(items[activeItem].dataset.name, input, containerDiv, listDiv);
            } else {
                // Si no hay, valida el texto actual del input
                addRecommendation(input.value, input, containerDiv, listDiv);
            }
        }
    });
    
    // Ocultar lista si el foco se pierde y no es un click en la lista
    input.addEventListener('blur', () => {
        setTimeout(() => {
            if (document.activeElement.closest('.autocomplete-list') !== listDiv) {
                listDiv.style.display = 'none';
            }
        }, 150);
    });
}


// --- RESTO DE L√ìGICA (Funciones Auxiliares y Renderizado) ---

function getExpiryStatus(caducidad) {
    if(!caducidad) return '';
    const now = new Date();
    const expiry = new Date(caducidad);
    const diffDays = Math.ceil((expiry.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

    if (diffDays <= 0) return 'status-red';
    if (diffDays <= 7) return 'status-yellow';
    return 'status-green';
}

function updateStats(list) {
    const now = new Date();
    now.setHours(0,0,0,0);
    const limit3Days = new Date(now);
    limit3Days.setDate(limit3Days.getDate() + 3);
    limit3Days.setHours(23,59,59,999);

    const expired = list.filter(i => {
        if(!i.caducidad) return false;
        const d = new Date(i.caducidad);
        return d < now;
    }).length;

    const soonExpiring = list.filter(i => {
        if(!i.caducidad) return false;
        const d = new Date(i.caducidad);
        // Debe ser caducidad >= Hoy y caducidad <= 3 d√≠as, excluyendo los ya caducados
        return d >= now && d <= limit3Days && d > now; 
    }).length;


    document.getElementById('stat-total').textContent = list.length;
    document.getElementById('stat-today-3days').textContent = soonExpiring;
    document.getElementById('stat-expired').textContent = expired;
}

function filterClients(searchTerm = '') {
    const searchInput = document.getElementById('search-input');
    searchTerm = (searchTerm || searchInput.value || '').toLowerCase().trim();

    const filteredList = cachedList.filter(item => {
        return item.nombre.toLowerCase().includes(searchTerm) ||
               (item.usuario && item.usuario.toLowerCase().includes(searchTerm)) ||
               (item.aplicacion && item.aplicacion.toLowerCase().includes(searchTerm)) ||
               (item.observaciones && item.observaciones.toLowerCase().includes(searchTerm)) || 
               (item.recomendaciones && Array.isArray(item.recomendaciones) && item.recomendaciones.some(rec => rec.toLowerCase().includes(searchTerm)));
    });

    // Al filtrar por b√∫squeda, el estado es nulo
    renderClients(filteredList, null, searchTerm);
}

document.getElementById('search-input').addEventListener('input', () => filterClients());


window.toggleRenovara = async function(checkbox) {
    const id = checkbox.dataset.id;
    const renovara = checkbox.checked;
    try {
        await updateDoc(doc(db, "clientes", id), { renovara });
        showNotification("Estado Actualizado", `Estado 'Renovar√°' cambiado a ${renovara}.`, 'success');
    } catch (error) {
        showNotification("Error", "No se pudo actualizar el estado.", 'error');
        console.error("Error toggling renovara:", error);
    }
}


// *** FUNCI√ìN CLAVE: RENDERIZADO DEL DASHBOARD ***
function renderDashboard(list){
  const now = new Date();
  now.setHours(0,0,0,0);
  const limit = new Date(now);
  limit.setDate(limit.getDate() + 3);
  limit.setHours(23,59,59,999);
  const soon = list.filter(i => {
    if(!i.caducidad) return false;
    const d = new Date(i.caducidad);
    return d >= now && d <= limit && d > now;
  });

  const dashboardSoonExp = document.getElementById('dashboard-soon-exp');
  dashboardSoonExp.innerHTML = `<p class="meta" style="grid-column: 1 / -1; margin-bottom: 0;">Clientes que caducan en los pr√≥ximos 3 d√≠as (${soon.length}):</p>`;

  if (soon.length === 0) {
      dashboardSoonExp.innerHTML += '<p style="grid-column: 1 / -1; color: var(--muted); margin-top: 10px;">No hay clientes pr√≥ximos a caducar.</p>';
  }

  soon.forEach(item => {
    const isRenewing = item.renovara === true ? 'checked' : '';
    
    // L√ìGICA DE CONDICI√ìN PARA BOT√ìN MES GRATIS
    const clientRecommendations = Array.isArray(item.recomendaciones) ? item.recomendaciones : [];
    const isRecommendedByThree = clientRecommendations.length === 3;
    const freeMonthBtn = isRecommendedByThree ? 
        `<button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>` : 
        `<button class="btn free-month" disabled title="Requiere 3 recomendaciones v√°lidas.">Mes gratis</button>`;

    const whatsappBtn = item.telefono && item.telefono.length > 5 ? 
        `<button class="btn whatsapp-alert" onclick="sendWhatsappAlert('${item.id}')">¬°Avisar! üí¨</button>` : '';

    const card = document.createElement('div');
    card.className = "card exp-card";
    card.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
      <div class="flex-end">
        <label for="renew-${item.id}">Renovar√°</label>
        <input type="checkbox" id="renew-${item.id}" data-id="${item.id}" ${isRenewing} onclick="toggleRenovara(this)" />
      </div>
      <div class="btns">
        <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
        ${freeMonthBtn}
        <button class="btn copy" onclick="copyCredentials('${item.id}')">Copiar</button>
        ${whatsappBtn}
      </div>
    `;
    dashboardSoonExp.appendChild(card);
  });
}

window.sendWhatsappAlert = function(id) {
    const item = cachedList.find(i => i.id === id);
    if (!item || !item.telefono || item.telefono.length < 6) {
        showNotification("Error", "Tel√©fono no v√°lido o faltante.", 'error');
        return;
    }

    const message = encodeURIComponent(`Hola ${item.nombre || ''}. Tu suscripci√≥n va a caducar pronto, ¬øvas a querer renovar? üôÇ`);
    const phone = item.telefono.replace(/\s/g, '').replace(/\+/g, '');
    
    const whatsappUrl = `https://wa.me/${phone}?text=${message}`;
    
    window.open(whatsappUrl, '_blank');
    
    showNotification("Alerta enviada", `Se abri√≥ WhatsApp para enviar mensaje a ${item.nombre}.`, 'success');
}

window.addFreeMonth = async function(id) {
    const item = cachedList.find(i => i.id === id);
    if(!item) return;
    
    const clientRecommendations = Array.isArray(item.recomendaciones) ? item.recomendaciones : [];
    
    // DOBLE CHECK: Solo si tiene 3 recomendaciones
    if (clientRecommendations.length !== 3) {
         showNotification("Error", "La promoci√≥n de Mes Gratis requiere exactamente 3 clientes recomendados.", 'error');
         return;
    }

    const oldCaducidad = item.caducidad;
    const newCaducidad = getNewCaducidad(oldCaducidad, 1); // Sumar 1 mes
    const user = auth.currentUser;

    try {
        await updateDoc(doc(db, "clientes", id), {
            caducidad: newCaducidad
        });

        await addDoc(collection(db, "clientes", id, "renovaciones"), {
            fecha_renovacion: new Date().toISOString(),
            caducidad_anterior: oldCaducidad || 'Fecha no registrada',
            nueva_caducidad: newCaducidad,
            tipo_accion: 'Mes Gratis (3 Recom.)', // Diferenciar la acci√≥n
            usuario: user ? user.email : 'Usuario Desconocido'
        });

        showNotification("Mes Gratis A√±adido", `Cliente ${item.nombre} extendido por 1 mes.`, 'success');
    } catch (error) {
        showNotification("Error", "No se pudo a√±adir el mes gratis.", 'error');
        console.error("Error adding free month:", error);
    }
}


window.renewItem = async function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  const oldCaducidad = item.caducidad;
  const newCaducidad = getNewCaducidad(oldCaducidad, 3); // Sumar 3 meses
  const user = auth.currentUser;

  try {
      await updateDoc(doc(db, "clientes", id), {
        caducidad: newCaducidad
      });

      await addDoc(collection(db, "clientes", id, "renovaciones"), {
          fecha_renovacion: new Date().toISOString(),
          caducidad_anterior: oldCaducidad || 'Fecha no registrada',
          nueva_caducidad: newCaducidad,
          tipo_accion: 'Renovaci√≥n Normal (+3 meses)', 
          usuario: user ? user.email : 'Usuario Desconocido'
      });

      showNotification("Renovaci√≥n Exitosa", "Cliente renovado por 3 meses y registro guardado.", 'success');
  } catch (error) {
      showNotification("Error de Renovaci√≥n", "No se pudo renovar el cliente.", 'error');
      console.error("Error renewing item:", error);
  }
}

// *** FUNCI√ìN ACTUALIZADA: COPIAR SOLO DATOS ESPEC√çFICOS ***
window.copyCredentials = function(id) {
    const item = cachedList.find(i => i.id === id);
    if (!item || !item.contrasena) {
        showNotification("Error", "No hay datos suficientes para copiar (falta contrase√±a).", 'error');
        return;
    }

    // Formatear el texto a copiar SOLO con: Usuario, Contrase√±a, Fecha de caducidad, Aplicacion
    const formattedText = `
[Credenciales de Cliente]
Usuario: ${item.usuario || 'N/A'}
Contrase√±a: ${item.contrasena}
Aplicaci√≥n: ${item.aplicacion || 'N/A'}
Caducidad: ${formatDate(item.caducidad)}
`;
    
    navigator.clipboard.writeText(formattedText.trim())
        .then(() => showNotification("Credenciales Copiadas", `Datos de ${item.nombre} (Usuario, Contrase√±a, Caducidad, App) copiados.`, 'success'))
        .catch(err => {
            console.error('Error al copiar: ', err);
            showNotification("Error", "Error al copiar al portapapeles.", 'error');
        });
}


// *** FUNCI√ìN CLAVE: RENDERIZADO DE CLIENTES ***
function renderClients(list, status = null, searchTerm = ''){
  const clientsGrid = document.getElementById('clients-grid');
  const h3Element = document.getElementById('clients-header-h3');

  // 1. Manejar el t√≠tulo y el estilo seg√∫n el filtro de estado
  h3Element.textContent = 'Clientes';
  h3Element.style.color = 'inherit';

  if (status === 'expired') {
      h3Element.textContent = `Clientes Caducados üî¥ (${list.length})`;
      h3Element.style.color = 'var(--red)';
  } else if (status === 'soon') {
      h3Element.textContent = `Clientes que Caducan Pronto (3 d√≠as) üü° (${list.length})`;
      h3Element.style.color = 'var(--yellow)';
  } else if (searchTerm) {
      h3Element.textContent = `Clientes (Resultados de B√∫squeda: ${list.length})`;
  } else {
      h3Element.textContent = `Clientes (${list.length})`;
  }

  // 2. Renderizar las tarjetas
  clientsGrid.innerHTML = "";
  if (list.length === 0) {
       clientsGrid.innerHTML = `<p style="grid-column: 1 / -1; color: var(--muted); margin-top: 10px;">${searchTerm ? 'No se encontraron resultados para la b√∫squeda.' : status ? 'No hay clientes en este estado.' : 'No hay clientes registrados.'}</p>`;
  }


  list.forEach(item => {
    let recommendationsHTML = '';
    
    // CORRECCI√ìN: Aseguramos que el campo es un array
    let clientRecommendations = item.recomendaciones;
    if (!Array.isArray(clientRecommendations)) {
        clientRecommendations = []; 
    }
    
    // L√ìGICA DE CONDICI√ìN PARA BOT√ìN MES GRATIS
    const isRecommendedByThree = clientRecommendations.length === 3;
    const freeMonthBtn = isRecommendedByThree ? 
        `<button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>` : 
        `<button class="btn free-month" disabled title="Requiere 3 recomendaciones v√°lidas.">Mes gratis</button>`;


    if (clientRecommendations.length > 0) { 
        recommendationsHTML = `<div class="tags" style="margin-top:8px">`;
        
        clientRecommendations.forEach(rec => {
            recommendationsHTML += `<span class="tag-label">${rec}</span>`;
        });
        recommendationsHTML += `</div>`;
    }
    
    const statusClass = getExpiryStatus(item.caducidad);

    const card = document.createElement('div');
    card.className = `card ${statusClass}`;
    card.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="meta">Tel√©fono: ${item.telefono || "-"}</div>
      <div class="meta">App: ${item.aplicacion || "-"}</div>
      <div class="meta">Creaci√≥n: ${formatDate(item.creacion)}</div>
      <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
      ${item.observaciones ? `<div class="meta" style="margin-top: 5px;">Obs: ${item.observaciones}</div>` : ''} 
      ${recommendationsHTML}

      <div class="btns">
        <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
        <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
        ${freeMonthBtn}
        <button class="btn copy" onclick="copyCredentials('${item.id}')">Copiar</button>
        <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
      </div>
    `;
    clientsGrid.appendChild(card);
  });
}

window.deleteItem = async function(id) {
    if (!confirm("¬øEst√°s seguro de que quieres eliminar este cliente?")) return;
    try {
        await deleteDoc(doc(db, "clientes", id));
        showNotification("Eliminado", "Cliente eliminado con √©xito.", 'success');
    } catch (error) {
        showNotification("Error", "No se pudo eliminar el cliente.", 'error');
        console.error("Error deleting item:", error);
    }
}

window.openEdit = function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  currentRecommendations = Array.isArray(item.recomendaciones) ? [...item.recomendaciones] : [];
  // Usa la funci√≥n de renderizado que ahora requiere el elemento input (e-new-recommendation)
  renderRecommendedClients(currentRecommendations, eRecommendedClientsDiv, eNewRecommendation); 
  
  document.getElementById('e-nombre').value = item.nombre;
  document.getElementById('e-telefono').value = item.telefono || ""; 
  document.getElementById('e-creacion').value = isoForInput(item.creacion);
  document.getElementById('e-caducidad').value = isoForInput(item.caducidad);
  document.getElementById('e-usuario').value = item.usuario || "";
  document.getElementById('e-contrasena').value = item.contrasena || "";
  document.getElementById('e-dispositivo').value = item.dispositivo || "";
  document.getElementById('e-aplicacion').value = item.aplicacion || ""; 
  document.getElementById('e-observaciones').value = item.observaciones || ""; 
  eNewRecommendation.value = ''; // Limpiar campo de autocompletado

  modal.setAttribute('data-id', id);
  document.getElementById('btn-history-open').onclick = () => openHistoryModal(id);
  document.getElementById('modal').classList.add('show');
};

// *** NUEVO LISTENER PARA EL BOT√ìN "GUARDAR CAMBIOS" (Ahora fijo) ***
modalSaveBtn.addEventListener('click', () => {
    // Esto dispara el evento 'submit' en el formulario. Si hay campos requeridos vac√≠os, el navegador los mostrar√°.
    formEdit.dispatchEvent(new Event('submit', { cancelable: true }));
});

// *** MODIFICADO: FUNCI√ìN DE EDICI√ìN ***
formEdit.addEventListener('submit', async e=>{
  e.preventDefault();
  const id = modal.getAttribute('data-id');
  const user = auth.currentUser;
  
  if(!id || !user) {
    showNotification("Error de Sesi√≥n", "Debes estar logueado para editar clientes.", 'error');
    return;
  }
  
  // No necesitamos el userId del documento aqu√≠, porque el documento ya existe
  // y las reglas de seguridad nos obligan a ser el due√±o para actualizarlo.
  const data = {
    nombre: document.getElementById('e-nombre').value,
    telefono: document.getElementById('e-telefono').value, 
    creacion: document.getElementById('e-creacion').value,
    caducidad: document.getElementById('e-caducidad').value,
    usuario: document.getElementById('e-usuario').value,
    contrasena: document.getElementById('e-contrasena').value,
    dispositivo: document.getElementById('e-dispositivo').value,
    aplicacion: document.getElementById('e-aplicacion').value,
    observaciones: document.getElementById('e-observaciones').value, 
    recomendaciones: currentRecommendations 
  };

  try {
      await updateDoc(doc(db, "clientes", id), data);
      document.getElementById('modal').classList.remove('show');
      showNotification("Guardado", `Cambios en cliente ${data.nombre} guardados.`, 'success');
      currentRecommendations = [];
  } catch (error) {
      showNotification("Error", "No se pudieron guardar los cambios. Verifica tus permisos.", 'error');
      console.error("Error updating item:", error);
  }
});

// *** MODIFICADO: FUNCI√ìN DE A√ëADIR CLIENTE ***
formAdd.addEventListener('submit', async e=>{
  e.preventDefault();

  const user = auth.currentUser;
  if (!user) {
    showNotification("Error de Sesi√≥n", "Debes estar logueado para a√±adir clientes.", 'error');
    return;
  }
  
  const data = {
    nombre: document.getElementById('f-nombre').value,
    telefono: document.getElementById('f-telefono').value, 
    creacion: document.getElementById('f-creacion').value,
    caducidad: document.getElementById('f-caducidad').value,
    usuario: document.getElementById('f-usuario').value,
    contrasena: document.getElementById('f-contrasena').value,
    dispositivo: document.getElementById('f-dispositivo').value,
    aplicacion: document.getElementById('f-aplicacion').value,
    observaciones: document.getElementById('f-observaciones').value, 
    recomendaciones: currentRecommendations, 
    renovara: false,
    userId: user.uid // <-- CAMBIO CR√çTICO: ID del usuario
  };

  try {
      const docRef = await addDoc(col, data);
      
      await addDoc(collection(db, "clientes", docRef.id, "renovaciones"), {
          fecha_renovacion: new Date().toISOString(),
          caducidad_anterior: 'Nuevo Cliente',
          nueva_caducidad: data.caducidad,
          tipo_accion: 'Creaci√≥n (+3 meses)', 
          usuario: user.email // Usar el email del usuario
      });
      
      showNotification("Cliente Creado", `El cliente ${data.nombre} ha sido a√±adido con √©xito.`, 'success');
      
      formAdd.reset();
      setDefaultDates();
      currentRecommendations = [];
      document.getElementById('f-recommended-clients').innerHTML = '';
  } catch (error) {
      showNotification("Error de Creaci√≥n", "No se pudo a√±adir el nuevo cliente.", 'error');
      console.error("Error adding item:", error);
  }
});

fReset.addEventListener('click', ()=> {
    formAdd.reset();
    setDefaultDates();
    currentRecommendations = [];
    document.getElementById('f-recommended-clients').innerHTML = '';
});

// L√≥gica de Modales
modalCancel.addEventListener('click', ()=>{
  modal.classList.remove('show');
});

// L√≥gica de Historial (Abrir y Renderizar)
window.openHistoryModal = async function(clientId) {
    document.getElementById('history-modal-title').textContent = `Historial de Renovaciones`;
    historyList.innerHTML = '<p style="text-align:center; color: var(--muted);">Cargando historial...</p>';
    modal.classList.remove('show');
    historyModal.classList.add('show');

    try {
        const renovacionesCol = collection(db, "clientes", clientId, "renovaciones");
        const q = query(renovacionesCol, orderBy("fecha_renovacion", "desc"));
        const snapshot = await getDocs(q);
        
        const historyData = [];
        snapshot.forEach(doc => {
            historyData.push(doc.data());
        });

        renderRenewalHistory(historyData, historyList);
    } catch (error) {
        console.error("Error al cargar historial:", error);
        historyList.innerHTML = '<p style="text-align:center; color: var(--red);">Error al cargar el historial.</p>';
    }
}

historyModalClose.addEventListener('click', () => {
    historyModal.classList.remove('show');
});

function renderRenewalHistory(historyList, targetDiv) {
    targetDiv.innerHTML = '';
    if (historyList.length === 0) {
        targetDiv.innerHTML = '<p style="text-align:center; color: var(--muted);">No se encontraron registros de renovaci√≥n.</p>';
        return;
    }

    let html = '<div style="display:grid; gap:10px;">';
    historyList.forEach(rec => {
        const actionType = rec.tipo_accion || 'Renovaci√≥n Manual';
        const color = actionType.includes('Gratis') ? 'var(--yellow)' : actionType.includes('Creaci√≥n') ? 'var(--green)' : 'var(--accent)';
        const userDisplay = rec.usuario ? rec.usuario.split('@')[0] : 'Desconocido';

        html += `
            <div class="stat" style="border-left: 4px solid ${color}; padding:10px;">
                <strong>${actionType}</strong>
                <div style="font-size: 13px; color: var(--muted); margin-top: 5px;">
                     Fecha de Registro: ${formatDate(rec.fecha_renovacion)}<br/>
                     Caducidad anterior: ${formatDate(rec.caducidad_anterior)}<br/>
                     Nueva Caducidad: ${formatDate(rec.nueva_caducidad)}
                     <br/>Usuario: ${userDisplay}
                </div>
            </div>
        `;
    });
    html += '</div>';
    targetDiv.innerHTML = html;
}

</script>
</body>
</html>

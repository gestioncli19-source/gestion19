<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--red:#ef4444;--green:#10b981;--yellow:#f59e0b;--whatsapp:#25d366;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0;margin-bottom:20px;border-bottom:1px solid var(--glass)}
    header h1{font-size:1.8rem;font-weight:700;color:var(--accent);margin:0}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
    .stat{background-color:var(--card);padding:15px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.2);border:1px solid var(--glass);transition:transform 0.2s}
    .stat:hover{transform:translateY(-2px)}
    .stat h3{margin:0 0 5px 0;font-size:1rem;color:var(--muted);text-transform:uppercase}
    .stat p{margin:0;font-size:2rem;font-weight:700;line-height:1}
    .stat.expiring p{color:var(--red)}
    .stat.active p{color:var(--green)}
    .stat.total p{color:var(--accent)}
    .stat.free p{color:var(--yellow)}

    .controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;gap:15px;flex-wrap:wrap}
    .search-input{padding:10px 15px;border-radius:8px;border:1px solid var(--glass);background:var(--card);color:#e6eef6;width:100%;max-width:300px}

    .btn{padding:10px 15px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color 0.2s, transform 0.1s}
    .btn.primary{background-color:var(--accent);color:var(--bg)}
    .btn.primary:hover{background-color:#4ade80}
    .btn.secondary{background-color:var(--muted);color:var(--bg)}
    .btn.secondary:hover{background-color:#7f90a8}
    .btn.whatsapp{background-color:var(--whatsapp);color:white;}
    .btn.whatsapp:hover{background-color:#1c9a4d;}
    .btn:active{transform:scale(0.98)}

    .clients-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:40px}
    .card{background-color:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 10px rgba(0,0,0,0.3);border-left:4px solid var(--glass);display:flex;flex-direction:column}
    .card h4{margin-top:0;font-size:1.2rem;color:var(--e6eef6)}
    .card .meta{font-size:0.9rem;color:var(--muted);margin-bottom:5px}
    .card .btns{margin-top:15px;display:flex;flex-wrap:wrap;gap:8px}
    .card .btn{flex-grow:1;min-width:70px}
    .card.expiring{border-left-color:var(--red)}
    .card.expiring h4{color:var(--red)}
    .card.active{border-left-color:var(--green)}
    .card.free{border-left-color:var(--yellow)}

    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:100}
    .modal-content{background-color:var(--bg);padding:30px;border-radius:12px;width:90%;max-width:600px;box-shadow:0 10px 25px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto}
    .modal h3{color:var(--accent);margin-top:0;border-bottom:1px solid var(--glass);padding-bottom:10px}
    .modal label{display:block;margin-top:15px;margin-bottom:5px;font-weight:600;color:var(--muted)}
    .modal input[type="text"], .modal input[type="tel"], .modal input[type="date"], .modal textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--glass);background:var(--card);color:#e6eef6}
    .modal textarea{min-height:80px}
    .modal .btns{margin-top:20px;display:flex;gap:10px}
    .modal .btns .btn{flex-grow:1}

    .notification-container{position:fixed;bottom:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:10px}
    .notification{padding:15px 20px;border-radius:8px;color:white;box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s ease-in-out, transform 0.3s ease-in-out;transform:translateX(100%)}
    .notification.show{opacity:1;transform:translateX(0)}
    .notification.success{background-color:var(--green)}
    .notification.error{background-color:var(--red)}
    .notification.warning{background-color:var(--yellow)}

    .history-stat{background-color:var(--card);padding:10px;border-radius:8px;border:1px solid var(--glass)}
    .history-stat h5{margin:0 0 5px 0;color:var(--accent)}

    @media (max-width: 600px) {
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
        .search-input {
            max-width: none;
            order: 2;
        }
        .btn.primary, .btn.secondary {
            width: 100%;
            order: 1;
        }
        .card .btns {
            flex-direction: column;
        }
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Gestor de Clientes</h1>
      <button class="btn primary" onclick="document.getElementById('add-modal').style.display='flex'">+ Nuevo Cliente</button>
    </header>

    <!-- Controles y Estadísticas -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat total"><h3>Total Clientes</h3><p id="stat-total">0</p></div>
      <div class="stat active"><h3>Clientes Activos</h3><p id="stat-active">0</p></div>
      <div class="stat expiring"><h3>A Punto de Caducar</h3><p id="stat-expiring">0</p></div>
      <div class="stat free"><h3>Mes Gratis</h3><p id="stat-free">0</p></div>
    </div>

    <div class="controls">
      <input type="text" id="search-input" class="search-input" placeholder="Buscar por nombre, usuario, o app..." />
      <div style="display: flex; gap: 10px;">
        <button class="btn secondary" onclick="filterClients('all')">Todos</button>
        <button class="btn secondary" onclick="filterClients('expiring')">Caducando</button>
        <button class="btn secondary" onclick="filterClients('free')">Gratis</button>
      </div>
    </div>

    <!-- Grid de Clientes -->
    <div class="clients-grid" id="clients-grid">
      <p style="text-align:center; color: var(--muted); width: 100%;">Cargando clientes...</p>
    </div>
  </div>

  <!-- Modal de Añadir -->
  <div id="add-modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
      <h3>Añadir Nuevo Cliente</h3>
      <form id="add-client-form" onsubmit="handleAddSubmit(event)">
        <label for="f-nombre">Nombre:</label>
        <input type="text" id="f-nombre" name="nombre" required>

        <label for="f-telefono">Teléfono (opcional):</label>
        <input type="tel" id="f-telefono" name="telefono">

        <label for="f-aplicacion">Aplicación:</label>
        <input type="text" id="f-aplicacion" name="aplicacion" required>

        <label for="f-usuario">Usuario/Email:</label>
        <input type="text" id="f-usuario" name="usuario" required>

        <label for="f-contrasena">Contraseña:</label>
        <input type="text" id="f-contrasena" name="contrasena" required>

        <label for="f-caducidad">Fecha de Caducidad:</label>
        <input type="date" id="f-caducidad" name="caducidad" required>

        <label for="f-notas">Notas (opcional):</label>
        <textarea id="f-notas" name="notas"></textarea>

        <div class="btns">
          <button type="submit" id="client-form-submit" class="btn primary">Guardar Cliente</button>
          <button type="button" onclick="closeModal(event)" class="btn secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Edición (IDs CORREGIDOS) -->
  <div id="edit-modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content">
      <h3>Editar Cliente <span id="client-name-display"></span></h3>
      <form id="edit-client-form" onsubmit="handleEditSubmit(event)">
        <!-- Hidden ID - ID CORREGIDO -->
        <input type="hidden" id="edit-f-client-id" name="id">

        <label for="edit-f-nombre">Nombre:</label>
        <input type="text" id="edit-f-nombre" name="nombre" required>

        <label for="edit-f-telefono">Teléfono (opcional):</label>
        <input type="tel" id="edit-f-telefono" name="telefono">

        <label for="edit-f-aplicacion">Aplicación:</label>
        <input type="text" id="edit-f-aplicacion" name="aplicacion" required>

        <label for="edit-f-usuario">Usuario/Email:</label>
        <input type="text" id="edit-f-usuario" name="usuario" required>

        <label for="edit-f-contrasena">Contraseña:</label>
        <input type="text" id="edit-f-contrasena" name="contrasena" required>

        <label for="edit-f-caducidad">Fecha de Caducidad:</label>
        <input type="date" id="edit-f-caducidad" name="caducidad" required>

        <label for="edit-f-notas">Notas (opcional):</label>
        <textarea id="edit-f-notas" name="notas"></textarea>

        <div class="btns">
          <!-- Submit Button - ID CORREGIDO -->
          <button type="submit" id="edit-client-form-submit" class="btn primary">Guardar Cambios</button>
          <button type="button" onclick="closeModal(event)" class="btn secondary">Cancelar</button>
        </div>
      </form>

      <!-- Historial de Renovaciones -->
      <h4>Historial de Renovaciones</h4>
      <div id="renewal-history">
        <p style="text-align:center; color: var(--muted);">Cargando historial...</p>
      </div>
      <!-- Sugerencias de clientes -->
      <h4>Clientes Recomendados para Renovar</h4>
      <div id="f-recommended-clients" style="margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          <p style="text-align:center; color: var(--muted);">Cargando sugerencias...</p>
      </div>
    </div>
  </div>

  <div class="notification-container" id="notification-container"></div>

  <script type="module">
    // Importaciones de Firebase
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, doc, getDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =========================================================================
    // 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE (CORREGIDO Y REFORZADO)
    // =========================================================================

    // Variables de entorno globales (Definición robusta)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth;
    let currentUserId = null;
    let allClients = [];
    let currentFilter = 'all'; // Estado para el filtro actual

    async function initializeFirebase() {
        console.log("Iniciando Firebase...");
        setLogLevel('debug');

        if (!firebaseConfig) {
            console.error("Firebase configuration is missing or invalid. Check __firebase_config variable.");
            showNotification("Error de Configuración", "Falta la configuración de Firebase. Intenta actualizar la página.", 'error');
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Autenticación
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // 2. Listener de Estado de Autenticación
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Usuario autenticado. ID:", currentUserId);
                    // Iniciar listeners de datos SÓLO después de la autenticación
                    startListeners();
                } else {
                    currentUserId = null;
                    console.error("Autenticación fallida o usuario desconectado.");
                }
            });

        } catch (error) {
            console.error("Error durante la inicialización o autenticación de Firebase:", error);
            showNotification("Error Crítico", "No se pudo iniciar Firebase o la autenticación.", 'error');
        }
    }

    // Función de utilidad para obtener la ruta de la colección
    function getUserCollectionPath() {
        if (!currentUserId) {
            console.error("Error: currentUserId no está definido. La autenticación no ha finalizado.");
            // Devolver una ruta de colección inválida para evitar escrituras accidentales
            return 'invalid/collection/path';
        }
        // Usamos la ruta de datos privados
        return `artifacts/${appId}/users/${currentUserId}/clientes`;
    }

    // =========================================================================
    // 2. FUNCIONES DE UTILITY (FECHAS, NOTIFICACIONES)
    // =========================================================================

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      let date;
      if (timestamp.toDate) {
          date = timestamp.toDate();
      } else if (typeof timestamp === 'string' || typeof timestamp === 'number') {
          date = new Date(timestamp);
      } else {
          date = timestamp;
      }
      return date.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatDateForInput(timestamp) {
      if (!timestamp) return '';
      let date;
      if (timestamp.toDate) {
          date = timestamp.toDate();
      } else if (typeof timestamp === 'string' || typeof timestamp === 'number') {
          date = new Date(timestamp);
      } else {
          date = timestamp;
      }

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function showNotification(title, message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `<strong>${title}</strong><br/>${message}`;

      container.appendChild(notification);
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);

      setTimeout(() => {
        notification.classList.remove('show');
        notification.addEventListener('transitionend', () => notification.remove());
      }, 5000);
    }

    function closeModal(event) {
        if (event && event.target.id && (event.target.id !== 'add-modal' && event.target.id !== 'edit-modal')) return;
        document.getElementById('add-modal').style.display = 'none';
        document.getElementById('edit-modal').style.display = 'none';
        document.getElementById('add-client-form').reset();
    }
    window.closeModal = closeModal; // Exponer al window

    // =========================================================================
    // 3. LISTENERS Y PROCESAMIENTO DE DATOS
    // =========================================================================

    function startListeners() {
        const clientsColRef = collection(db, getUserCollectionPath());
        const q = query(clientsColRef); // No usar orderBy para evitar errores de índice, ordenar en cliente.

        onSnapshot(q, (snapshot) => {
            const clientsList = [];
            snapshot.forEach(doc => {
                clientsList.push({ id: doc.id, ...doc.data() });
            });

            // Ordenar por fecha de caducidad más cercana (en el cliente)
            clientsList.sort((a, b) => {
                const dateA = new Date(a.caducidad.toDate ? a.caducidad.toDate() : a.caducidad);
                const dateB = new Date(b.caducidad.toDate ? b.caducidad.toDate() : b.caducidad);
                return dateA - dateB;
            });

            allClients = clientsList;
            updateStats(allClients);
            renderClients(allClients, currentFilter);
        }, (error) => {
            console.error("Error al escuchar clientes:", error);
            showNotification("Error de Datos", "No se pudo cargar la lista de clientes.", 'error');
        });

        // Configurar el listener de búsqueda
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allClients.filter(client =>
                client.nombre.toLowerCase().includes(searchTerm) ||
                (client.usuario && client.usuario.toLowerCase().includes(searchTerm)) ||
                (client.aplicacion && client.aplicacion.toLowerCase().includes(searchTerm))
            );
            renderClients(filtered, currentFilter);
        });
    }

    window.filterClients = function(filter) {
        currentFilter = filter;
        const searchInput = document.getElementById('search-input');
        searchInput.value = ''; // Limpiar búsqueda al filtrar
        renderClients(allClients, currentFilter);
    }

    function updateStats(clients) {
        const today = new Date();
        const oneWeekFromNow = new Date();
        oneWeekFromNow.setDate(today.getDate() + 7);

        const total = clients.length;
        let active = 0;
        let expiring = 0;
        let free = 0;

        clients.forEach(client => {
            const caducidad = client.caducidad.toDate ? client.caducidad.toDate() : new Date(client.caducidad);
            if (caducidad > today) {
                active++;
            }
            if (caducidad >= today && caducidad <= oneWeekFromNow) {
                expiring++;
            }
            if (client.tipo_renovacion === 'gratis') {
                free++;
            }
        });

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-expiring').textContent = expiring;
        document.getElementById('stat-free').textContent = free;
    }

    function renderClients(clients, filter = 'all') {
        const clientsGrid = document.getElementById('clients-grid');
        clientsGrid.innerHTML = '';

        const today = new Date();
        const oneWeekFromNow = new Date();
        oneWeekFromNow.setDate(today.getDate() + 7);

        let filteredClients = clients;

        if (filter === 'expiring') {
            filteredClients = clients.filter(client => {
                const caducidad = client.caducidad.toDate ? client.caducidad.toDate() : new Date(client.caducidad);
                return caducidad >= today && caducidad <= oneWeekFromNow;
            });
        } else if (filter === 'free') {
            filteredClients = clients.filter(client => client.tipo_renovacion === 'gratis');
        }

        if (filteredClients.length === 0) {
            clientsGrid.innerHTML = `<p style="text-align:center; color: var(--muted); width: 100%;">No se encontraron clientes para el filtro actual.</p>`;
            return;
        }

        filteredClients.forEach(item => {
            const caducidadDate = item.caducidad.toDate ? item.caducidad.toDate() : new Date(item.caducidad);
            let statusClass = 'active';
            let statusText = 'Activo';

            if (item.tipo_renovacion === 'gratis') {
                statusClass = 'free';
                statusText = 'Mes Gratis';
            } else if (caducidadDate <= today) {
                statusClass = 'expiring';
                statusText = 'Caducado';
            } else if (caducidadDate <= oneWeekFromNow) {
                statusClass = 'expiring';
                statusText = 'Caduca Pronto';
            }


            let recommendationsHTML = '';
            if (item.recomendados && item.recomendados.length > 0) {
                recommendationsHTML = `<div class="meta" style="color: var(--accent);">Recomendados: ${item.recomendados.join(', ')}</div>`;
            }

            const whatsappMessage = encodeURIComponent(`Hola ${item.nombre}, te escribo por la renovación de tu ${item.aplicacion}. Tu servicio caduca el ${formatDate(item.caducidad)}. Por favor, confirma si deseas renovar.`);
            const whatsappBtn = item.telefono ? `<a class="btn whatsapp" href="https://wa.me/${item.telefono.replace(/\D/g, '')}?text=${whatsappMessage}" target="_blank">WhatsApp</a>` : '';

            const card = document.createElement('div');
            card.className = `card ${statusClass}`;
            card.innerHTML = `
                <h4>${item.nombre} <span style="font-size: 0.8rem; color: var(--muted);">(${statusText})</span></h4>
                <div class="meta">Teléfono: ${item.telefono || "-"}</div>
                <div class="meta">App: ${item.aplicacion || "-"}</div>
                <div class="meta">Usuario: ${item.usuario || "-"}</div>
                <div class="meta">Creación: ${formatDate(item.creacion)}</div>
                <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
                ${recommendationsHTML}

                <div class="btns">
                    <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
                    <button class="btn renew" onclick="renewItem('${item.id}', 'Renovación Manual')">Renovar</button>
                    <button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>
                    <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
                    ${whatsappBtn}
                    <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
                </div>
            `;
            clientsGrid.appendChild(card);
        });
    }

    // =========================================================================
    // 4. FUNCIONES CRUD Y ACCIONES
    // =========================================================================

    window.handleAddSubmit = async function(event) {
        event.preventDefault();
        const form = event.target;

        const data = {
            nombre: form.elements['f-nombre'].value,
            telefono: form.elements['f-telefono'].value || null,
            aplicacion: form.elements['f-aplicacion'].value,
            usuario: form.elements['f-usuario'].value,
            contrasena: form.elements['f-contrasena'].value,
            caducidad: new Date(form.elements['f-caducidad'].value),
            notas: form.elements['f-notas'].value || null,
            creacion: new Date(),
            recomendados: [],
            tipo_renovacion: 'manual',
            historial: [],
            usuario_creacion: auth.currentUser.email || 'Usuario Anónimo'
        };

        try {
            const docRef = await addDoc(collection(db, getUserCollectionPath()), data);
            
            // Añadir el evento de Creación al historial
            const creationRecord = {
                fecha_renovacion: new Date(),
                caducidad_anterior: null,
                nueva_caducidad: data.caducidad,
                tipo_accion: 'Creación Inicial',
                usuario: auth.currentUser.email || 'Usuario Anónimo'
            };

            await updateDoc(docRef, {
                historial: arrayUnion(creationRecord)
            });

            showNotification("Éxito", "Cliente añadido correctamente.", 'success');
            closeModal();
        } catch (error) {
            console.error("Error al añadir el cliente:", error);
            showNotification("Error", "No se pudo añadir el cliente.", 'error');
        }
    }

    // Función para abrir el modal de edición (IDS CORREGIDOS)
    window.openEdit = async function(id) {
        const clientDocRef = doc(db, getUserCollectionPath(), id);
        try {
            const docSnap = await getDoc(clientDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Actualización de campos con IDs corregidos
                document.getElementById('edit-f-client-id').value = id;
                document.getElementById('client-name-display').textContent = data.nombre;
                document.getElementById('edit-f-nombre').value = data.nombre;
                document.getElementById('edit-f-telefono').value = data.telefono || '';
                document.getElementById('edit-f-aplicacion').value = data.aplicacion;
                document.getElementById('edit-f-usuario').value = data.usuario;
                document.getElementById('edit-f-contrasena').value = data.contrasena;
                document.getElementById('edit-f-caducidad').value = formatDateForInput(data.caducidad);
                document.getElementById('edit-f-notas').value = data.notas || '';

                // Renderizar historial de renovaciones
                const historyList = data.historial || [];
                renderRenewalHistory(historyList, document.getElementById('renewal-history'));
                
                // Limpiar recomendaciones al abrir
                document.getElementById('f-recommended-clients').innerHTML = '';

                document.getElementById('edit-modal').style.display = 'flex';
            } else {
                showNotification("Error", "Cliente no encontrado.", 'error');
            }
        } catch (error) {
            console.error("Error al cargar cliente para edición:", error);
            showNotification("Error", "No se pudo cargar la información del cliente.", 'error');
        }
    }

    // Función para manejar el envío del formulario de edición (IDS CORREGIDOS)
    window.handleEditSubmit = async function(event) {
        event.preventDefault();
        
        // Obtener valores de los campos CORREGIDOS
        const id = document.getElementById('edit-f-client-id').value;
        const nombre = document.getElementById('edit-f-nombre').value;
        const telefono = document.getElementById('edit-f-telefono').value;
        const aplicacion = document.getElementById('edit-f-aplicacion').value;
        const usuario = document.getElementById('edit-f-usuario').value;
        const contrasena = document.getElementById('edit-f-contrasena').value;
        const caducidadStr = document.getElementById('edit-f-caducidad').value;
        const notas = document.getElementById('edit-f-notas').value;

        const updatedData = {
            nombre: nombre,
            telefono: telefono || null,
            aplicacion: aplicacion,
            usuario: usuario,
            contrasena: contrasena,
            caducidad: new Date(caducidadStr),
            notas: notas || null,
            // NOTA: Se mantiene el historial y recomendados
        };

        try {
            const clientDocRef = doc(db, getUserCollectionPath(), id);
            await updateDoc(clientDocRef, updatedData);
            showNotification("Actualizado", "Cliente modificado con éxito.", 'success');
            closeModal();
        } catch (error) {
            console.error("Error al actualizar el cliente:", error);
            showNotification("Error", "No se pudo guardar los cambios del cliente.", 'error');
        }
    }

    // Función para copiar contraseña al portapapeles
    window.copyPassword = async function(id) {
        const clientDocRef = doc(db, getUserCollectionPath(), id);
        try {
            const docSnap = await getDoc(clientDocRef);
            if (docSnap.exists()) {
                const password = docSnap.data().contrasena;
                
                // Uso de execCommand('copy') como fallback para iframes
                const textArea = document.createElement("textarea");
                textArea.value = password;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification("Copiado", "Contraseña copiada al portapapeles.", 'success');
                } catch (err) {
                    console.error('Fallback: Error al copiar', err);
                    showNotification("Error", "Fallo al copiar. Intenta copiar manualmente.", 'error');
                }
                document.body.removeChild(textArea);

            }
        } catch (error) {
            console.error("Error al copiar contraseña:", error);
            showNotification("Error", "No se pudo obtener la contraseña.", 'error');
        }
    }

    // Función para renovar (un mes más)
    window.renewItem = async function(id, tipoAccion) {
        const clientDocRef = doc(db, getUserCollectionPath(), id);
        try {
            const docSnap = await getDoc(clientDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const oldCaducidad = data.caducidad.toDate ? data.caducidad.toDate() : new Date(data.caducidad);
                
                // Calcular la nueva fecha de caducidad
                const newCaducidad = new Date(oldCaducidad);
                newCaducidad.setMonth(newCaducidad.getMonth() + 1);

                // Crear el registro de historial
                const renewalRecord = {
                    fecha_renovacion: new Date(),
                    caducidad_anterior: oldCaducidad,
                    nueva_caducidad: newCaducidad,
                    tipo_accion: tipoAccion,
                    usuario: auth.currentUser.email || 'Usuario Anónimo'
                };

                // Actualizar el documento
                await updateDoc(clientDocRef, {
                    caducidad: newCaducidad,
                    tipo_renovacion: tipoAccion.includes('Gratis') ? 'gratis' : 'manual',
                    historial: arrayUnion(renewalRecord)
                });

                showNotification("Renovado", `${data.nombre} renovado por un mes más.`, 'success');
                // Si la acción es renovación simple, limpiamos el tipo_renovacion
                if (!tipoAccion.includes('Gratis')) {
                    await updateDoc(clientDocRef, { tipo_renovacion: 'manual' });
                }
            }
        } catch (error) {
            console.error("Error al renovar el cliente:", error);
            showNotification("Error", "No se pudo renovar el cliente.", 'error');
        }
    }

    // Función para añadir mes gratis
    window.addFreeMonth = function(id) {
        // Reutilizamos renewItem con un tipo de acción específico
        renewItem(id, 'Mes Gratis (Promoción)');
    }

    // Función para eliminar cliente (QUITAMOS confirm() PROHIBIDO)
    window.deleteItem = async function(id) {
        // NOTA: window.confirm() está prohibido. 
        // Se recomienda implementar un modal de confirmación personalizado.
        showNotification("Procesando...", "Eliminando cliente. Se recomienda un modal de confirmación.", 'warning');

        try {
            await deleteDoc(doc(db, getUserCollectionPath(), id));
            showNotification("Eliminado", "Cliente eliminado con éxito.", 'success');
            closeModal(); 
        } catch (error) {
            console.error("Error al eliminar el cliente:", error);
            showNotification("Error", "No se pudo eliminar el cliente.", 'error');
        }
    }

    // FUNCIÓN PARA RENDERIZAR EL HISTORIAL (ACTUALIZADA CON TIPO DE ACCIÓN)
    function renderRenewalHistory(historyList, targetDiv) {
        targetDiv.innerHTML = '';
        if (historyList.length === 0) {
            targetDiv.innerHTML = '<p style="text-align:center; color: var(--muted);">No se encontraron registros de renovación.</p>';
            return;
        }

        let html = '<div style="display:grid; gap:10px;">';
        historyList.forEach(rec => {
            const actionType = rec.tipo_accion || 'Renovación Manual';
            const color = actionType.includes('Gratis') ? 'var(--yellow)' : actionType.includes('Creación') ? 'var(--green)' : 'var(--accent)';

            html += `
                <div class="stat" style="border-left: 4px solid ${color}; padding:10px;">
                    <strong>${actionType}</strong>
                    <div style="font-size: 13px; color: var(--muted); margin-top: 5px;">
                         Fecha de Registro: ${formatDate(rec.fecha_renovacion)}<br/>
                         Caducidad anterior: ${formatDate(rec.caducidad_anterior)}<br/>
                         Nueva Caducidad: ${formatDate(rec.nueva_caducidad)}
                         ${rec.usuario ? `<br/>Usuario: ${rec.usuario.split('@')[0]}` : ''}
                    </div>
                </div>
            `;
        });
        html += '</div>';
        targetDiv.innerHTML = html;
    }

    // =========================================================================
    // 5. INICIO DE LA APLICACIÓN
    // =========================================================================

    // Llamar a la función de inicialización al cargar la página
    window.onload = initializeFirebase; 
  </script>
</body>
</html>

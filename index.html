<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--red:#ef4444;--green:#10b981;--yellow:#f59e0b;--whatsapp:#25d366;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#013220;font-weight:700}
    nav{margin-left:auto}
    .menu{display:flex;gap:8px}
    .menu button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer; transition: background 0.2s}
    .menu button:hover { background: rgba(255,255,255,0.05); }
    .menu button.active{background:var(--accent);color:#052018;border:none}
    main{display:grid;grid-template-columns:1fr;gap:18px}
    .cards-col{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:18px;}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .stat{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .stat-clickable {
        cursor: pointer;
        transition: background 0.2s;
    }
    .stat-clickable:hover {
        background: rgba(255,255,255,0.05);
    }
    .stat h3{margin:0;font-size:12px;color:var(--muted)}
    .stat p{margin:8px 0 0;font-size:20px;font-weight:600}
    .grid-clients{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    
    /* MEJORA 4: Color de las tarjetas de clientes */
    .card{
        background:linear-gradient(180deg, #152238, #182845); /* Tonalidad azul oscura */
        padding:14px;
        border-radius:12px;
        border:1px solid rgba(255, 255, 255, 0.1); /* Borde m√°s sutil */
        position:relative
    }

    .card.status-red{border-left: 4px solid var(--red);}
    .card.status-yellow{border-left: 4px solid var(--yellow);}
    .card.status-green{border-left: 4px solid var(--green);}

    .card h4{margin:0 0 6px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .btns{display:flex;gap:6px;margin-top:10px; flex-wrap: wrap;}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600; transition: opacity 0.2s}
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.edit{background:#1f2937;color:#e6eef6}
    .btn.renew{background:#064e3b;color:var(--accent)}
    .btn.free-month{background:#0b2e3b;color:var(--accent); border: 1px solid rgba(110, 231, 183, 0.3);} 
    .btn.copy{background:#0b1220;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .btn.delete{background:#3b0b0b;color:#ffcfcf}
    .btn.export{background:var(--yellow);color:#212108;}
    .btn.history{background:#0f172a;color:var(--accent); border: 1px solid var(--accent);} 
    .btn.whatsapp-alert{background:var(--whatsapp);color:#0f1724; font-weight: 700; border: none;} 
    .btn.logout{background:var(--red); color:#ffcfcf;} 

    .card-form{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    form{display:grid;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input[type=text],input[type=date],textarea,select,input[type=email],input[type=password], input[type=file]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    input[type=file] { padding: 8px; }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.6));z-index:50}
    .modal.show{display:flex}
    /* MEJORA 3: Ajuste del modal de edici√≥n para PC y m√≥vil */
    .modal-inner{
        width:96%;
        max-width:720px;
        background:var(--card);
        padding:16px;
        border-radius:12px;
        max-height: 90vh; /* Permite que ocupe hasta el 90% de la altura de la vista */
        overflow-y: auto; /* Habilita el scroll interno si el contenido es demasiado largo */
    }
    /* ESTILOS DE NOTIFICACI√ìN */
    #notifications-container { position: fixed; top: 18px; right: 18px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--card); color: #e6eef6; padding: 12px 18px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); min-width: 250px; max-width: 350px; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(-20px); }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-left: 4px solid var(--green); }
    .toast.error { border-left: 4px solid var(--red); }
    .toast strong { display: block; margin-bottom: 4px; font-size: 14px; }
    .toast p { margin: 0; font-size: 13px; color: var(--muted); }
    /* Login Screen Styles */
    #section-login {
        display: none;
        position: fixed;
        inset: 0;
        background: linear-gradient(180deg,#071022 0%, #07132a 100%);
        align-items: center;
        justify-content: center;
        z-index: 90;
    }
    #section-login.show { display: flex; }
    .login-box {
        background: var(--card);
        padding: 30px;
        border-radius: 16px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.05);
    }
    .login-box h2 { text-align: center; margin-top: 0; color: var(--accent); }
    #login-error-message { color: var(--red); font-size: 13px; text-align: center; margin-top: 5px; height: 18px; }

    /* Dashboard: checkbox */
    .exp-card .flex-end { display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    /* ESTILOS: Campo de Recomendaciones Din√°mico y Autocompletado */
    .dynamic-input-container {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.04);
        background: transparent;
        position: relative; 
    }
    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
        min-height: 18px;
    }
    .recommendation-tag {
        background: var(--accent);
        color: #052018;
        padding: 4px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        font-size: 13px;
        font-weight: 600;
        line-height: 1;
    }
    .recommendation-tag button {
        background: none;
        border: none;
        color: #052018;
        margin-left: 6px;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
        padding: 0;
    }
    .input-add-row {
        display: flex;
        gap: 8px;
    }
    .input-add-row input[type=text] {
        flex-grow: 1;
        padding: 6px 10px; 
        border: 1px solid rgba(255,255,255,0.1);
    }
    .input-add-row button {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        padding: 0;
        font-size: 18px;
        line-height: 1;
    }
    /* Estilos Autocompletado */
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 10px;
        right: 50px; 
        background: var(--card);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 60;
        list-style: none;
        padding: 0;
        margin: 4px 0 0;
    }
    .autocomplete-list li {
        padding: 8px 10px;
        cursor: pointer;
        font-size: 14px;
    }
    .autocomplete-list li:hover, .autocomplete-list li.active {
        background: var(--glass);
    }
    
    /* Estilos para la nueva secci√≥n de Ajustes */
    #section-settings {
        display: none;
        grid-template-columns: 1fr;
        gap: 18px;
    }
    .settings-card {
        background: var(--card);
        padding: 16px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .settings-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    .settings-group h4 {
        margin: 0 0 5px;
        color: var(--accent);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding-bottom: 5px;
    }


    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}

    @media (min-width: 701px) {
        .cards-col {
            grid-template-columns: repeat(3, 1fr);
        }
        .modal-inner.history { 
             max-width: 450px;
        }
    }
    @media (max-width:700px){.row{grid-template-columns:1fr}.menu{display:flex;gap:6px}}
  </style>
</head>

<body>

<section id="section-login" class="show">
  <div class="login-box">
    <h2>Gestor de Clientes</h2>
    <form id="form-login">
      <label for="login-email">Email</label>
      <input type="email" id="login-email" required />

      <label for="login-password" style="margin-top: 10px;">Contrase√±a</label>
      <input type="password" id="login-password" required />

      <div id="login-error-message"></div>

      <button type="submit" class="btn edit" style="width: 100%; margin-top: 15px;">Iniciar Sesi√≥n</button>
    </form>
  </div>
</section>

<div class="container" id="app-container" style="display:none;">

<header>
  <div class="brand">
    <div class="logo">GC</div>
    <div><div style="font-weight:700">Gestor Clientes</div></div>
  </div>
  <nav>
    <div class="menu">
      <button id="nav-dashboard" class="active">Dashboard</button>
      <button id="nav-clientes">Clientes</button>
      <button id="nav-add">A√±adir cliente</button>
      <button id="nav-settings" title="Ajustes ‚öôÔ∏è">‚öôÔ∏è Ajustes</button>
    </div>
  </nav>
</header>

<main>

<section id="section-dashboard">
  <div class="cards-col">
    <div class="stat">
      <h3>Total clientes</h3><p id="stat-total">‚Äî</p>
    </div>
    <div class="stat stat-clickable" id="stat-3days-link" title="Haz clic para filtrar clientes.">
      <h3>Caducan en 3 d√≠as</h3><p id="stat-today-3days">‚Äî</p>
    </div>
    <div class="stat stat-clickable" id="stat-expired-link" title="Haz clic para filtrar clientes.">
      <h3>Cliente caducado</h3><p id="stat-expired">‚Äî</p>
    </div>
  </div>
  <div id="dashboard-soon-exp" class="cards" style="margin-top: 18px">
    <p class="meta" style="grid-column: 1 / -1; margin-bottom: 0;">Clientes que caducan en los pr√≥ximos 3 d√≠as:</p>
  </div>
</section>

<section id="section-clientes" style="display:none">
  <div class="card-form">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h3>Clientes</h3>
      <button id="btn-export-csv" class="btn export">Exportar a CSV üì•</button>
    </div>
    
    <input type="text" id="search-input" placeholder="Buscar por Nombre, Usuario o Aplicaci√≥n..." style="margin-bottom: 12px;" />

    <div id="clients-grid" class="grid-clients" style="margin-top:10px"></div>
  </div>
</section>

<section id="section-add" style="display:none">
  <div class="card-form">
    <h3>A√±adir cliente</h3>
    <form id="form-add">

      <label>Nombre</label>
      <input type="text" id="f-nombre" required />
      
      <label>Tel√©fono (Ej: 34600123456)</label>
      <input type="text" id="f-telefono" value="+34" placeholder="C√≥digo de pa√≠s + n√∫mero (sin espacios)" />

      <div class="row">
        <div>
          <label>Fecha de creaci√≥n</label>
          <input type="date" id="f-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="f-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="f-usuario" />

      <label>Contrase√±a</label>
      <input type="text" id="f-contrasena" />

      <label>Dispositivo utilizado</label>
      <input type="text" id="f-dispositivo" />

      <label>Aplicaci√≥n</label>
      <select id="f-aplicacion">
        <option value="Spinning TV">Spinning TV</option>
        <option value="Spinning IBO">Spinning IBO</option>
        <option value="Spinning Mate">Spinning Mate</option>
        <option value="Hot Player">Hot Player</option>
      </select>

      <label>Clientes recomendados</label>
      <div id="f-recomendaciones-container" class="dynamic-input-container">
          <div id="f-recommended-clients" class="tag-list"></div>
          <div class="input-add-row">
              <input type="text" id="f-new-recommendation" placeholder="Nombre de cliente recomendado" />
              <button type="button" class="btn copy" id="f-add-recommendation-btn">+</button>
              </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button type="submit" class="btn edit">Guardar</button>
        <button type="button" id="f-reset" class="btn copy">Reset</button>
      </div>

    </form>
  </div>
</section>

<section id="section-settings" style="display:none">
    <div class="settings-card">
        <h3>‚öôÔ∏è Ajustes y Herramientas</h3>
        
        <div class="settings-group">
            <h4>Importar datos</h4>
            <p style="font-size: 13px; color: var(--muted); margin: 0;">Sube un archivo CSV con columnas: `nombre,usuario,contrasena,caducidad` (las dem√°s son opcionales). Acepta separadores `,` o `;`.</p>
            <form id="form-import-csv">
                <input type="file" id="csv-file-input" accept=".csv" required />
                <button type="submit" class="btn renew" style="margin-top: 10px;">Importar CSV üì§</button>
            </form>
        </div>

        <div class="settings-group">
            <h4>Gesti√≥n de Sesi√≥n</h4>
            <button id="btn-settings-logout" class="btn logout">Cerrar Sesi√≥n</button>
        </div>
    </div>
</section>

</main>

<footer></footer>

</div>

<div id="modal" class="modal">
  <div class="modal-inner">
    <h3 id="modal-title">Editar cliente</h3>
    <form id="form-edit">

      <label>Nombre</label>
      <input type="text" id="e-nombre" required />
      
      <label>Tel√©fono (Ej: 34600123456)</label>
      <input type="text" id="e-telefono" placeholder="C√≥digo de pa√≠s + n√∫mero (sin espacios)" />

      <div class="row">
        <div>
          <label>Fecha de creaci√≥n</label>
          <input type="date" id="e-creacion" required />
        </div>
        <div>
          <label>Caducidad</label>
          <input type="date" id="e-caducidad" required />
        </div>
      </div>

      <label>Usuario</label>
      <input type="text" id="e-usuario" />

      <label>Contrase√±a</label>
      <input type="text" id="e-contrasena" />

      <label>Dispositivo utilizado</label>
      <input type="text" id="e-dispositivo" />

      <label>Aplicaci√≥n</label>
      <select id="e-aplicacion">
        <option value="Spinning TV">Spinning TV</option>
        <option value="Spinning IBO">Spinning IBO</option>
        <option value="Spinning Mate">Spinning Mate</option>
        <option value="Hot Player">Hot Player</option>
      </select>

      <label>Clientes recomendados</label>
      <div id="e-recomendaciones-container" class="dynamic-input-container">
          <div id="e-recommended-clients" class="tag-list"></div>
          <div class="input-add-row">
              <input type="text" id="e-new-recommendation" placeholder="Nombre de cliente recomendado" />
              <button type="button" class="btn copy" id="e-add-recommendation-btn">+</button>
               </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;justify-content:space-between">
        <button type="button" id="btn-history-open" class="btn history">Ver Historial</button>
        <div style="display:flex;gap:8px;">
          <button type="button" id="modal-cancel" class="btn copy">Cancelar</button>
          <button type="submit" class="btn edit">Guardar cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="history-modal" class="modal">
  <div class="modal-inner history">
    <h3 id="history-modal-title">Historial de Renovaciones</h3>
    <div id="history-list" style="max-height: 400px; overflow-y: auto;">
        </div>
    <div style="text-align: right; margin-top: 15px;">
        <button type="button" id="history-modal-close" class="btn copy">Cerrar</button>
    </div>
  </div>
</div>

<div id="notifications-container"></div>


<script type="module">

// --- CONFIG FIREBASE ---
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import {
  getFirestore, collection, addDoc, doc, onSnapshot,
  updateDoc, deleteDoc, query, orderBy, getDocs, writeBatch, where
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

import { 
    getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
} from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';


// NOTA: Recuerda que debes reemplazar la configuraci√≥n de Firebase con tus claves reales.
const firebaseConfig = {
  apiKey: "AIzaSyCA2fZvN8WVKWwEDL0z694C2o5190OMhq8",
  authDomain: "gestioncandy-b9356.firebaseapp.com",
  projectId: "gestioncandy-b9356",
  storageBucket: "gestioncandy-b9356.firebasestorage.app",
  messagingSenderId: "869982852654",
  appId: "1:869982852654:web:ac450321a746e62365f1bf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); 

// --- ELEMENTOS UI DE LA APLICACI√ìN ---
const appContainer = document.getElementById('app-container'); 
const sections = {
    'dashboard': document.getElementById('section-dashboard'),
    'clientes': document.getElementById('section-clientes'),
    'add': document.getElementById('section-add'),
    'settings': document.getElementById('section-settings'), // NUEVA SECCI√ìN
};
const modal = document.getElementById('modal'); 
const historyModal = document.getElementById('history-modal');
const formLogin = document.getElementById('form-login');
const sectionLogin = document.getElementById('section-login');
const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const loginErrorMsg = document.getElementById('login-error-message');


// FORM ADD
const formAdd = document.getElementById('form-add');
const fReset = document.getElementById('f-reset');
const fCreacion = document.getElementById('f-creacion');
const fCaducidad = document.getElementById('f-caducidad'); 
const fTelefono = document.getElementById('f-telefono'); 


// VARIABLES GLOBALES
let cachedList = []; 
let currentRecommendations = []; 
let cachedClientNames = new Set(); 
let currentFilter = 'all'; 
const col = collection(db, "clientes");


// --- FUNCIONES AUXILIARES ---

function getNewCaducidad(currentDate, months) {
    let date = currentDate ? new Date(currentDate) : new Date();
    let newDate = new Date(date);
    
    newDate.setMonth(newDate.getMonth() + months);
    
    if (newDate.getDate() < date.getDate()) {
        newDate.setDate(0); 
    }

    return newDate.toISOString();
}

function formatDate(d){
  if(!d) return '-';
  const dt = new Date(d);
  if(isNaN(dt.getTime())) return d;
  return dt.toLocaleDateString();
}

function isoForInput(d){
  if(!d) return '';
  const t = new Date(d);
  if(isNaN(t.getTime())) return '';
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth()+1).padStart(2,'0');
  const dd = String(t.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function showNotification(title, message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
  
  const notificationsContainer = document.getElementById('notifications-container');
  notificationsContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);

  setTimeout(() => {
    toast.classList.remove('show');
    toast.addEventListener('transitionend', () => toast.remove());
  }, 4000);
}

function setDefaultDates() {
    const today = new Date();
    const caducidad3Months = getNewCaducidad(today, 3);

    fCreacion.value = isoForInput(today);
    fCaducidad.value = isoForInput(caducidad3Months);
}
setDefaultDates(); 

fCreacion.addEventListener('change', () => {
    const newCreationDate = fCreacion.value;
    if (newCreationDate) {
        const newCaducidad = getNewCaducidad(newCreationDate, 3);
        fCaducidad.value = isoForInput(newCaducidad);
    }
});


function setActive(btn){
  document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function switchSection(target) {
    Object.keys(sections).forEach(key => {
        sections[key].style.display = 'none';
    });
    // Ajuste del display para cada secci√≥n principal
    sections[target].style.display = target === 'clientes' || target === 'add' || target === 'settings' ? 'grid' : 'grid'; 

    const btn = document.getElementById(`nav-${target}`);
    if(btn) setActive(btn);

    if (target === 'clientes') {
      filterClients(document.getElementById('search-input').value, currentFilter);
    }
}

function getExpiryStatus(isoDate) {
    if (!isoDate) return '';
    const date = new Date(isoDate);
    const now = new Date();
    const diffTime = date.getTime() - now.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays <= 0) return 'status-red';
    if (diffDays <= 7) return 'status-yellow';
    return 'status-green';
}

function getSoonToExpire(list) {
    const now = new Date();
    now.setHours(0,0,0,0);
    const limit = new Date(now);
    limit.setDate(limit.getDate() + 3);
    limit.setHours(23,59,59,999);
    return list.filter(i => {
      if(!i.caducidad) return false;
      const d = new Date(i.caducidad);
      return d >= now && d <= limit;
    });
}

function getExpired(list) {
    const now = new Date();
    now.setHours(0,0,0,0);
    return list.filter(i => {
        if(!i.caducidad) return false;
        const d = new Date(i.caducidad);
        return d < now; 
    });
}


// --- AUTENTICACI√ìN Y GESTI√ìN DE ESTADO ---

function handleAuthStatus(user) {
    if (user) {
        sectionLogin.classList.remove('show');
        appContainer.style.display = 'block';
        loginErrorMsg.textContent = '';
        // Si el usuario ya estaba logueado, se mantiene en la √∫ltima vista, sino a dashboard
        if (!auth.currentFilter) {
            switchSection('dashboard');
        }
    } else {
        sectionLogin.classList.add('show');
        appContainer.style.display = 'none';
        loginEmail.value = '';
        loginPassword.value = '';
    }
}

onAuthStateChanged(auth, handleAuthStatus);

// 1. Manejador de Login
formLogin.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginErrorMsg.textContent = 'Iniciando sesi√≥n...';

    try {
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
    } catch (error) {
        let message = "Error de inicio de sesi√≥n.";
        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            message = "Usuario o contrase√±a incorrectos.";
        } else if (error.code === 'auth/invalid-email') {
            message = "Formato de email no v√°lido.";
        }
        loginErrorMsg.textContent = message;
        console.error("Login error:", error);
    }
});


// 2. Manejador de Logout (Centralizado en Ajustes y nav)
window.handleLogout = async function() {
    try {
        await signOut(auth);
        showNotification("Sesi√≥n Cerrada", "Has cerrado sesi√≥n correctamente.", 'success');
    } catch (error) {
        showNotification("Error", "No se pudo cerrar la sesi√≥n.", 'error');
        console.error("Logout error:", error);
    }
};
document.getElementById('btn-settings-logout').addEventListener('click', window.handleLogout);


// 3. Oyentes de Navegaci√≥n
document.getElementById('nav-dashboard').addEventListener('click', ()=> switchSection('dashboard'));
document.getElementById('nav-clientes').addEventListener('click', ()=> switchSection('clientes'));
document.getElementById('nav-add').addEventListener('click', ()=>{
    switchSection('add');
    setDefaultDates(); 
    fTelefono.value = '+34'; 
});
document.getElementById('nav-settings').addEventListener('click', ()=> switchSection('settings')); // NUEVO

// --- CARGA DE CLIENTES EN TIEMPO REAL ---

const unsubscribe = onSnapshot(col, (snapshot) => {
    const list = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    cachedList = list;
    cachedClientNames = new Set(list.map(i => i.nombre));

    renderDashboard(list);
    updateStats(list);
    
    if (sections.clientes.style.display !== 'none') {
        filterClients(document.getElementById('search-input').value, currentFilter);
    }
}, (error) => {
    console.error("Error fetching data: ", error);
});


// --- L√ìGICA DE FILTROS Y ESTAD√çSTICAS ---

function updateStats(list) {
    document.getElementById('stat-total').textContent = list.length;
    const soon = getSoonToExpire(list);
    document.getElementById('stat-today-3days').textContent = soon.length;
    const expired = getExpired(list);
    document.getElementById('stat-expired').textContent = expired.length;
}

document.getElementById('stat-3days-link').addEventListener('click', () => {
    currentFilter = 'soon';
    document.getElementById('search-input').value = '';
    switchSection('clientes');
});
document.getElementById('stat-expired-link').addEventListener('click', () => {
    currentFilter = 'expired';
    document.getElementById('search-input').value = '';
    switchSection('clientes');
});

document.getElementById('search-input').addEventListener('input', (e) => {
    currentFilter = 'all';
    filterClients(e.target.value);
});


function filterClients(searchTerm = '', filter = 'all') {
    const normalizedSearch = searchTerm.toLowerCase();
    let filteredList = cachedList;

    if (filter === 'soon') {
        filteredList = getSoonToExpire(cachedList);
    } else if (filter === 'expired') {
        filteredList = getExpired(cachedList);
    }

    const searchResults = filteredList.filter(item => {
        return item.nombre?.toLowerCase().includes(normalizedSearch) ||
               item.usuario?.toLowerCase().includes(normalizedSearch) ||
               item.aplicacion?.toLowerCase().includes(normalizedSearch);
    });

    renderClients(searchResults);
}


// --- L√ìGICA DE TABLA Y ACCIONES ---

window.toggleRenovara = async function(checkbox) {
    const id = checkbox.dataset.id;
    const newValue = checkbox.checked;
    try {
        await updateDoc(doc(db, "clientes", id), { renovara: newValue });
        showNotification("Estado Actualizado", `Estado de 'Renovar√°' cambiado a ${newValue ? 'S√≠' : 'No'}.`, 'success');
    } catch (error) {
        showNotification("Error", "No se pudo actualizar el estado de 'Renovar√°'.", 'error');
        console.error("Error toggling renovara:", error);
    }
}

function renderDashboard(list){
  const soon = getSoonToExpire(list);

  const dashboardSoonExp = document.getElementById('dashboard-soon-exp');
  
  // Encabezado de la secci√≥n
  const header = `<p class="meta" style="grid-column: 1 / -1; margin-bottom: 0; color: var(--accent); font-weight: 600;">Clientes que caducan en los pr√≥ximos 3 d√≠as (${soon.length}):</p>`;
    
  let cardsContainerHtml = '';
  
  if (soon.length === 0) {
      cardsContainerHtml = '<p style="color: var(--muted); margin: 10px 0;">No hay clientes pr√≥ximos a caducar.</p>';
  } else {
      let cardsHtml = '';
      soon.forEach(item => {
        const isRenewing = item.renovara === true ? 'checked' : '';
        
        // Estilo de la tarjeta del dashboard (distinto al resto de la webapp)
        const dashboardCardStyle = `background: #003027; border: 1px solid var(--accent);`;
        
        // Generaci√≥n del Bot√≥n WhatsApp
        const whatsappBtn = item.telefono && item.telefono.length > 5 ? 
            `<button class="btn whatsapp-alert" onclick="sendWhatsappAlert('${item.id}')">¬°Avisar! üí¨</button>` : '';

        cardsHtml += `
            <div class="card exp-card status-red" style="flex-shrink: 0; min-width: 250px; ${dashboardCardStyle}">
              <h4>${item.nombre}</h4>
              <div class="meta" style="color: var(--accent); font-weight: 600;">Caduca: ${formatDate(item.caducidad)}</div>
              <div class="flex-end">
                <label for="renew-${item.id}">Renovar√°</label>
                <input type="checkbox" id="renew-${item.id}" data-id="${item.id}" ${isRenewing} onclick="toggleRenovara(this)" />
              </div>
              <div class="btns">
                <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
                <button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>
                <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
                ${whatsappBtn}
              </div>
            </div>
        `;
      });
      
      // Contenedor de scroll horizontal (visualizaci√≥n en fila)
      cardsContainerHtml = `<div style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; margin-top: 10px;">${cardsHtml}</div>`;
  }
  
  dashboardSoonExp.innerHTML = header + cardsContainerHtml;
}


// MEJORA 2: FUNCI√ìN COPYPASSWORD
window.copyPassword = function(id) {
    const item = cachedList.find(i => i.id === id);
    if (!item) return;

    // Campos solicitados: Usuario, Contrase√±a, Aplicacion, Fecha de caducidad
    const textToCopy = 
        `Usuario: ${item.usuario || '-'}\n` +
        `Contrase√±a: ${item.contrasena || '-'}\n` +
        `Aplicaci√≥n: ${item.aplicacion || '-'}\n` +
        `Caducidad: ${formatDate(item.caducidad)}`;
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification("Copiado", "Usuario, Contrase√±a, Aplicaci√≥n y Caducidad copiados.", 'success');
    }).catch(err => {
        showNotification("Error", "No se pudo copiar el texto.", 'error');
        console.error('Error al copiar: ', err);
    });
}

// FUNCI√ìN WHATSAPP
window.sendWhatsappAlert = function(id) {
    const item = cachedList.find(i => i.id === id);
    if (!item || !item.telefono || item.telefono.length < 6) {
        showNotification("Error", "Tel√©fono no v√°lido o faltante.", 'error');
        return;
    }

    const message = encodeURIComponent(`Hola ${item.nombre || ''}. Tu suscripci√≥n va a caducar pronto, ¬øvas a querer renovar? üôÇ`);
    const phone = item.telefono.replace(/\s/g, '').replace('+', '');
    
    const whatsappUrl = `https://wa.me/${phone}?text=${message}`;
    
    window.open(whatsappUrl, '_blank');
    
    showNotification("Alerta enviada", `Se abri√≥ WhatsApp para enviar mensaje a ${item.nombre}.`, 'success');
}

// MEJORA 5: FUNCI√ìN MES GRATIS CON CONDICI√ìN DE RECOMENDACIONES
window.addFreeMonth = async function(id) {
    const item = cachedList.find(i => i.id === id);
    if(!item) return;

    // Condici√≥n: Solo si tiene 3 o m√°s recomendaciones
    const recommendationsCount = item.recomendaciones ? item.recomendaciones.length : 0;
    if (recommendationsCount < 3) {
        showNotification("Acci√≥n Bloqueada", `Se requieren al menos 3 recomendaciones (${recommendationsCount} actuales) para el mes gratis.`, 'error');
        return; 
    }

    const oldCaducidad = item.caducidad;
    const newCaducidad = getNewCaducidad(oldCaducidad, 1); 

    try {
        await updateDoc(doc(db, "clientes", id), {
            caducidad: newCaducidad
        });

        await addDoc(collection(db, "clientes", id, "renovaciones"), {
            fecha_renovacion: new Date().toISOString(),
            caducidad_anterior: oldCaducidad || 'Fecha no registrada',
            nueva_caducidad: newCaducidad,
            tipo_accion: 'Mes Gratis', 
            usuario: auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'
        });

        showNotification("Mes Gratis A√±adido", `Cliente ${item.nombre} extendido por 1 mes.`, 'success');
    } catch (error) {
        showNotification("Error", "No se pudo a√±adir el mes gratis. (Revisa reglas de Firestore)", 'error');
        console.error("Error adding free month:", error);
    }
}


// FUNCI√ìN RENEW ITEM CON HISTORIAL
window.renewItem = async function(id){
  const item = cachedList.find(i => i.id === id);
  if(!item) return;

  const oldCaducidad = item.caducidad;
  const newCaducidad = getNewCaducidad(oldCaducidad, 3); 

  try {
      await updateDoc(doc(db, "clientes", id), {
        caducidad: newCaducidad
      });

      await addDoc(collection(db, "clientes", id, "renovaciones"), {
          fecha_renovacion: new Date().toISOString(),
          caducidad_anterior: oldCaducidad || 'Fecha no registrada',
          nueva_caducidad: newCaducidad,
          tipo_accion: 'Renovaci√≥n Normal (+3 meses)', 
          usuario: auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'
      });

      showNotification("Renovaci√≥n Exitosa", "Cliente renovado por 3 meses y registro guardado.", 'success');
  } catch (error) {
      showNotification("Error de Renovaci√≥n", "No se pudo renovar el cliente. (Revisa reglas de Firestore)", 'error');
      console.error("Error renewing item:", error);
  }
}

// RENDERIZADO DE CLIENTES EN SECCI√ìN CLIENTES 
function renderClients(list){
  const clientsGrid = document.getElementById('clients-grid');
  clientsGrid.innerHTML = "";

  list.forEach(item => {
    let recommendationsHTML = '';
    if (item.recomendaciones && item.recomendaciones.length > 0) {
        recommendationsHTML = `<div class="meta" style="margin-top: 8px;">Recomendaciones (${item.recomendaciones.length}): ${item.recomendaciones.join(', ')}</div>`;
    }
    
    const statusClass = getExpiryStatus(item.caducidad);

    const whatsappBtn = item.telefono && item.telefono.length > 5 ? 
        `<button class="btn whatsapp-alert" onclick="sendWhatsappAlert('${item.id}')">Avisar üí¨</button>` : '';

    const card = document.createElement('div');
    card.className = `card ${statusClass}`;
    card.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="meta">Tel√©fono: ${item.telefono || "-"}</div>
      <div class="meta">App: ${item.aplicacion || "-"}</div>
      <div class="meta">Creaci√≥n: ${formatDate(item.creacion)}</div>
      <div class="meta">Caduca: ${formatDate(item.caducidad)}</div>
      ${recommendationsHTML}

      <div class="btns">
        <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
        <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
        <button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>
        <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
        ${whatsappBtn}
        <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
      </div>
    `;
    clientsGrid.appendChild(card);
  });
}

window.deleteItem = async function(id) {
    if (!confirm("¬øEst√°s seguro de que quieres eliminar este cliente?")) return;

    try {
        await deleteDoc(doc(db, "clientes", id));
        showNotification("Eliminado", "Cliente eliminado con √©xito.", 'success');
    } catch (error) {
        showNotification("Error", "No se pudo eliminar el cliente. (Revisa reglas de Firestore)", 'error');
        console.error("Error deleting item:", error);
    }
}


// --- L√ìGICA DE EDICI√ìN Y RECOMENDACIONES ---

window.openEdit = function(id){
    const item = cachedList.find(i => i.id === id);
    if(!item) return;

    currentRecommendations = [...(item.recomendaciones || [])];
    renderRecommendations(currentRecommendations, document.getElementById('e-recommended-clients'), 'e');

    document.getElementById('e-nombre').value = item.nombre;
    document.getElementById('e-telefono').value = item.telefono || "+34"; 
    document.getElementById('e-creacion').value = isoForInput(item.creacion);
    document.getElementById('e-caducidad').value = isoForInput(item.caducidad);
    document.getElementById('e-usuario').value = item.usuario || "";
    document.getElementById('e-contrasena').value = item.contrasena || "";
    document.getElementById('e-dispositivo').value = item.dispositivo || "";
    document.getElementById('e-aplicacion').value = item.aplicacion || ""; 

    modal.setAttribute('data-id', id);
    document.getElementById('btn-history-open').onclick = () => openHistoryModal(id);
    document.getElementById('modal').classList.add('show');
};

document.getElementById('modal-cancel').addEventListener('click', () => {
    modal.classList.remove('show');
    currentRecommendations = [];
});

function renderRecommendations(recommendations, targetElement, prefix) {
    targetElement.innerHTML = '';
    recommendations.forEach((rec, index) => {
        const tag = document.createElement('div');
        tag.className = 'recommendation-tag';
        tag.innerHTML = `${rec} <button type="button" onclick="removeRecommendation('${prefix}', ${index})">x</button>`;
        targetElement.appendChild(tag);
    });
}
window.removeRecommendation = function(prefix, index) {
    currentRecommendations.splice(index, 1);
    renderRecommendations(currentRecommendations, document.getElementById(`${prefix}-recommended-clients`), prefix);
}

const addRecommendationLogic = (prefix) => {
    const input = document.getElementById(`${prefix}-new-recommendation`);
    const container = document.getElementById(`${prefix}-recommended-clients`);
    const addButton = document.getElementById(`${prefix}-add-recommendation-btn`);

    addButton.onclick = () => {
        const name = input.value.trim();
        if (name && !currentRecommendations.includes(name)) {
            currentRecommendations.push(name);
            input.value = '';
            renderRecommendations(currentRecommendations, container, prefix);
        }
    };
};

addRecommendationLogic('f');
addRecommendationLogic('e');

// GUARDAR CAMBIOS EN MODAL
document.getElementById('form-edit').addEventListener('submit', async e=>{
  e.preventDefault();
  const id = modal.getAttribute('data-id');
  if(!id) return;

  const data = {
    nombre: document.getElementById('e-nombre').value,
    telefono: document.getElementById('e-telefono').value, 
    creacion: document.getElementById('e-creacion').value,
    caducidad: document.getElementById('e-caducidad').value,
    usuario: document.getElementById('e-usuario').value,
    contrasena: document.getElementById('e-contrasena').value,
    dispositivo: document.getElementById('e-dispositivo').value,
    aplicacion: document.getElementById('e-aplicacion').value,
    recomendaciones: currentRecommendations 
  };

  try {
      await updateDoc(doc(db, "clientes", id), data);
      document.getElementById('modal').classList.remove('show');
      showNotification("Guardado", `Cambios en cliente ${data.nombre} guardados.`, 'success');
      currentRecommendations = [];
  } catch (error) {
      showNotification("Error", "No se pudieron guardar los cambios. (Revisa reglas de Firestore)", 'error');
      console.error("Error updating item:", error);
  }
});

// A√ëADIR CLIENTE NUEVO
formAdd.addEventListener('submit', async e=>{
  e.preventDefault();

  const data = {
    nombre: document.getElementById('f-nombre').value,
    telefono: document.getElementById('f-telefono').value, 
    creacion: document.getElementById('f-creacion').value,
    caducidad: document.getElementById('f-caducidad').value,
    usuario: document.getElementById('f-usuario').value,
    contrasena: document.getElementById('f-contrasena').value,
    dispositivo: document.getElementById('f-dispositivo').value,
    aplicacion: document.getElementById('f-aplicacion').value,
    recomendaciones: currentRecommendations, 
    renovara: false
  };

  try {
      const docRef = await addDoc(col, data);
      
      await addDoc(collection(db, "clientes", docRef.id, "renovaciones"), {
          fecha_renovacion: new Date().toISOString(),
          caducidad_anterior: 'Nuevo Cliente',
          nueva_caducidad: data.caducidad,
          tipo_accion: 'Creaci√≥n (+3 meses)', 
          usuario: auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'
      });
      
      showNotification("Cliente Creado", `El cliente ${data.nombre} ha sido a√±adido con √©xito.`, 'success');
      
      formAdd.reset();
      setDefaultDates(); 
      currentRecommendations = [];
      document.getElementById('f-recommended-clients').innerHTML = '';
      document.getElementById('f-telefono').value = '+34'; 
  } catch (error) {
      showNotification("Error de Creaci√≥n", "No se pudo a√±adir el nuevo cliente. (Revisa reglas de Firestore)", 'error');
      console.error("Error adding item:", error);
  }
});

fReset.addEventListener('click', ()=> {
    formAdd.reset();
    setDefaultDates();
    currentRecommendations = [];
    document.getElementById('f-recommended-clients').innerHTML = '';
    document.getElementById('f-telefono').value = '+34'; 
});


// --- L√ìGICA DEL HISTORIAL ---

window.openHistoryModal = async function(id) {
    const item = cachedList.find(i => i.id === id);
    if (!item) return;

    document.getElementById('history-modal-title').textContent = `Historial de Renovaciones de ${item.nombre}`;

    try {
        const q = query(collection(db, "clientes", id, "renovaciones"), orderBy("fecha_renovacion", "desc"));
        const snapshot = await getDocs(q);
        const historyList = snapshot.docs.map(doc => doc.data());
        
        renderRenewalHistory(historyList, document.getElementById('history-list'));
        historyModal.classList.add('show');
    } catch (error) {
        showNotification("Error", "No se pudo cargar el historial.", 'error');
        console.error("Error fetching history:", error);
    }
}

document.getElementById('history-modal-close').addEventListener('click', () => {
    historyModal.classList.remove('show');
});


function renderRenewalHistory(historyList, targetDiv) {
    targetDiv.innerHTML = '';
    if (historyList.length === 0) {
        targetDiv.innerHTML = '<p style="text-align:center; color: var(--muted);">No se encontraron registros de renovaci√≥n.</p>';
        return;
    }

    let html = '<div style="display:grid; gap:10px;">';
    historyList.forEach(rec => {
        const actionType = rec.tipo_accion || 'Renovaci√≥n Manual';
        const color = actionType.includes('Gratis') ? 'var(--yellow)' : actionType.includes('Creaci√≥n') ? 'var(--green)' : 'var(--accent)';

        html += `
            <div class="stat" style="border-left: 4px solid ${color}; padding:10px;">
                <strong>${actionType}</strong>
                <div style="font-size: 13px; color: var(--muted); margin-top: 5px;">
                     Fecha de Registro: ${formatDate(rec.fecha_renovacion)}<br/>
                     Caducidad anterior: ${formatDate(rec.caducidad_anterior)}<br/>
                     Nueva Caducidad: ${formatDate(rec.nueva_caducidad)}
                     ${rec.usuario ? `<br/>Usuario: ${rec.usuario.split('@')[0]}` : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    targetDiv.innerHTML = html;
}

// --- L√ìGICA DE IMPORTACI√ìN/EXPORTACI√ìN CSV ---

// Exportaci√≥n
document.getElementById('btn-export-csv').addEventListener('click', () => {
    if (cachedList.length === 0) {
        showNotification("Error", "No hay datos para exportar.", 'error');
        return;
    }

    const headers = ["nombre", "usuario", "contrasena", "caducidad", "creacion", "telefono", "dispositivo", "aplicacion", "recomendaciones", "renovara", "id"];
    
    // Convertir la lista a formato CSV
    let csvContent = headers.join(";") + "\n"; // Usamos punto y coma como separador

    cachedList.forEach(item => {
        const row = headers.map(header => {
            let value = item[header];

            // Manejo especial para recomendaciones (array)
            if (header === 'recomendaciones') {
                value = (value && Array.isArray(value)) ? value.join('|') : '';
            } 
            // Manejo de booleanos
            else if (typeof value === 'boolean') {
                value = value ? 'TRUE' : 'FALSE';
            }
            // Asegurar que las fechas est√©n en formato ISO si se requiere (para re-importaci√≥n)
            else if (header === 'creacion' || header === 'caducidad') {
                value = isoForInput(value);
            }
            
            // Reemplazar ; por , para evitar problemas de delimitador en el valor, si hay
            value = (value === null || value === undefined) ? '' : String(value).replace(/;/g, ',').replace(/\n/g, ' ').replace(/"/g, '""');
            
            // Rodear con comillas si contiene , o est√° vac√≠o
            return (value.includes(',') || value.length === 0) ? `"${value}"` : value;

        }).join(";");
        csvContent += row + "\n";
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'clientes_exportado.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification("Exportado", "Datos exportados a clientes_exportado.csv", 'success');
});

// Importaci√≥n
document.getElementById('form-import-csv').addEventListener('submit', (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('csv-file-input');
    const file = fileInput.files[0];

    if (!file) {
        showNotification("Error", "Por favor, selecciona un archivo CSV.", 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const csvText = event.target.result;
            await processCsv(csvText);
            fileInput.value = ''; // Resetear el input file
            switchSection('clientes'); // Volver a la vista de clientes
        } catch (error) {
            showNotification("Error de Importaci√≥n", `Hubo un error al procesar el archivo: ${error.message}`, 'error');
            console.error(error);
        }
    };
    reader.readAsText(file);
});

async function processCsv(csvText) {
    // 1. Detecci√≥n del delimitador (coma o punto y coma)
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) {
        throw new Error("El archivo CSV est√° vac√≠o o solo contiene la cabecera.");
    }
    const headerLine = lines[0];
    let delimiter = ',';
    if (headerLine.includes(';')) {
        delimiter = ';';
    }

    const headers = headerLine.toLowerCase().split(delimiter).map(h => h.trim().replace(/['"]+/g, ''));
    const requiredHeaders = ["nombre", "usuario", "contrasena", "caducidad"];
    const missingHeaders = requiredHeaders.filter(rh => !headers.includes(rh));

    if (missingHeaders.length > 0) {
        throw new Error(`Faltan campos obligatorios: ${missingHeaders.join(', ')}`);
    }

    const clientsToImport = [];
    const batch = writeBatch(db);
    let successCount = 0;

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // Funci√≥n de parseo simple que respeta las comillas para manejar el delimitador dentro de los valores
        const values = line.match(/(".*?"|[^,;]+)(,|$|;)/g).map(v => v.replace(/,$/g, '').replace(/;$/g, '').trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
        
        if (values.length !== headers.length) {
            // Intenta parsear con el otro delimitador si el conteo no coincide (puede que haya un error de detecci√≥n)
            const fallbackValues = line.match(/(".*?"|[^,;]+)(,|$|;)/g).map(v => v.replace(/,$/g, '').replace(/;$/g, '').trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            if (fallbackValues.length !== headers.length) {
                console.warn(`Saltando l√≠nea ${i+1} debido a un n√∫mero inconsistente de columnas.`);
                continue;
            }
        }
        
        let clientData = {};
        headers.forEach((header, index) => {
            let value = values[index] || '';
            
            // Conversiones de tipo
            if (header === 'recomendaciones') {
                clientData[header] = value ? value.split('|') : [];
            } else if (header === 'renovara') {
                clientData[header] = (value.toUpperCase() === 'TRUE');
            } else {
                clientData[header] = value;
            }
        });

        // Aplicar valores por defecto para campos esenciales si no est√°n en el CSV
        clientData.creacion = clientData.creacion || new Date().toISOString().split('T')[0]; // Fecha actual
        clientData.telefono = clientData.telefono || '';
        clientData.dispositivo = clientData.dispositivo || '';
        clientData.aplicacion = clientData.aplicacion || 'Spinning TV';
        clientData.usuario = clientData.usuario || 'N/A';
        clientData.contrasena = clientData.contrasena || 'N/A';
        clientData.renovara = clientData.renovara || false;
        clientData.recomendaciones = clientData.recomendaciones || [];

        // Validar caducidad (m√≠nimo)
        if (!clientData.caducidad) {
             throw new Error(`La l√≠nea ${i+1} no tiene un valor v√°lido para 'caducidad'.`);
        }

        // Usamos addDoc para a√±adir nuevos documentos a la colecci√≥n 'clientes'
        const newDocRef = doc(col);
        batch.set(newDocRef, clientData);
        clientsToImport.push({id: newDocRef.id, ...clientData});
        successCount++;
    }

    if (successCount > 0) {
        await batch.commit();
        // Generar un evento de historial de renovaci√≥n de "Creaci√≥n" para cada nuevo cliente
        const historyBatch = writeBatch(db);
        clientsToImport.forEach(client => {
            historyBatch.set(doc(collection(db, "clientes", client.id, "renovaciones")), {
                fecha_renovacion: new Date().toISOString(),
                caducidad_anterior: 'Importaci√≥n CSV',
                nueva_caducidad: client.caducidad,
                tipo_accion: 'Creaci√≥n (Importaci√≥n CSV)', 
                usuario: auth.currentUser ? auth.currentUser.email : 'Usuario Desconocido'
            });
        });
        await historyBatch.commit();
        showNotification("Importaci√≥n Exitosa", `Se importaron ${successCount} clientes al sistema.`, 'success');
    } else {
        showNotification("Advertencia", "No se import√≥ ning√∫n cliente v√°lido.", 'error');
    }
}


</script>
</body>
</html>

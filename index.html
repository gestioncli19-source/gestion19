<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Clientes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--red:#ef4444;--green:#10b981;--yellow:#f59e0b;--whatsapp:#25d366;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022 0%, #07132a 100%);color:#e6eef6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--glass);margin-bottom:20px}
    header h1{font-size:24px;margin:0}
    .nav{display:flex;gap:10px}
    .btn{padding:10px 15px;border-radius:8px;cursor:pointer;font-weight:600;transition:background-color .2s, box-shadow .2s;border:none;white-space:nowrap;font-size:14px}
    .btn:hover{box-shadow:0 0 15px rgba(110, 231, 183, 0.3)}
    .nav-link{background-color:transparent;color:var(--muted);position:relative}
    .nav-link:hover{color:#fff;background-color:var(--glass)}
    .nav-link.active{color:var(--accent);font-weight:700}
    .nav-link.active::after{content:'';position:absolute;bottom:-10px;left:0;width:100%;height:3px;background-color:var(--accent);border-radius:2px}

    /* Dashboard Styling */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;margin-bottom:30px}
    .stat{background-color:var(--card);padding:20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.2);border-left:5px solid var(--accent);transition:transform .2s}
    .stat:hover{transform:translateY(-3px)}
    .stat-title{font-size:14px;color:var(--muted);margin-bottom:10px;text-transform:uppercase}
    .stat-value{font-size:28px;font-weight:700}
    .stat-description{font-size:12px;color:var(--muted);margin-top:5px}
    
    /* 1. Dashboard Visualization (Clientes por caducar en fila) */
    .expiring-clients-box {
        background-color: var(--card);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        margin-top: 20px;
        border-left: 5px solid var(--yellow);
    }
    .expiring-clients-box h3 {
        color: var(--yellow);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 20px;
    }
    #expiring-clients-container {
        display: flex; /* Display in a row */
        overflow-x: auto; /* Enable horizontal scrolling */
        gap: 15px;
        padding: 5px 0;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }
    #expiring-clients-container::-webkit-scrollbar {
        display: none; /* Chrome, Safari */
    }
    .expiring-client-card {
        min-width: 280px; /* Fixed width for each card */
        padding: 15px;
        background-color: #2a1e12; /* Unique dark background */
        color: #fff; 
        border: 1px solid var(--yellow);
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
    }
    .expiring-client-card h5 {
        margin: 0 0 5px 0;
        font-weight: 700;
        font-size: 16px;
        color: var(--yellow);
    }
    .expiring-client-card .detail {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 3px;
    }

    /* Clients Grid Styling */
    .clients-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;padding-top:20px}
    .card{padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.3);display:flex;flex-direction:column}
    
    /* 4. Client Card Colors */
    .card-color-1 { background-color: #1a2a40; border-left: 5px solid #6366f1; } /* Indigo */
    .card-color-2 { background-color: #1a3028; border-left: 5px solid #10b981; } /* Teal/Green */
    .card-color-3 { background-color: #2a1e12; border-left: 5px solid #f97316; } /* Orange */
    .card-color-4 { background-color: #241a2c; border-left: 5px solid #e879f9; } /* Violet */
    .card-color-5 { background-color: #172535; border-left: 5px solid #3b82f6; } /* Blue */

    .card h4{margin-top:0;font-size:18px;color:#fff}
    .card .meta{font-size:13px;color:var(--muted);margin-bottom:5px}
    .card .status-active{color:var(--green);font-weight:600}
    .card .status-inactive{color:var(--red);font-weight:600}
    .card .status-expiring{color:var(--yellow);font-weight:600}
    .card .recs-list{margin-top:10px;padding-top:10px;border-top:1px solid var(--glass)}
    .card .recs-list p{font-size:14px;font-weight:600;color:var(--accent);margin-top:0;margin-bottom:5px}
    .card .recs-list ul{list-style:none;padding:0;margin:0}
    .card .recs-list li{font-size:12px;color:var(--muted);margin-bottom:3px}
    .card .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:20px}
    .card .btns .btn{padding:8px 12px;font-size:12px;font-weight:500;background-color:var(--glass);color:var(--accent)}
    .card .btns .btn:hover{background-color:rgba(255,255,255,0.08)}
    .card .btns .edit{color:#3b82f6}
    .card .btns .delete{color:var(--red)}

    /* Modal Styling */
    .modal{display:none;position:fixed;z-index:500;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.8);justify-content:center;align-items:center;padding:20px}
    
    /* 3. Edit Modal Responsiveness */
    .modal-content{
        background-color: var(--card);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        width: 90%;
        max-width: 700px; /* Increased max width for more form space */
        max-height: 90vh; /* Critical for responsiveness on mobile/PC */
        overflow-y: auto; /* Critical for responsiveness on mobile/PC */
        position: relative;
    }

    .modal-content .close-btn{color:var(--muted);float:right;font-size:28px;font-weight:700;line-height:1;transition:color .2s}
    .modal-content .close-btn:hover,.modal-content .close-btn:focus{color:#fff;text-decoration:none;cursor:pointer}
    .modal-content h3{margin-top:0;color:var(--accent)}
    .modal-form{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:15px;margin-top:20px}
    .form-group{display:flex;flex-direction:column}
    .form-group label{margin-bottom:5px;font-size:14px;color:var(--muted)}
    .modal-form input, .modal-form textarea{padding:10px;border-radius:6px;border:1px solid var(--glass);background-color:#1e293b;color:#e6eef6;font-size:14px;width:100%;}
    .modal-form button[type="submit"]{grid-column:1 / -1;background-color:var(--accent);color:var(--bg);font-weight:700;margin-top:15px}
    .modal-form button[type="submit"]:hover{background-color:#50e0a5}

    /* Recommendations & History inside Modal */
    #edit-recommendations-list { margin-top: 15px; }
    #edit-recommendations-list h4 { margin: 10px 0; font-size: 16px; color: var(--accent); }
    #recommendation-inputs-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
    .rec-input-group { display: flex; gap: 10px; align-items: center; }
    .rec-input-group input { flex-grow: 1; }
    .rec-input-group button { background-color: var(--red); color: white; padding: 5px 10px; font-size: 12px; }

    /* Notification Styling */
    #notification{position:fixed;bottom:20px;right:20px;background-color:var(--card);color:#fff;padding:15px 25px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.5);opacity:0;transition:opacity .3s, transform .3s;transform:translateY(20px);z-index:600;min-width:250px}
    #notification.show{opacity:1;transform:translateY(0)}
    #notification h4{margin-top:0;margin-bottom:5px;font-size:16px}
    #notification p{margin:0;font-size:14px}
    .notif-success{border-left:5px solid var(--green)}
    .notif-error{border-left:5px solid var(--red)}
    .notif-warning{border-left:5px solid var(--yellow)}

    /* History section style */
    .history-entry{background-color:var(--card);padding:15px;border-radius:8px;border-left:4px solid var(--accent);margin-bottom:10px}
    .history-entry strong{color:#fff;font-size:15px}
    .history-entry div{font-size:12px;color:var(--muted);margin-top:5px}

    /* Tutorial Section Styling (7. Tutorial Content) */
    .tutorial-content {
        display: grid;
        gap: 30px;
        padding-top: 20px;
    }
    .tutorial-step {
        background-color: var(--card);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid var(--glass);
    }
    .tutorial-step h3 {
        color: var(--accent);
        margin-top: 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .tutorial-step ul {
        list-style: none;
        padding-left: 0;
    }
    .tutorial-step li {
        margin-bottom: 5px;
        font-size: 14px;
        color: var(--muted);
    }
    .tutorial-step li strong {
        color: #e6eef6;
    }

    @media (max-width: 768px) {
        .nav{overflow-x:auto;padding-bottom:5px}
        .container{padding:10px}
        .stats-grid{grid-template-columns:1fr}
        .modal-content { max-width: 95%; padding: 20px; }
        .modal-form{grid-template-columns:1fr}
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, arrayUnion, arrayRemove, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // Global variables (from Canvas environment)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth, userId = null;
    let clientList = [];

    // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
    async function initializeFirebase() {
        if (!firebaseConfig.apiKey) {
            console.error("Firebase configuration is missing or invalid.");
            document.getElementById('loading').innerText = 'Error: Configuración de Firebase no disponible.';
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Set persistence to local (optional but recommended for web apps)
            await setPersistence(auth, browserLocalPersistence);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    document.getElementById('user-id-display').innerText = `ID de Usuario: ${userId}`;
                    startListeners();
                } else {
                    console.log("No user signed in.");
                    document.getElementById('loading').innerText = 'Esperando autenticación...';
                }
            });
        } catch (error) {
            console.error("Error during Firebase initialization or authentication:", error);
            document.getElementById('loading').innerText = `Error: ${error.message}`;
        }
    }

    // --- UTILITIES ---

    // Utility for custom confirmation (replacing alert/confirm)
    let confirmResolve;

    function customConfirm(title, message) {
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-message').innerText = message;
        document.getElementById('confirmation-modal').style.display = 'flex';

        return new Promise((resolve) => {
            confirmResolve = resolve;
        });
    }

    // Event listeners for the confirmation buttons
    document.getElementById('confirm-yes').addEventListener('click', () => {
        document.getElementById('confirmation-modal').style.display = 'none';
        if (confirmResolve) confirmResolve(true);
    });

    document.getElementById('confirm-no').addEventListener('click', () => {
        document.getElementById('confirmation-modal').style.display = 'none';
        if (confirmResolve) confirmResolve(false);
    });
    
    function formatDate(timestamp) {
        if (!timestamp) return '-';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    let notificationTimeout;
    function showNotification(title, message, type = 'success') {
        const notif = document.getElementById('notification');
        const notifTitle = document.getElementById('notification-title');
        const notifMessage = document.getElementById('notification-message');

        clearTimeout(notificationTimeout);

        notif.className = `notif-${type}`;
        notifTitle.innerText = title;
        notifMessage.innerText = message;
        notif.classList.add('show');

        notificationTimeout = setTimeout(() => {
            notif.classList.remove('show');
        }, 4000);
    }

    window.showSection = function(sectionId) {
        document.querySelectorAll('section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.nav-link[onclick="showSection('${sectionId}')"]`).classList.add('active');

        // Special handling for client section to reset search
        if (sectionId === 'clients-section') {
            document.getElementById('search-input').value = '';
            renderClients(clientList);
        }
    }

    window.logout = async function() {
        if (auth && auth.currentUser) {
            await auth.signOut();
            showNotification("Sesión cerrada", "Has cerrado la sesión.", 'warning');
            window.location.reload();
        }
    }

    // --- FIRESTORE COLLECTION REFERENCE ---
    function getClientsCollectionRef() {
        return collection(db, `artifacts/${appId}/users/${userId}/clientes`);
    }
    
    function getHistoryCollectionRef() {
        return collection(db, `artifacts/${appId}/users/${userId}/historial_renovaciones`);
    }

    // --- CRUD FUNCTIONS ---

    window.saveClient = async function(event) {
        event.preventDefault();
        const form = event.target;
        const clientId = form['f-client-id'].value;
        const isNew = !clientId;
        
        const recommendations = [];
        document.querySelectorAll('.rec-input-group input').forEach(input => {
            if (input.value.trim()) {
                recommendations.push(input.value.trim());
            }
        });

        const clientData = {
            nombre: form['f-nombre'].value,
            usuario: form['f-usuario'].value,
            contrasena: form['f-contrasena'].value,
            aplicacion: form['f-aplicacion'].value,
            telefono: form['f-telefono'].value,
            caducidad: new Date(form['f-caducidad'].value),
            notas: form['f-notas'].value,
            recomendaciones: recommendations,
            fecha_ultima_renovacion: isNew ? new Date() : (clientList.find(c => c.id === clientId)?.fecha_ultima_renovacion || new Date()),
        };

        try {
            if (isNew) {
                // Add creation date only for new clients
                clientData.creacion = serverTimestamp();
                await addDoc(getClientsCollectionRef(), clientData);
                showNotification("Creado", "Cliente registrado con éxito.", 'success');

                // Record creation in history
                await saveRenewalHistory(null, null, clientData.caducidad, 'Creación de Cliente', clientData.usuario, clientData);
            } else {
                // Update client
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/clientes`, clientId), clientData);
                showNotification("Guardado", "Cliente actualizado con éxito.", 'success');
            }
            document.getElementById('modal-client').style.display = 'none';
        } catch (error) {
            console.error("Error al guardar cliente:", error);
            showNotification("Error", "No se pudo guardar el cliente.", 'error');
        }
    }

    window.deleteItem = async function(id) {
        // Replace confirm() with customConfirm()
        const confirmed = await customConfirm("Confirmar Eliminación", "¿Estás seguro de que quieres eliminar este cliente? Esta acción es irreversible.");
        if (!confirmed) return;

        try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/clientes`, id));
            showNotification("Eliminado", "Cliente eliminado con éxito.", 'success');
        } catch (error) {
            console.error("Error al eliminar cliente:", error);
            showNotification("Error", "No se pudo eliminar el cliente.", 'error');
        }
    }
    
    window.renewItem = async function(id) {
        const clientData = clientList.find(c => c.id === id);
        if (!clientData) {
            showNotification("Error", "Cliente no encontrado para renovar.", 'error');
            return;
        }

        // Replace confirm() with customConfirm()
        const confirmed = await customConfirm("Confirmar Renovación", `¿Deseas renovar a ${clientData.nombre} por 30 días?`);
        if (!confirmed) return;

        try {
            const currentCaducidad = clientData.caducidad.toDate();
            const newCaducidad = new Date(currentCaducidad);
            newCaducidad.setDate(currentCaducidad.getDate() + 30);
            
            // Save history (must be before updateDoc)
            await saveRenewalHistory(id, currentCaducidad, newCaducidad, 'Renovación Manual (30 días)', clientData.usuario);

            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/clientes`, id), {
                caducidad: newCaducidad,
                fecha_ultima_renovacion: new Date(),
            });
            showNotification("Renovado", `${clientData.nombre} renovado con éxito. Nueva caducidad: ${formatDate(newCaducidad)}.`, 'success');
        } catch (error) {
            console.error("Error al renovar:", error);
            showNotification("Error", "No se pudo renovar el cliente.", 'error');
        }
    }

    // 5. Free Month Condition
    window.addFreeMonth = async function(id) {
        const clientData = clientList.find(c => c.id === id);
        if (!clientData) {
            showNotification("Error", "Cliente no encontrado.", 'error');
            return;
        }

        // CHECK CONDITION: Must have 3 or more recommendations
        if (!clientData.recomendaciones || clientData.recomendaciones.length < 3) {
            showNotification("Condición no cumplida", "Para aplicar el 'Mes Gratis', el cliente debe tener al menos 3 recomendaciones registradas.", 'warning');
            return;
        }

        const confirmed = await customConfirm("Confirmar Mes Gratis", `¿Deseas aplicar el Mes Gratis (30 días) a ${clientData.nombre}?`);
        if (!confirmed) return;

        try {
            const currentCaducidad = clientData.caducidad.toDate();
            const newCaducidad = new Date(currentCaducidad);
            newCaducidad.setDate(currentCaducidad.getDate() + 30); // Add 30 days
            
            // Save history
            await saveRenewalHistory(id, currentCaducidad, newCaducidad, 'Mes Gratis por Recomendación (30 días)', clientData.usuario);

            // Update Firestore
            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/clientes`, id), {
                caducidad: newCaducidad,
                fecha_ultima_renovacion: new Date(),
            });

            showNotification("Renovado", `Mes gratis aplicado a ${clientData.nombre}. Nueva caducidad: ${formatDate(newCaducidad)}.`, 'success');
        } catch (error) {
            console.error("Error al aplicar mes gratis:", error);
            showNotification("Error", "No se pudo aplicar el mes gratis.", 'error');
        }
    }


    window.saveRenewalHistory = async function(clientId, oldCaducidad, newCaducidad, actionType, clientUser, clientData = null) {
        try {
            const historyEntry = {
                fecha_renovacion: serverTimestamp(),
                caducidad_anterior: oldCaducidad,
                nueva_caducidad: newCaducidad,
                tipo_accion: actionType,
                cliente_id: clientId,
                usuario: clientUser,
            };

            // If it's a creation action, add full client details for reference
            if (actionType === 'Creación de Cliente' && clientData) {
                historyEntry.details = clientData;
            }

            await addDoc(getHistoryCollectionRef(), historyEntry);
        } catch (error) {
            console.error("Error al guardar historial de renovación:", error);
            // Non-blocking error, just log it.
        }
    }


    // --- MODAL FUNCTIONS ---

    window.openNewClientModal = function() {
        const modal = document.getElementById('modal-client');
        document.getElementById('f-client-id').value = '';
        document.getElementById('f-modal-title').innerText = 'Nuevo Cliente';
        document.getElementById('f-nombre').value = '';
        document.getElementById('f-usuario').value = '';
        document.getElementById('f-contrasena').value = '';
        document.getElementById('f-aplicacion').value = '';
        
        // 6. Phone Number Default Value
        document.getElementById('f-telefono').value = '+34'; 
        
        // Default caducidad to 30 days from now
        const defaultCaducidad = new Date();
        defaultCaducidad.setDate(defaultCaducidad.getDate() + 30);
        document.getElementById('f-caducidad').valueAsDate = defaultCaducidad;
        
        document.getElementById('f-notas').value = '';
        document.getElementById('edit-recommendations-list').style.display = 'none'; // Hide recs for new client
        renderRecommendationInputs([]); // Clear and render empty recs
        modal.style.display = 'flex';
        document.getElementById('client-form-submit').innerText = 'Crear Cliente';
    }

    window.openEdit = function(id) {
        const modal = document.getElementById('modal-client');
        const clientData = clientList.find(c => c.id === id);

        if (!clientData) {
            showNotification("Error", "Cliente no encontrado para edición.", 'error');
            return;
        }

        document.getElementById('f-client-id').value = id;
        document.getElementById('f-modal-title').innerText = `Editar Cliente: ${clientData.nombre}`;
        document.getElementById('f-nombre').value = clientData.nombre || '';
        document.getElementById('f-usuario').value = clientData.usuario || '';
        document.getElementById('f-contrasena').value = clientData.contrasena || '';
        document.getElementById('f-aplicacion').value = clientData.aplicacion || '';
        
        // 6. Phone Number Default Value: load existing or default to +34
        document.getElementById('f-telefono').value = clientData.telefono || '+34';

        // Set date input value
        const caducidadDate = clientData.caducidad.toDate();
        document.getElementById('f-caducidad').valueAsDate = caducidadDate;

        document.getElementById('f-notas').value = clientData.notas || '';
        document.getElementById('edit-recommendations-list').style.display = 'block';
        
        renderRecommendationInputs(clientData.recomendaciones || []);
        
        modal.style.display = 'flex';
        document.getElementById('client-form-submit').innerText = 'Guardar Cambios';
    }

    window.closeModal = function() {
        document.getElementById('modal-client').style.display = 'none';
    }

    // --- RECOMMENDATION MANAGEMENT ---

    function renderRecommendationInputs(recommendations) {
        const container = document.getElementById('recommendation-inputs-container');
        container.innerHTML = '';
        
        // Render existing recommendations
        recommendations.forEach((rec, index) => {
            const div = document.createElement('div');
            div.className = 'rec-input-group';
            div.innerHTML = `
                <input type="text" value="${rec}" placeholder="Nombre del recomendado #${index + 1}" data-index="${index}">
                <button type="button" onclick="removeRecommendationInput(this)">X</button>
            `;
            container.appendChild(div);
        });

        // Add one empty input for adding a new one
        addEmptyRecommendationInput();
    }
    
    function addEmptyRecommendationInput() {
        const container = document.getElementById('recommendation-inputs-container');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'rec-input-group new-rec';
        div.innerHTML = `
            <input type="text" value="" placeholder="Nombre del recomendado #${count}">
            <button type="button" onclick="removeRecommendationInput(this)">X</button>
        `;
        container.appendChild(div);
    }
    
    window.removeRecommendationInput = function(button) {
        const container = document.getElementById('recommendation-inputs-container');
        const inputGroup = button.closest('.rec-input-group');
        container.removeChild(inputGroup);
        // Ensure there is always an empty slot if we remove one that wasn't the last one
        if (container.children.length === 0 || !container.lastElementChild.querySelector('input').value) {
            addEmptyRecommendationInput();
        }
    }
    
    document.addEventListener('input', (e) => {
        if (e.target.closest('.rec-input-group')) {
            const container = document.getElementById('recommendation-inputs-container');
            const lastInput = container.lastElementChild.querySelector('input');
            if (e.target === lastInput && lastInput.value.trim() !== '') {
                // If the last input is filled, add a new empty one
                addEmptyRecommendationInput();
            }
        }
    });

    // --- DATA RENDERING ---

    function calculateStatus(caducidadTimestamp) {
        if (!caducidadTimestamp) return 'inactive'; // Safety check
        const today = new Date();
        const caducidadDate = caducidadTimestamp.toDate();
        const diffTime = caducidadDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) return 'inactive';
        if (diffDays <= 3) return 'expiring';
        return 'active';
    }

    // 1. Dashboard Visualization (Part 2: JS implementation)
    function renderDashboard(data) {
        document.getElementById('total-clients-value').innerText = data.totalClients;
        document.getElementById('active-clients-value').innerText = data.activeClients;
        document.getElementById('expiring-clients-value').innerText = data.expiringClients.length;
        document.getElementById('inactive-clients-value').innerText = data.inactiveClients;

        const expiringClientsContainer = document.getElementById('expiring-clients-container');
        expiringClientsContainer.innerHTML = ''; 

        if (data.expiringClients.length === 0) {
            expiringClientsContainer.innerHTML = '<p style="margin: 0; padding: 15px; color: var(--muted);">No hay clientes a punto de caducar (próximos 3 días).</p>';
            expiringClientsContainer.style.display = 'block';
            expiringClientsContainer.style.overflowX = 'hidden';
            expiringClientsContainer.style.padding = '0';
        } else {
            // Apply row style
            expiringClientsContainer.style.display = 'flex';
            expiringClientsContainer.style.overflowX = 'auto';
            expiringClientsContainer.style.padding = '5px 0';

            data.expiringClients.forEach(client => {
                const card = document.createElement('div');
                card.className = 'expiring-client-card';
                card.innerHTML = `
                    <h5>${client.nombre}</h5>
                    <div class="detail">Usuario: ${client.usuario || '-'}</div>
                    <div class="detail">App: ${client.aplicacion || '-'}</div>
                    <div class="detail">Caduca: ${formatDate(client.caducidad)}</div>
                    <div class="detail">Teléfono: ${client.telefono || '-'}</div>
                    <button class="btn btn-sm" style="margin-top: 10px; background-color: var(--yellow); color: var(--bg); font-weight: 700;" onclick="openEdit('${client.id}')">Ver/Editar</button>
                `;
                expiringClientsContainer.appendChild(card);
            });
        }
    }
    
    // 4. Client Card Colors: Color array for cycling
    const cardColors = ['card-color-1', 'card-color-2', 'card-color-3', 'card-color-4', 'card-color-5'];

    window.renderClients = function(clients) {
        const clientsGrid = document.getElementById('clients-grid');
        clientsGrid.innerHTML = '';

        if (clients.length === 0) {
            clientsGrid.innerHTML = '<p style="text-align:center; color: var(--muted); padding: 50px 0;">No se encontraron clientes.</p>';
            return;
        }

        clients.forEach((item, index) => {
            const status = calculateStatus(item.caducidad);
            const statusClass = `status-${status}`;
            const colorClass = cardColors[index % cardColors.length]; // 4. Cycle colors

            const recommendationsHTML = item.recomendaciones && item.recomendaciones.length > 0
                ? `<div class="recs-list">
                    <p>Recomendaciones (${item.recomendaciones.length}):</p>
                    <ul>
                        ${item.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>`
                : '';
                
            const whatsappBtn = item.telefono 
                ? `<button class="btn whatsapp" style="background-color: var(--whatsapp); color: white;" onclick="window.open('https://wa.me/${item.telefono.replace('+', '')}', '_blank')">WhatsApp</button>`
                : '';

            const card = document.createElement('div');
            card.className = `card ${statusClass} ${colorClass}`; // Add color class
            card.innerHTML = `
                <h4>${item.nombre}</h4>
                <div class="meta">Usuario: ${item.usuario || "-"}</div>
                <div class="meta">Teléfono: ${item.telefono || "-"}</div>
                <div class="meta">App: ${item.aplicacion || "-"}</div>
                <div class="meta">Creación: ${formatDate(item.creacion)}</div>
                <div class="meta">Caduca: <span class="${statusClass}">${formatDate(item.caducidad)}</span></div>
                ${recommendationsHTML}

                <div class="btns">
                    <button class="btn edit" onclick="openEdit('${item.id}')">Editar</button>
                    <button class="btn renew" onclick="renewItem('${item.id}')">Renovar</button>
                    <button class="btn free-month" onclick="addFreeMonth('${item.id}')">Mes gratis</button>
                    <button class="btn copy" onclick="copyPassword('${item.id}')">Copiar</button>
                    ${whatsappBtn}
                    <button class="btn delete" onclick="deleteItem('${item.id}')">Eliminar</button>
                </div>
            `;
            clientsGrid.appendChild(card);
        });
    }

    // 2. Copy Functionality
    window.copyPassword = async function(id) {
        const clientData = clientList.find(c => c.id === id);
        if (!clientData) {
            showNotification("Error", "Cliente no encontrado para copiar.", 'error');
            return;
        }

        const copyText = `
        Usuario: ${clientData.usuario || 'N/A'}
        Contraseña: ${clientData.contrasena || 'N/A'}
        Aplicación: ${clientData.aplicacion || 'N/A'}
        Fecha de caducidad: ${formatDate(clientData.caducidad)}
        `.trim().replace(/\n\s+/g, '\n'); // Clean up whitespace

        try {
            // Using document.execCommand('copy') for better compatibility in iframes
            const textarea = document.createElement('textarea');
            textarea.value = copyText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            showNotification("Copiado", "Usuario, Contraseña, Aplicación y Caducidad copiados al portapapeles.", 'success');
        } catch (err) {
            console.error('Error al copiar:', err);
            showNotification("Error al Copiar", "No se pudo copiar el texto automáticamente. Inténtalo manualmente.", 'error');
        }
    };


    window.filterClients = function() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const filteredClients = clientList.filter(client => 
            client.nombre.toLowerCase().includes(query) ||
            client.usuario.toLowerCase().includes(query) ||
            client.aplicacion.toLowerCase().includes(query) ||
            client.telefono?.toLowerCase().includes(query)
        );
        renderClients(filteredClients);
    }
    
    // --- HISTORY RENDERING ---

    function renderHistory(historyList) {
        const historyContainer = document.getElementById('history-list');
        historyContainer.innerHTML = '';
        
        if (historyList.length === 0) {
            historyContainer.innerHTML = '<p style="text-align:center; color: var(--muted); padding: 50px 0;">No se encontraron registros en el historial.</p>';
            return;
        }

        historyList
            .sort((a, b) => b.fecha_renovacion.toDate().getTime() - a.fecha_renovacion.toDate().getTime()) // Sort by date desc
            .forEach(rec => {
            const actionType = rec.tipo_accion || 'Renovación Manual';
            let color;
            if (actionType.includes('Gratis')) {
                color = 'var(--yellow)';
            } else if (actionType.includes('Creación')) {
                color = 'var(--green)';
            } else {
                color = 'var(--accent)';
            }
            
            const clientInfo = rec.cliente_id 
                ? `ID Cliente: ${rec.cliente_id}` 
                : (rec.details?.nombre ? `Cliente: ${rec.details.nombre}` : 'Cliente Desconocido');

            const entry = document.createElement('div');
            entry.className = 'history-entry';
            entry.style.borderLeftColor = color;
            entry.innerHTML = `
                <strong>${actionType}</strong> - ${rec.usuario || 'N/A'}
                <div style="font-size: 13px;">
                    ${clientInfo} <br/>
                    Fecha de Acción: ${formatDate(rec.fecha_renovacion)}<br/>
                    ${rec.caducidad_anterior ? `Caducidad Anterior: ${formatDate(rec.caducidad_anterior)}<br/>` : ''}
                    Nueva Caducidad: ${formatDate(rec.nueva_caducidad)}
                </div>
            `;
            historyContainer.appendChild(entry);
        });
    }

    // --- FIRESTORE LISTENERS ---

    function startListeners() {
        // Clients Listener
        onSnapshot(query(getClientsCollectionRef()), (snapshot) => {
            const today = new Date();
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(today.getDate() + 3);

            let totalClients = 0;
            let activeClients = 0;
            let inactiveClients = 0;
            let expiringClients = [];
            clientList = []; // Reset global list

            snapshot.docs.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                clientList.push(data);
                
                totalClients++;
                const status = calculateStatus(data.caducidad);
                if (status === 'active') activeClients++;
                if (status === 'inactive') inactiveClients++;
                if (status === 'expiring') expiringClients.push(data);
            });

            const dashboardData = { totalClients, activeClients, inactiveClients, expiringClients };
            renderDashboard(dashboardData);
            
            // Only render clients if we are on the clients section
            if (!document.getElementById('clients-section').classList.contains('hidden')) {
                renderClients(clientList);
            }
        });
        
        // History Listener
        onSnapshot(query(getHistoryCollectionRef()), (snapshot) => {
            const historyList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Only render history if we are on the history section
            if (!document.getElementById('history-section').classList.contains('hidden')) {
                renderHistory(historyList);
            }
        });
    }

    // --- START APP ---
    initializeFirebase();

  </script>
</head>
<body>

  <div id="loading" style="text-align:center; padding:50px; color:var(--accent);">Cargando aplicación y autenticando...</div>

  <div id="main-content" style="display:none;">
    <div class="container">
      <header>
        <h1>Gestor de Clientes</h1>
        <div class="nav">
          <button class="btn nav-link active" onclick="showSection('dashboard-section')">Dashboard</button>
          <button class="btn nav-link" onclick="showSection('clients-section')">Clientes</button>
          <button class="btn nav-link" onclick="showSection('new-client-section')">Nuevo Cliente</button>
          <!-- 7. New Tutorial Button -->
          <button class="btn nav-link" onclick="showSection('tutorial-section')">Tutorial</button>
          <button class="btn nav-link" onclick="showSection('history-section')">Historial</button>
          <button class="btn nav-link" onclick="logout()">Salir</button>
        </div>
      </header>
      
      <p id="user-id-display" style="font-size:12px; color:var(--muted); margin-bottom: 20px;"></p>

      <!-- DASHBOARD SECTION -->
      <section id="dashboard-section" class="container">
        <h2>Dashboard</h2>
        <div class="stats-grid">
          <div class="stat" style="border-left-color: var(--accent);">
            <div class="stat-title">Total Clientes</div>
            <div class="stat-value" id="total-clients-value">0</div>
          </div>
          <div class="stat" style="border-left-color: var(--green);">
            <div class="stat-title">Clientes Activos</div>
            <div class="stat-value" id="active-clients-value">0</div>
          </div>
          <div class="stat" style="border-left-color: var(--yellow);">
            <div class="stat-title">Clientes por Caducar (3 días)</div>
            <div class="stat-value" id="expiring-clients-value">0</div>
          </div>
          <div class="stat" style="border-left-color: var(--red);">
            <div class="stat-title">Clientes Inactivos</div>
            <div class="stat-value" id="inactive-clients-value">0</div>
          </div>
        </div>
        
        <!-- 1. Unique Visualization for Expiring Clients -->
        <div class="expiring-clients-box">
            <h3>Clientes a punto de Caducar</h3>
            <div id="expiring-clients-container">
                <!-- Clients expiring in 3 days will be rendered here in a row -->
            </div>
        </div>
      </section>

      <!-- CLIENTS SECTION -->
      <section id="clients-section" class="hidden container">
        <h2>Gestión de Clientes</h2>
        <input type="text" id="search-input" oninput="filterClients()" placeholder="Buscar por nombre, usuario, app o teléfono..." style="padding:10px; border-radius:8px; border:1px solid var(--glass); background-color:#1e293b; color:#e6eef6; width:100%; margin-bottom:20px;">
        <div class="clients-grid" id="clients-grid">
          <!-- Clients cards will be rendered here -->
        </div>
      </section>

      <!-- NEW CLIENT SECTION -->
      <section id="new-client-section" class="hidden container">
        <h2>Registrar Nuevo Cliente</h2>
        <form id="new-client-form" class="modal-form" onsubmit="saveClient(event)" style="grid-template-columns: 1fr;">
            <input type="hidden" id="f-client-id" name="f-client-id">
            
            <div class="form-group">
                <label for="f-nombre">Nombre Completo</label>
                <input type="text" id="f-nombre" required>
            </div>

            <div class="form-group">
                <label for="f-usuario">Usuario</label>
                <input type="text" id="f-usuario" required>
            </div>

            <div class="form-group">
                <label for="f-contrasena">Contraseña</label>
                <input type="text" id="f-contrasena" required>
            </div>

            <div class="form-group">
                <label for="f-aplicacion">Aplicación</label>
                <input type="text" id="f-aplicacion" required>
            </div>

            <div class="form-group">
                <label for="f-telefono">Teléfono (WhatsApp)</label>
                <!-- 6. Phone Number Default Value: Added value="+34" -->
                <input type="text" id="f-telefono" value="+34" required>
            </div>

            <div class="form-group">
                <label for="f-caducidad">Fecha de Caducidad</label>
                <input type="date" id="f-caducidad" required>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="f-notas">Notas Adicionales</label>
                <textarea id="f-notas" rows="3"></textarea>
            </div>

            <button type="submit" class="btn" id="client-form-submit">Crear Cliente</button>
        </form>
      </section>
      
      <!-- HISTORY SECTION -->
      <section id="history-section" class="hidden container">
        <h2>Historial de Renovaciones y Acciones</h2>
        <div id="history-list">
            <!-- History entries will be rendered here -->
        </div>
      </section>

      <!-- 7. TUTORIAL SECTION -->
      <section id="tutorial-section" class="hidden container">
        <h2>Guía de Uso del Gestor de Clientes</h2>
        <p class="description" style="color: var(--accent); font-size: 1.1em;">Bienvenido al tutorial. Aquí aprenderás a usar todas las funciones de esta aplicación.</p>

        <div class="tutorial-content">
            <div class="tutorial-step">
                <h3>1. El Dashboard</h3>
                <p>El Dashboard es tu vista principal. Muestra estadísticas clave: clientes totales, activos, inactivos y la lista de clientes que están a punto de caducar (en los próximos 3 días).</p>
                <p>La sección de clientes por caducar utiliza una <strong>visualización especial en fila horizontal (scrollable)</strong> con un color llamativo para que puedas acceder a la información más urgente de un vistazo.</p>
            </div>
            <div class="tutorial-step">
                <h3>2. Gestión de Clientes</h3>
                <p>En la pestaña "Clientes" puedes ver la lista completa. Las tarjetas tienen <strong>colores rotativos</strong> para mejorar la distinción. Cada tarjeta tiene botones de acción rápida:</p>
                <ul>
                    <li><strong>Editar:</strong> Abre el formulario de edición. La ventana de edición ha sido ajustada para ser <strong>completamente visible y responsive</strong> en cualquier dispositivo.</li>
                    <li><strong>Renovar:</strong> Extiende la caducidad 30 días.</li>
                    <li><strong>Mes gratis:</strong> Añade 30 días extra, **solo si el cliente tiene 3 o más recomendaciones registradas.**</li>
                    <li><strong>Copiar:</strong> Copia la información esencial del cliente (Usuario, Contraseña, Aplicación, Caducidad) al portapapeles.</li>
                    <li><strong>WhatsApp:</strong> Abre un chat directo con el cliente.</li>
                    <li><strong>Eliminar:</strong> Borra el registro del cliente (requiere confirmación).</li>
                </ul>
            </div>
            <div class="tutorial-step">
                <h3>3. Nuevo Cliente</h3>
                <p>Usa esta pestaña para registrar nuevos clientes. Recuerda que el campo "Teléfono" ya viene pre-escrito con <strong>+34</strong> por defecto.</p>
            </div>
            <div class="tutorial-step">
                <h3>4. Historial</h3>
                <p>Revisa todas las renovaciones, creaciones y acciones especiales (como "Mes Gratis") realizadas en la aplicación, con un registro detallado de los cambios de caducidad.</p>
            </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Client/Edit Modal -->
  <div id="modal-client" class="modal">
    <!-- 3. Edit Modal Responsiveness: CSS improvements applied to .modal-content -->
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h3 id="f-modal-title">Nuevo Cliente</h3>
      
      <form id="client-form" onsubmit="saveClient(event)">
        <input type="hidden" id="f-client-id" name="f-client-id">
        
        <div class="modal-form">
            <div class="form-group">
                <label for="f-nombre">Nombre Completo</label>
                <input type="text" id="f-nombre" required>
            </div>

            <div class="form-group">
                <label for="f-usuario">Usuario</label>
                <input type="text" id="f-usuario" required>
            </div>

            <div class="form-group">
                <label for="f-contrasena">Contraseña</label>
                <input type="text" id="f-contrasena" required>
            </div>

            <div class="form-group">
                <label for="f-aplicacion">Aplicación</label>
                <input type="text" id="f-aplicacion" required>
            </div>

            <div class="form-group">
                <label for="f-telefono">Teléfono (WhatsApp)</label>
                <!-- 6. Phone Number Default Value: Load from JS/HTML attribute -->
                <input type="text" id="f-telefono" value="+34" required>
            </div>

            <div class="form-group">
                <label for="f-caducidad">Fecha de Caducidad</label>
                <input type="date" id="f-caducidad" required>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="f-notas">Notas Adicionales</label>
                <textarea id="f-notas" rows="3"></textarea>
            </div>
        </div>
        
        <div id="edit-recommendations-list" style="margin-top: 25px; border-top: 1px solid var(--glass); padding-top: 15px;">
            <h4>Clientes Recomendados</h4>
            <div id="recommendation-inputs-container">
                <!-- Recommendation inputs will be rendered here -->
            </div>
        </div>

        <button type="submit" class="btn" id="client-form-submit" style="grid-column: 1 / -1; margin-top: 25px;">Guardar Cambios</button>
      </form>
    </div>
  </div>
  
  <!-- Custom Confirmation Modal (Mandatory Replacement for confirm()) -->
  <div id="confirmation-modal" class="modal" style="z-index: 1000; background-color: rgba(0, 0, 0, 0.7);">
      <div class="modal-content" style="max-width: 400px; text-align: center; max-height: 90vh;">
          <h3 id="confirm-title" style="color: var(--red);">Confirmación</h3>
          <p id="confirm-message" style="margin-bottom: 25px; color: #fff;">¿Estás seguro de que quieres proceder?</p>
          <button id="confirm-yes" class="btn" style="background-color: var(--red); margin-right: 10px; color: white;">Sí, estoy seguro</button>
          <button id="confirm-no" class="btn" style="background-color: var(--muted); color: white;">Cancelar</button>
      </div>
  </div>

  <!-- Notification Message -->
  <div id="notification">
    <h4 id="notification-title"></h4>
    <p id="notification-message"></p>
  </div>
</body>
</html>
